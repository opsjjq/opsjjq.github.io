# web负载均衡架构

> 本文档仅包含各机器上直接执行的脚本/命令，不含 Ansible 剧本。

---

## 0. 公钥分发与免密登录（master61）

```sh
mkdir /my_sh && cd /my_sh
cat >01nologin.sh <<'EOF'
#!/bin/bash
echo "正在创建公私钥..."
if [ -f /root/.ssh/id_rsa ]
then
  echo "密钥对已经存在,请检查！"
else
  ssh-keygen -f /root/.ssh/id_rsa -N '' > /tmp/create_ssh.log 2>&1
fi

echo "正在分发公钥中...分发的机器列表是同网段下的{5,6,7,8,31,41,51}机器"
for ip in {5,6,7,8,31,41,51}
do
  sshpass -p 'qwe' ssh-copy-id 172.16.1.${ip} -o StrictHostKeyChecking=no > /tmp/create_ssh.log 2>&1
  echo "正在验证免密登录结果中...."
  echo "远程获取到主机名: $(ssh 172.16.1.${ip} hostname)"
done
EOF
```

---

## 1. 部署 61 机器本地 yum 仓库

```sh
mkdir /opt/yumrpm/
# 在文件夹内准备好 rpm 文件
yum install createrepo -y
createrepo /opt/yumrpm/

cat > /etc/yum.repos.d/local.repo <<EOF
[local61]
name=Local YUM Repository on 61
baseurl=file:///opt/yumrpm
gpgcheck=0
enabled=1
EOF

yum install nginx -y
systemctl start nginx
systemctl enable nginx

cat > /etc/nginx/conf.d/rpm.conf <<'EOF'
server {
    listen 12345;
    server_name _;
    root /opt/yumrpm/;
    autoindex on;
    autoindex_exact_size off;
    autoindex_localtime on;
    charset utf-8;
    include /etc/nginx/mime.types;
}
EOF

systemctl restart nginx
```

---

## 2. 配置 NTP 时间同步（61）

```sh
yum install ntp -y
sed -i '/server 0.centos.pool.ntp.org iburst/i server ntp.aliyun.com iburst prefer\nserver cp.pool.ntp.org iburst' /etc/ntp.conf
systemctl start ntpd
systemctl enable ntpd
```

---

## 3. 脚本命令（按角色）

### db51 — MySQL

```sh
yum -y localinstall http://mirrors.ustc.edu.cn/mysql-repo/mysql57-community-release-el7.rpm
sed -i '/gpgcheck=1/c gpgcheck=0' /etc/yum.repos.d/mysql-community*
yum install -y mysql-community-server

sed -i "s@--initialize @--initialize-insecure @g" /usr/bin/mysqld_pre_systemd

systemctl enable mysqld
systemctl start mysqld

mysql -e "create database wordpress default charset 'utf8';"
mysql -e "set global validate_password_policy=LOW;"
mysql -e "create user 'wang'@'%' identified by 'qwe123123';"
mysql -e "grant all on wordpress.* to 'wang'@'%';"
mysql -e "flush privileges;"
```

### db51 — Redis（jumpserver 用）

```bash
yum -y install epel-release wget make gcc-c++
cd /opt ; wget https://download.redis.io/releases/redis-6.2.4.tar.gz
tar -xf redis-6.2.4.tar.gz
cd redis-6.2.4
make && make install PREFIX=/usr/local/redis

echo 'export PATH=$PATH:/usr/local/redis/bin/' >> /etc/profile
source /etc/profile

cp /opt/redis-6.2.4/redis.conf /etc/redis.conf
sed -i "s/bind 127.0.0.1/bind 0.0.0.0/g" /etc/redis.conf
sed -i "s/daemonize no/daemonize yes/g" /etc/redis.conf
sed -i "561i maxmemory-policy allkeys-lru" /etc/redis.conf
sed -i "481i requirepass qwe123123" /etc/redis.conf

cat >/etc/systemd/system/redis.service <<EOF
[Unit]
Description=Redis persistent key-value database
After=network.target
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
PIDFile=/var/run/redis_6379.pid
ExecStart=/usr/local/redis/bin/redis-server /etc/redis.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID

[Install]
WantedBy=multi-user.target
EOF
systemctl enable redis
systemctl start redis
```

---

### rsync41

```sh
yum install rsync -y

cat > /etc/rsyncd.conf <<EOF
uid = www
gid = www
port = 873
fake super = yes
use chroot = no
max connections = 200
timeout = 600
ignore errors
read only = false
list = false
auth users = rsync_backup
secrets file = /etc/rsync.passwd
log file = /var/log/rsyncd.log

[backup]
comment = backup directionary
path = /backup
EOF

useradd -u 1000 -M -s /sbin/nologin www
mkdir -p /backup
chown -R www.www /backup
touch /etc/rsync.passwd
chmod 600 /etc/rsync.passwd
echo "rsync_backup:qwe123" > /etc/rsync.passwd
systemctl restart rsyncd
```

---

### nfs31

```sh
yum install nfs-utils rpcbind -y
mkdir /nfs-data
useradd www -u 1500 -M -s /sbin/nologin
chown -R www.www /nfs-data/

cat > /etc/exports <<EOF
/nfs-data 172.16.1.0/24(rw,sync,all_squash,anonuid=1500,anongid=1500)
EOF

systemctl enable --now rpcbind.service
systemctl enable --now rpcbind.socket
systemctl enable --now nfs

# 实时同步到 rsync41
yum install lsyncd -y
cat >/etc/lsyncd.conf <<EOF
settings {
    logfile      = "/var/log/lsyncd/lsyncd.log",
    statusFile   = "/var/log/lsyncd/lsyncd.status",
    inotifyMode  = "CloseWrite",
    maxProcesses = 8,
}

sync {
    default.rsync,
    source    = "/nfs-data",
    target    = "rsync_backup@172.16.1.41::backup",
    delete    = true,
    exclude   = {".*"},
    delay     = 1,
    rsync     = {
        binary        = "/usr/bin/rsync",
        archive       = true,
        compress      = true,
        verbose       = true,
        password_file = "/etc/rsync.pwd",
        _extra        = {"--bwlimit=200"}
    }
}
EOF

echo 'qwe123' > /etc/rsync.pwd
chmod 600 /etc/rsync.pwd
systemctl start lsyncd
systemctl enable lsyncd
```

### 测试挂载 NFS（如 db51）

```sh
mkdir /test-nfs
mount -t nfs 172.16.1.31:/nfs-data /test-nfs
df -h
```

---

### web（172.16.1.7/8）

```sh
cat > /etc/yum.repos.d/61.repo << 'EOF'
[local61]
name=Local YUM Repository on 61
baseurl=http://172.16.1.61:12345
gpgcheck=0
enabled=1
EOF

groupadd www -g 666
useradd www -s /sbin/nologin -M -u 666 -g 666
yum install nginx -y
systemctl start nginx
systemctl enable nginx

yum install -y php71w-cli php71w-common php71w-devel php71w-embedded php71w-gd php71w-mcrypt php71w-mbstring php71w-pdo php71w-xml php71w-fpm php71w-mysqlnd php71w-opcache php71w-pecl-memcached php71w-pecl-redis php71w-pecl-mongodb php71w-json php71w-pecl-apcu php71w-pecl-apcu-devel

sed -i '/^user/c user = www' /etc/php-fpm.d/www.conf
sed -i '/^group/c group = www' /etc/php-fpm.d/www.conf
systemctl start php-fpm
systemctl enable php-fpm

cat > /etc/nginx/conf.d/wordpress.conf << 'EOF'
server{
    listen 80;
    server_name wordpress.qwe.cn;
    root /code/wordpress;
    index index.php index.html;
    location ~ \.php$ {
        root /code/wordpress;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_param HTTPS on;
    }
}
EOF

mkdir -p /code
# 将 wordpress-5.8.2-zh_CN.tar.gz 放到 /tmp 后执行：
# tar -xzvf /tmp/wordpress-5.8.2-zh_CN.tar.gz -C /code
chown -R www.www /code/wordpress
nginx -s reload

# wp-config.php、NFS 挂载等见完整文档
```

---

### slb5

```sh
cat > /etc/yum.repos.d/61.repo <<EOF
[local-rpm]
name=local yum repo
baseurl=http://172.16.1.61:12345
enabled=1
gpgcheck=0
EOF

yum install nginx keepalived -y
systemctl start nginx
systemctl enable nginx

cat > /etc/keepalived/check_web.sh << 'EOF'
#!/bin/bash
NGINX_STATUS=$(ps -ef|grep ngin[x]|wc -l)
if [ ${NGINX_STATUS} == 0 ]; then
   systemctl restart nginx
   [ $? -eq 1 ] && systemctl stop keepalived
fi
EOF
chmod +x /etc/keepalived/check_web.sh

cat > /etc/keepalived/keepalived.conf << 'EOF'
global_defs { router_id lb-5; }
vrrp_script check_web {
    script "/etc/keepalived/check_web.sh"
    interval 5
}
vrrp_instance VIP_1 {
    state MASTER
    interface eth0
    virtual_router_id 50
    priority 150
    advert_int 1
    authentication { auth_type PASS; auth_pass 1111; }
    virtual_ipaddress { 10.0.0.3; }
    track_script { check_web; }
}
EOF
systemctl start keepalived

# 证书并拷贝到 slb6
openssl req -x509 -sha256 -nodes -days 36500 -newkey rsa:2048 \
  -keyout /tmp/server.key -out /tmp/server.crt \
  -subj "/C=CN/ST=Beijing/L=Beijing/O=MyCompany/CN=slb5"
  
sshpass -p "qwe" scp -o StrictHostKeyChecking=no /tmp/server.key /tmp/server.crt root@172.16.1.6:/tmp/

# nginx 80/443 与 proxy_params
cat > /etc/nginx/conf.d/ssl.conf << 'EOF'
server {
    listen 80;
    server_name wordpress.qwe.cn;
    return 301 https://$server_name$request_uri;
}
upstream myweb {
    server 172.16.1.7:80;
    server 172.16.1.8:80;
}
server {
    listen 443 ssl;
    server_name wordpress.qwe.cn;
    ssl_certificate /tmp/server.crt;
    ssl_certificate_key /tmp/server.key;
    location / {
        proxy_pass http://myweb;
        include proxy_params;
    }
}
EOF

cat > /etc/nginx/proxy_params << 'EOF'
proxy_set_header Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_connect_timeout 30;
proxy_send_timeout 60;
proxy_read_timeout 60;
proxy_buffering on;
proxy_buffer_size 32k;
proxy_buffers 4 128k;
EOF

systemctl reload nginx
```

---

### slb6

需先完成 slb5 的证书生成并执行 scp 到本机（172.16.1.6），证书位于 `/tmp/server.crt`、`/tmp/server.key`。

```sh
cat > /etc/yum.repos.d/61.repo <<EOF
[local-rpm]
name=local yum repo
baseurl=http://172.16.1.61:12345
enabled=1
gpgcheck=0
EOF

yum clean all
yum install nginx -y
systemctl start nginx
systemctl enable nginx

yum install keepalived -y

cat > /etc/keepalived/check_vip.sh << 'EOF'
#!/bin/bash
MASTER_VIP=$(ssh 10.0.0.5 ip a|grep 10.0.0.3|wc -l)
MY_VIP=$(ip a|grep 10.0.0.3|wc -l)
if [ ${MASTER_VIP} == 1 -a ${MY_VIP} == 1 ]; then
   systemctl stop keepalived
fi
EOF
chmod +x /etc/keepalived/check_vip.sh

# 6 对 10.0.0.5 免密，check_vip.sh 才能执行
ssh-keygen -t rsa -N '' -f ~/.ssh/id_rsa
yum install sshpass -y
sshpass -p "qwe" ssh-copy-id -o StrictHostKeyChecking=no root@10.0.0.5

cat > /etc/keepalived/keepalived.conf << 'EOF'
global_defs {
    router_id lb-6
}
vrrp_script check_vip {
    script "/etc/keepalived/check_vip.sh"
    interval 5
}
vrrp_instance VIP_1 {
    state BACKUP
    interface eth0
    virtual_router_id 50
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        10.0.0.3
    }
    track_script {
        check_vip
    }
}
EOF

systemctl start keepalived

# nginx 80/443 与 proxy_params（与 slb5 相同，证书已在 /tmp/）
cat > /etc/nginx/conf.d/ssl.conf << 'EOF'
server {
    listen 80;
    server_name wordpress.qwe.cn;
    return 301 https://$server_name$request_uri;
}
upstream myweb {
    server 172.16.1.7:80;
    server 172.16.1.8:80;
}
server {
    listen 443 ssl;
    server_name wordpress.qwe.cn;
    ssl_certificate /tmp/server.crt;
    ssl_certificate_key /tmp/server.key;
    location / {
        proxy_pass http://myweb;
        include proxy_params;
    }
}
EOF

cat > /etc/nginx/proxy_params << 'EOF'
proxy_set_header Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_connect_timeout 30;
proxy_send_timeout 60;
proxy_read_timeout 60;
proxy_buffering on;
proxy_buffer_size 32k;
proxy_buffers 4 128k;
EOF

systemctl reload nginx
```

---

## 访问与 DNS

- 用户访问：`https://wordpress.qwe.cn`
- DNS 将 **wordpress.qwe.cn** 解析到 **10.0.0.3**（Keepalived VIP）即可。
