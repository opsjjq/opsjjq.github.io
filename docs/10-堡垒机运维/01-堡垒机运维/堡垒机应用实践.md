# 堡垒机实践指南

---

## 一、用户管理与权限控制

### 1.1 修改登录密码

- **首次登录**：系统会强制修改初始密码
- **后续修改**：
  ```
  个人信息 → 登录密码设置 → 修改密码
  ```

### 1.2 用户角色说明

| 角色         | 权限范围                 | 示例用户 |
| :----------- | :----------------------- | :------- |
| **管理员**   | 最高权限，管理所有资产   | admin    |
| **普通用户** | 受限权限，仅查看授权资产 | usr163   |

---

## 二、系统配置

### 2.1 站点URL设置

```
系统设置 → 站点设置
配置访问地址：http://10.0.0.61
```

### 2.2 邮件功能配置

```
系统设置 → 邮件设置
配置SMTP服务器信息：
- 发件人邮箱（如：yc_uuu@163.com）
- SMTP服务器地址
- 邮箱授权码（非登录密码）
```

---

## 三、用户与资产管理

### 3.1 两种用户类型

| 类型                   | 用途                  |
| :--------------------- | :-------------------- |
| **堡垒机平台用户**     | 登录Web界面或koko服务 |
| **目标服务器系统用户** | Linux服务器实际账户   |

**系统用户分类**：
- root 超级用户
- sudo 特权用户（如 pp01）
- 普通用户（如 nn01）

### 3.2 连接方式区分

| 端口 | 服务   | 使用用户类型     |
| :--- | :----- | :--------------- |
| 2222 | koko   | 堡垒机平台用户   |
| 22   | SSH    | 目标服务器系统用户 |

---

## 四、资产创建与管理

### 4.1 添加服务器资产

```
资产管理 → 资产列表
步骤：
1. 创建资产组（如：database、web）
2. 添加具体服务器（如：db-51、web-7）
3. 配置连接信息（IP地址、协议等）
```

### 4.2 配置系统用户

```
资产管理 → 系统用户
创建两种类型用户：
1. 特权用户（pp01）
   - 在目标服务器上需配置sudo权限
   - visudo添加：pp01 ALL=(ALL) NOPASSWD: ALL

2. 普通用户（nn01）
   - 无特殊权限的系统用户
```

### 4.3 资产绑定用户

- 为每个资产绑定管理用户（特权用户）
- 使用 pp01 作为特权用户通过 Ansible 进行远程管理
- 配置完成后测试连接：

```bash
ansible db-51 -m ping
ansible db-51 -m setup
```

---

## 五、资产授权规则

### 5.1 创建授权规则

```
权限管理 → 资产授权
创建规则包含：
1. 规则名称
2. 用户/用户组
3. 资产/资产节点
4. 系统用户（登录目标服务器用）
```

### 5.2 授权案例演示

**案例1：管理员全权限**

| 配置项   | 值              |
| :------- | :-------------- |
| 用户     | ops01（管理员） |
| 系统用户 | pp01（特权用户） |
| 资产     | 所有服务器      |

**案例2：普通用户受限权限**

| 配置项   | 值                  |
| :------- | :------------------ |
| 用户     | usr163（普通用户）  |
| 系统用户 | nn01（普通用户）    |
| 资产     | 仅 db-51、db-52     |

### 5.3 用户组管理

1. 创建用户组（如：usr 组）
2. 将用户分配到对应组
3. 基于用户组进行批量授权

---

## 六、会话监控与审计

### 6.1 实时监控功能

- **会话管理**：查看当前在线会话
- **会话监控**：实时查看用户操作
- **强制下线**：中断异常或违规会话

### 6.2 审计记录功能

| 功能         | 说明                 |
| :----------- | :------------------- |
| **视频回放** | 完整记录操作过程     |
| **命令历史** | 记录所有执行命令     |
| **会话日志** | 保存连接和操作日志   |

---

## 七、koko跳板机使用

### 7.1 连接方式

```bash
ssh 用户名@10.0.0.61 -p 2222
```

### 7.2 工作原理

- 所有 SSH 请求通过 koko 服务转发
- koko 记录所有操作并同步到 core 服务
- 实现统一的访问控制和审计

---

## 八、实践作业要求

### 8.1 部署任务

1. 完成堡垒机完整部署
2. 确保服务能正常重启
3. 掌握前后端分离部署流程

### 8.2 功能演示

1. 用户创建与管理
2. 资产添加与配置
3. 授权规则设置
4. 会话监控与审计

### 8.3 重点难点

- 用户角色与权限理解
- 资产与用户的绑定关系
- 授权规则的配置逻辑
- 实际应用场景的配置

---

## 九、安全注意事项

1. **密码管理**
   - 初始密码必须修改
   - 定期更新密码
   - 避免使用弱密码

2. **权限分配原则**
   - 最小权限原则
   - 按需分配权限
   - 定期审核权限

3. **审计要求**
   - 所有操作必须可追溯
   - 定期审查操作日志
   - 异常行为及时处理

---

## 十、故障排查要点

| 问题类型 | 排查方法                       |
| :------- | :----------------------------- |
| **连接问题** | 检查网络连通性、验证端口开放情况 |
| **权限问题** | 检查授权规则、验证系统用户配置   |
| **功能异常** | 检查服务状态、查看系统日志       |
