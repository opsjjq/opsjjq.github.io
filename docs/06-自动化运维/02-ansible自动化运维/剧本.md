## 一、Ansible 三种工作模式对比

| 模式                  | 特点                   | 适用场景             |
| :-------------------- | :--------------------- | :------------------- |
| **SSH + Shell脚本**   | 原始方式，直接执行命令 | 简单任务，少量主机   |
| **Ad-hoc 命令模式**   | 临时命令，单次执行     | 快速检查、简单操作   |
| **Playbook 剧本模式** | YAML格式，可重复执行   | 复杂部署、自动化运维 |

---

## 二、Ansible Playbook 核心概念

### 2.1 Playbook 是什么

- **剧本** = Ansible模块 + YAML语法
- 可重复执行的自动化脚本
- 用于复杂服务的部署和配置

### 2.2 实际工作中的应用

- 维护公司现有剧本
- 修改参数：文件路径、服务端口等
- 理解剧本逻辑进行二次开发

---

## 三、YAML 语法基础

### 3.1 YAML 支持三种数据类型

#### 1. **字典 (Dictionary/Mapping)**

```yaml
# 键值对格式，冒号后必须有空格
key: value
name: "nginx"
owner: root
mode: "0644"

# 嵌套字典
server:
  name: web01
  ip: 172.16.1.7
  ports:
    http: 80
    https: 443
```

#### 2. **列表 (List/Sequence)**

```yaml
# 以短横线开头表示列表项
- item1
- item2
- item3

# 列表中的字典
packages:
  - name: nginx
    version: 1.20
  - name: mysql
    version: 5.7

# 注意事项：
# 多个短横线（同一缩进）→ 列表的多个元素
# 一个短横线（后面换行缩进）→ 多行字符串
```

#### 3. **纯量 (Scalars)**

- 字符串：`"hello world"` 或 `hello world`
- 布尔值：`true` / `false` 或 `yes` / `no`
- 整数：`42`
- 浮点数：`3.14`
- Null：`null` 或 `~`
- 时间：`2022-05-09 10:30:00`
- 日期：`2022-05-09`

### 3.2 YAML 语法规则

1. **缩进**：使用空格（通常2个），**不能用Tab**
2. **注释**：以 `#` 开头
3. **多行字符串**：使用 `|`（保留换行）或 `>`（折叠为单行）
4. **引用**：使用 `&` 定义锚点，`*` 引用锚点

---

## 四、Ansible Playbook 结构

### 4.1 基本结构

```yaml
---
# Playbook 以三个短横线开头（可选）
- name: Play的名称（描述）
  hosts: 目标主机或主机组
  vars:  # 定义变量
    variable_name: value
  tasks:  # 任务列表
    - name: 任务1描述
      module_name:
        parameter1: value1
        parameter2: value2
    
    - name: 任务2描述
      module_name: parameter1=value1 parameter2=value2
```

### 4.2 hosts 的多种写法

```yaml
# 方式1：单个IP
- hosts: 172.16.1.7

# 方式2：主机名
- hosts: web01

# 方式3：多个主机
- hosts: 172.16.1.7,172.16.1.8,nfs

# 方式4：主机组
- hosts: web

# 方式5：所有主机
- hosts: all

# 方式6：多个主机组
- hosts: web:backup

# 方式7：排除某些主机
- hosts: 'web:!172.16.1.7'
```

### 4.3 任务（Tasks）的两种写法

#### 写法1：字典风格（推荐）

```yaml
- name: 安装nginx
  yum:
    name: nginx
    state: installed

- name: 启动nginx
  systemd:
    name: nginx
    state: started
    enabled: yes
```

#### 写法2：变量风格

```yaml
- name: 安装nginx
  yum: name=nginx state=installed
  
- name: 启动nginx
  systemd: name=nginx state=started enabled=yes
```

---

## 五、JSON 与 YAML

### 5.1 JSON 基础语法

```json
{
  "key": "value",
  "number": 42,
  "boolean": true,
  "null_value": null,
  "array": ["item1", "item2", "item3"],
  "nested_object": {
    "inner_key": "inner_value"
  }
}
```

### 5.2 JSON ⇄ YAML 转换

```yaml
# JSON
{"name": "nginx", "ports": [80, 443]}

# 对应的 YAML
name: nginx
ports:
  - 80
  - 443
```

---

## 六、jq 命令处理 JSON

### 6.1 安装 jq

```bash
yum install jq -y
```

### 6.2 常用 jq 操作

#### 1. 格式化 JSON

```bash
echo '{"name":"nginx","port":80}' | jq
```

#### 2. 提取单个值

```bash
# 提取 name
echo '{"name":"nginx","port":80}' | jq '.name'
# 输出: "nginx"

# 提取 port
echo '{"name":"nginx","port":80}' | jq '.port'
# 输出: 80
```

#### 3. 提取多个值

```bash
echo '{"name":"nginx","port":80}' | jq '.name, .port'
```

#### 4. 处理嵌套结构

```bash
# 原始数据
data='{
  "server": {
    "name": "web01",
    "config": {
      "port": 80,
      "host": "localhost"
    }
  }
}'

# 提取嵌套值
echo "$data" | jq '.server.name'
echo "$data" | jq '.server.config.port'
```

#### 5. 处理数组

```bash
# 提取数组元素
echo '[{"name":"a"},{"name":"b"},{"name":"c"}]' | jq '.[0]'
echo '[{"name":"a"},{"name":"b"},{"name":"c"}]' | jq '.[].name'
echo '[{"name":"a"},{"name":"b"},{"name":"c"}]' | jq '.[1:3]'  # 切片
```

#### 6. 条件筛选

```bash
# 筛选特定条件的元素
echo '[{"name":"a","age":20},{"name":"b","age":25}]' | jq '.[] | select(.age > 20)'
```

### 6.3 实际应用示例

```bash
# 1. 提取 Ansible 输出的特定信息
ansible web -m setup | jq '.ansible_facts.ansible_default_ipv4.address'

# 2. 处理 API 返回的 JSON
curl -s https://api.example.com/data | jq '.results[].name'

# 3. 提取并格式化信息
cat data.json | jq -r '.[] | "\(.name): \(.age)"'
```

---

## 七、Ansible Playbook 实战示例

### 7.1 安装 Nginx 剧本

```yaml
---
- name: 安装和配置 Nginx
  hosts: web
  tasks:
    - name: 安装 Nginx 软件包
      yum:
        name: nginx
        state: present
    
    - name: 复制 Nginx 配置文件
      copy:
        src: /etc/ansible/files/nginx.conf
        dest: /etc/nginx/nginx.conf
        owner: root
        group: root
        mode: "0644"
    
    - name: 启动 Nginx 服务
      systemd:
        name: nginx
        state: started
        enabled: yes
    
    - name: 验证 Nginx 运行状态
      shell: |
        curl -s http://localhost | grep -q "Welcome to nginx"
      register: nginx_check
      failed_when: nginx_check.rc != 0
```

### 7.2 验证剧本语法

```bash
# 检查语法（不实际执行）
ansible-playbook --syntax-check playbook.yml

# 试运行（显示将要执行的操作）
ansible-playbook -C playbook.yml

# 详细输出
ansible-playbook -v playbook.yml
ansible-playbook -vv playbook.yml
ansible-playbook -vvv playbook.yml
```

| 命令                                         | 作用                | 实际效果                 |
| :------------------------------------------- | :------------------ | :----------------------- |
| ansible-playbook playbook.yml                | **实际执行剧本**    | 对目标主机进行真实操作   |
| ansible-playbook -C playbook.yml             | **试运行/检查模式** | 只显示将要做什么，不执行 |
| ansible-playbook --syntax-check playbook.yml | **语法检查**        | 只检查YAML语法是否正确   |

### 7.3 修改 Ansible 输出为 JSON 格式

```bash
# 修改配置文件
vim /etc/ansible/ansible.cfg
[defaults]
stdout_callback = json
bin_ansible_callbacks = True

# 重启后输出即为 JSON 格式，便于用 jq 处理
```

---

## 八、综合练习

### 练习1：YAML 转换练习

将以下 JSON 转换为 YAML：

```json
[
    {
        "0224": {
            "老师": "于超",
            "学生们": [
                {
                    "姓名": "黄彦",
                    "年龄": 23,
                    "地址": "深圳"
                },
                {
                    "姓名": "陈亮亮",
                    "年龄": 24,
                    "地址": "广州"
                },
                {
                    "姓名": "罗兴林",
                    "年龄": 26,
                    "地址": "贵州"
                }
            ]
        }
    }
]
```

**答案：**

```yaml
- "0224":
    老师: 于超
    学生们:
      - 姓名: 黄彦
        年龄: 23
        地址: 深圳
      - 姓名: 陈亮亮
        年龄: 24
        地址: 广州
      - 姓名: 罗兴林
        年龄: 26
        地址: 贵州
```

### 练习2：jq 命令练习

使用 jq 处理上述 JSON 数据：

```bash
# 1. 提取老师姓名
cat data.json | jq '.[]."0224"."老师"'

# 2. 提取所有学生
cat data.json | jq '.[]."0224"."学生们"'

# 3. 提取罗兴林的资料
cat data.json | jq '.[]."0224"."学生们"[] | select(."姓名" == "罗兴林")'

# 4. 提取陈亮亮的年龄
cat data.json | jq '.[]."0224"."学生们"[] | select(."姓名" == "陈亮亮")."年龄"'

# 5. 提取黄彦的地址
cat data.json | jq '.[]."0224"."学生们"[] | select(."姓名" == "黄彦")."地址"'
```

### 练习3：编写部署剧本

分别编写一键部署剧本：

1. **NFS 服务部署**
2. **Rsync 服务部署**
3. **Nginx 服务部署**
4. **Lsyncd 实时同步部署**

**要点：**

- 使用正确的 YAML 语法
- 合理的任务顺序
- 适当的错误处理
- 服务验证步骤

---

## 九、学习要点总结

1. **掌握 YAML 三种数据类型**：字典、列表、纯量
2. **理解 Playbook 结构**：hosts、vars、tasks
3. **熟练两种任务写法**：字典风格和变量风格
4. **学会 JSON 处理**：jq 命令的常用操作
5. **实践剧本编写**：从简单到复杂逐步练习
6. **调试技巧**：语法检查、试运行、详细输出

---

## 十、在线工具推荐

1. **JSON ↔ YAML 转换**：https://www.bejson.com/json/json2yaml/
2. **YAML 语法检查**：http://yaml-online-parser.appspot.com/
3. **jq 在线测试**：https://jqplay.org/
