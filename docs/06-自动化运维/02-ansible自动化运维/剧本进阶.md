## 一、Playbook 高级特性概述

### 1.1 为什么需要高级特性

- **简化剧本编写**：避免重复代码
- **提高可维护性**：结构化、模块化
- **增强灵活性**：条件执行、循环控制
- **编程逻辑**：变量、循环、条件判断等编程特性

### 1.2 两种任务参数写法对比

```yaml
# 写法1：字典风格（推荐，符合YAML标准）
- name: 创建用户
  user:
    name: test1
    state: present

# 写法2：简写风格（Ansible特有）
- name: 创建用户
  user: "name=test1 state=present"
```

---

## 二、循环（Loop）控制

### 2.1 基础循环语法

```yaml
# 循环创建多个用户（繁琐写法）
- name: create test1
  user:
    name: test1
    state: present
- name: create test2
  user:
    name: test2
    state: present
# ... 重复5次

# 使用loop优化
- name: create test1~5
  user:
    name: "{{ item }}"
    state: present
  loop:
    - test1
    - test2
    - test3
    - test4
    - test5
```

### 2.2 循环变量定义与使用

```yaml
# 定义循环变量
- name: 创建用户并设置密码
  hosts: backup
  tasks:
    - name: 创建用户
      user:
        name: "{{ item }}"
        state: present
      loop:
        - test1
        - test2
        - test3
        - test4
        - test5
    
    - name: 设置密码
      shell: echo 'yuchao666' | passwd --stdin "{{ item }}"
      loop:
        - test1
        - test2
        - test3
        - test4
        - test5
```

### 2.3 使用vars定义循环列表

```yaml
- name: 使用变量定义循环列表
  hosts: backup
  vars:
    users_list:
      - test1
      - test2
      - test3
      - test4
      - test5
  tasks:
    - name: 创建用户
      user:
        name: "{{ item }}"
        state: present
      loop: "{{ users_list }}"
```

### 2.4 循环字典数据

```yaml
# 循环创建用户并设置UID
- name: 创建用户带UID
  hosts: backup
  vars:
    users_info:
      - { user: 't1', uid: '2000' }
      - { user: 't2', uid: '2001' }
      - { user: 't3', uid: '2002' }
      - { user: 't4', uid: '2003' }
  tasks:
    - name: 创建用户和UID
      user:
        name: "{{ item.user }}"
        uid: "{{ item.uid }}"
      loop: "{{ users_info }}"
```

### 2.5 实际应用示例：创建多个目录

```yaml
# 繁琐写法
- name: 创建/data目录
  file:
    path: /data
    state: directory
    owner: www
    group: www
    mode: '755'

- name: 创建/backup目录
  file:
    path: /backup
    state: directory
    owner: www
    group: www
    mode: '755'

# 使用loop优化
- name: 创建多个目录
  file:
    path: "{{ item.file_path }}"
    state: directory
    owner: www
    group: www
    mode: "{{ item.mode }}"
  loop:
    - { file_path: '/data', mode: '755' }
    - { file_path: '/backup', mode: '755' }
```

---

## 三、变量（Variables）

### 3.1 变量定义位置与类型

| 变量类型            | 定义位置             | 作用域         | 示例                      |
| :------------------ | :------------------- | :------------- | :------------------------ |
| **vars自定义变量**  | Playbook中vars部分   | 当前Play       | `vars: data_path: /data`  |
| **主机清单变量**    | `/etc/ansible/hosts` | 特定主机/组    | `172.16.1.7 http_port=80` |
| **Ansible内置变量** | setup模块收集        | 全局           | `{{ ansible_hostname }}`  |
| **注册变量**        | tasks中register定义  | 当前任务及之后 | `register: result`        |

### 3.2 vars自定义变量

```yaml
- hosts: backup
  vars:
    data_path: /data
    dest_path: /etc
    config_path: /etc/rsync.passwd
  tasks:
    - name: 创建数据目录
      file:
        path: "{{ data_path }}"
        state: directory
    
    - name: 复制配置文件
      copy:
        src: "{{ config_path }}"
        dest: "{{ dest_path }}"
```

### 3.3 Ansible内置变量（Facts）

```yaml
# 使用setup模块收集的信息
- hosts: backup
  tasks:
    - name: 获取IP地址
      debug: msg="IP地址是: {{ ansible_all_ipv4_addresses }}"
    
    - name: 获取主机名
      debug: msg="主机名是: {{ ansible_hostname }}"
    
    - name: 获取默认IP
      debug: msg="默认IP: {{ ansible_default_ipv4.address }}"
    
    - name: 获取eth0 IP
      debug: msg="eth0 IP: {{ ansible_facts.eth0.ipv4.address }}"
```

### 3.4 主机清单变量

```ini
# /etc/ansible/hosts
[all:vars]
ansible_port=22999
ansible_password='123123'

[web]
172.16.1.[7:9]

[nfs]
172.16.1.31

[backup]
172.16.1.41 ansible_port=22 ansible_password='123123'
```

---

## 四、注册变量（Register）

### 4.1 register基础用法

```yaml
- hosts: backup
  tasks:
    # 执行命令并注册结果
    - name: 获取IP地址并写入文件
      shell: "echo {{ ansible_default_ipv4.address }} > /tmp/ip.log"
    
    # 读取文件并注册结果
    - name: 读取IP文件
      shell: "cat /tmp/ip.log"
      register: ip_log  # 注册变量
    
    # 使用注册变量
    - name: 显示IP信息
      debug:
        msg: "IP地址是: {{ ip_log.stdout_lines }}"
```

### 4.2 注册多个变量

```yaml
- name: 注册多个变量示例
  hosts: nfs
  tasks:
    - name: 获取主机名
      shell: "echo {{ ansible_hostname }} > /tmp/hostname.log"
    
    - name: 读取主机名文件
      shell: "cat /tmp/hostname.log"
      register: hostname_log
    
    - name: 获取IP地址
      shell: "echo {{ ansible_default_ipv4.address }} > /tmp/ip.log"
    
    - name: 读取IP文件
      shell: "cat /tmp/ip.log"
      register: ip_log
    
    - name: 显示挂载信息
      shell: "showmount -e 172.16.1.31"
      register: showmount_log
    
    # 循环显示所有注册变量
    - debug:
        msg: "{{ item.stdout_lines }}"
      loop:
        - "{{ showmount_log }}"
        - "{{ ip_log }}"
        - "{{ hostname_log }}"
```

### 4.3 常用返回值属性

注册变量提供了多个属性来获取命令执行结果：

| 属性           | 描述                   | 示例                        |
| :------------- | :--------------------- | :-------------------------- |
| `stdout`       | 标准输出（字符串）     | `{{ result.stdout }}`       |
| `stdout_lines` | 标准输出（列表，按行） | `{{ result.stdout_lines }}` |
| `stderr`       | 标准错误输出           | `{{ result.stderr }}`       |
| `rc`           | 返回码                 | `{{ result.rc }}`           |
| `changed`      | 是否发生改变           | `{{ result.changed }}`      |
| `failed`       | 是否失败               | `{{ result.failed }}`       |
| `msg`          | 消息                   | `{{ result.msg }}`          |

**官方文档**：[Common Return Values](https://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html)

---

## 五、条件判断（When）

### 5.1 基础条件判断

```yaml
# 判断文件变化后重启服务
- name: 配置文件变化时重启服务
  hosts: rsync
  tasks:
    - name: 复制rsyncd.conf配置文件
      copy:
        src: /tmp/41work/rsyncd.conf
        dest: /etc/
      register: conf_status  # 注册复制操作的结果
    
    - name: 重启rsyncd服务
      systemd:
        name: rsyncd
        state: restarted
      when: conf_status.changed  # 仅当配置文件变化时执行
```

### 5.2 复杂条件判断

```yaml
# 检查NFS配置文件是否存在并显示内容
- name: 检查NFS配置
  hosts: backup
  vars:
    nfs_file: /etc/exports
  tasks:
    - name: 检查NFS配置文件
      shell: "cat {{ nfs_file }}"
      register: nfs_result
      ignore_errors: true  # 忽略错误继续执行
    
    - name: 显示配置文件内容
      debug:
        msg: "{{ ansible_hostname }} 存在 {{ nfs_file }}，内容: {{ nfs_result.stdout }}"
      when: nfs_result is succeeded  # 当命令成功时

    - name: 文件不存在提示
      debug:
        msg: "{{ nfs_file }} 文件不存在"
      when: nfs_result is failed  # 当命令失败时
```

---

## 六、处理器（Handlers）

### 6.1 Handlers基础用法

Handlers用于在任务发生改变时触发特定操作（通常用于重启服务）。

```yaml
- name: 使用handlers管理服务重启
  hosts: backup
  tasks:
    - name: 复制rsyncd.conf配置文件
      copy:
        src: /script/rsyncd.conf
        dest: /etc/
      notify:  # 当任务发生改变时通知handler
        - restart rsyncd service
        - restart nginx service  # 可以通知多个handler

  handlers:  # handlers定义在tasks之后
    - name: restart rsyncd service
      systemd:
        name: rsyncd
        state: restarted
    
    - name: restart nginx service
      systemd:
        name: nginx
        state: restarted
```

### 6.2 Handlers工作原理

1. **定义位置**：`handlers:` 部分必须放在 `tasks:` 之后
2. **触发条件**：只有 `notify` 所在的任务状态为 `changed` 时才会触发
3. **执行时机**：所有tasks执行完后，才会按顺序执行被触发的handlers
4. **多次通知**：同一handler被多次通知，只执行一次

---

## 七、标签（Tags）

### 7.1 标签基础用法

```yaml
# 为任务添加标签
- name: 部署NFS服务（带标签）
  hosts: nfs
  tasks:
    - name: 安装nfs-utils服务
      yum:
        name: nfs-utils
        state: installed
      tags: 01_install_nfs_service
    
    - name: 安装rpcbind服务
      yum:
        name: rpcbind
        state: installed
      tags: 02_install_rpcbind_service
    
    - name: 创建www组
      group:
        name: www
        gid: 666
      tags: 03_add_group
    
    - name: 创建www用户
      user:
        name: www
        uid: 666
        group: www
        create_home: no
        shell: /sbin/nologin
      tags: 04_add_user
    # ... 更多带标签的任务
```

### 7.2 标签管理命令

```bash
# 1. 列出剧本中的所有标签
ansible-playbook --list-tags install_nfs.yaml

# 2. 只执行特定标签的任务
ansible-playbook -t 01_install_nfs_service install_nfs.yaml

# 3. 执行多个标签
ansible-playbook -t "01_install_nfs_service,02_install_rpcbind_service" install_nfs.yaml

# 4. 跳过特定标签
ansible-playbook --skip-tags "05_create_data_dir,06_copy_nfs_exports" install_nfs.yaml

# 5. 列出所有任务（显示标签）
ansible-playbook --list-tasks install_nfs.yaml
```

### 7.3 任务管理命令

```bash
# 1. 列出所有任务
ansible-playbook --list-tasks install_nfs.yaml

# 2. 从特定任务开始执行
ansible-playbook --start-at-task "创建关于rsync密码文件" install_nfs.yaml

# 3. 检查语法（不执行）
ansible-playbook --syntax-check install_nfs.yaml

# 4. 试运行（显示将执行的操作）
ansible-playbook -C install_nfs.yaml
```

---

## 八、综合示例

### 8.1 完整NFS部署剧本（使用高级特性）

```yaml
---
- name: 部署NFS服务器
  hosts: nfs
  vars:
    shared_dirs:
      - { path: '/data', mode: '755' }
      - { path: '/backup', mode: '755' }
    nfs_exports_content: |
      /data 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)
      /backup 172.16.1.0/24(rw,sync,all_squash,anonuid=666,anongid=666)
  
  tasks:
    # 安装软件包
    - name: 安装必要软件包
      yum:
        name: "{{ item }}"
        state: installed
      loop:
        - nfs-utils
        - rpcbind
      tags: install_packages
    
    # 创建用户和组
    - name: 创建www组
      group:
        name: www
        gid: 666
      tags: create_group
    
    - name: 创建www用户
      user:
        name: www
        uid: 666
        group: www
        create_home: no
        shell: /sbin/nologin
      tags: create_user
    
    # 创建共享目录（使用loop）
    - name: 创建共享目录
      file:
        path: "{{ item.path }}"
        state: directory
        owner: www
        group: www
        mode: "{{ item.mode }}"
      loop: "{{ shared_dirs }}"
      tags: create_dirs
    
    # 配置NFS
    - name: 配置NFS exports
      copy:
        content: "{{ nfs_exports_content }}"
        dest: /etc/exports
      notify: restart_nfs_services
      tags: configure_nfs
    
    # 启动服务
    - name: 启动rpcbind服务
      systemd:
        name: rpcbind
        state: started
        enabled: yes
      tags: start_rpcbind
    
    - name: 启动NFS服务
      systemd:
        name: nfs
        state: started
        enabled: yes
      tags: start_nfs
    
    # 验证配置
    - name: 验证NFS配置
      shell: showmount -e localhost
      register: nfs_export_result
      tags: verify_config
    
    - name: 显示NFS导出列表
      debug:
        msg: "NFS导出列表: {{ nfs_export_result.stdout_lines }}"
      when: nfs_export_result is succeeded
  
  handlers:
    - name: restart_nfs_services
      systemd:
        name: "{{ item }}"
        state: restarted
      loop:
        - rpcbind
        - nfs
```

---

## 九、最佳实践与总结

### 9.1 高级特性使用建议

1. **适度使用**：不要为了用而用，保持剧本可读性
2. **渐进学习**：先掌握基础，再逐步使用高级特性
3. **注释清晰**：复杂逻辑要添加详细注释
4. **模块化设计**：将相关任务分组，使用标签管理

### 9.2 各特性适用场景

| 特性                     | 适用场景                             | 优点                     |
| :----------------------- | :----------------------------------- | :----------------------- |
| **循环（loop）**         | 重复性操作（创建多个用户/目录/文件） | 减少代码重复，易于维护   |
| **变量（vars）**         | 需要灵活配置的参数                   | 提高剧本灵活性，便于修改 |
| **注册变量（register）** | 需要获取命令执行结果                 | 实现任务间数据传递       |
| **条件判断（when）**     | 根据不同条件执行不同操作             | 提高剧本智能性           |
| **处理器（handlers）**   | 配置文件变化后重启服务               | 确保服务配置生效         |
| **标签（tags）**         | 选择性执行部分任务                   | 提高执行灵活性           |

### 9.3 学习路径建议

1. **第一阶段**：掌握基础YAML语法和常用模块
2. **第二阶段**：学习变量和循环，简化重复任务
3. **第三阶段**：掌握条件判断和注册变量，实现智能逻辑
4. **第四阶段**：使用handlers和标签，优化剧本结构
5. **第五阶段**：综合运用所有特性，编写生产级剧本

### 9.4 重要官方文档链接

- [Playbook Conditionals](https://docs.ansible.com/ansible/latest/user_guide/playbooks_conditionals.html)
- [Playbook Variables](https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html)
- [Playbook Handlers](https://docs.ansible.com/ansible/latest/user_guide/playbooks_handlers.html)
- [Common Return Values](https://docs.ansible.com/ansible/latest/reference_appendices/common_return_values.html)

---

**核心要点**：Ansible Playbook的高级特性虽然增加了学习曲线，但能显著提高剧本的可维护性和灵活性。在实际工作中，应根据具体需求选择合适的技术组合，平衡功能性与可读性。
