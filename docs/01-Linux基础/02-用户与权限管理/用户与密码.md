# Linux 用户登录、环境变量与密码管理

---

## 一、用户登录与环境变量切换

### 1. 完全切换用户环境变量的两种方法

```bash
# 方法1：使用 su - （加载目标用户的环境变量）
su - 用户名

# 方法2：登录时直接加载（SSH登录默认会加载）
ssh 用户名@主机
```

### 2. 环境变量查询命令

```bash
# 查看用户相关的环境变量
env

# 查看全系统的环境变量（包括用户定义变量）
set
```

---

## 二、命令提示符（PS1）配置

### 1. PS1 变量详解

```bash
# 查看当前 PS1 配置
echo $PS1
set | grep PS1

# 示例输出：
PS1='[\u@\h \W]\$ '

# PS1 转义字符含义：
# \u   # 显示用户名
# \h   # 显示主机名（短名称）
# \H   # 显示完整主机名
# \W   # 显示当前目录的最后一级（相对路径）
# \w   # 显示当前完整目录路径
# \t   # 显示24小时制时间（HH:MM:SS）
# \$   # 显示用户身份提示符（root为#，普通用户为$）
```

### 2. 永久生效配置

```bash
# 1. 用户个人配置（仅对当前用户生效）
# 编辑用户家目录下的配置文件
vim ~/.bash_profile
# 添加：PS1='[\u@\h \w]\$'
export PS1="[\[\e[34;1m\]\u@\[\e[0m\]\[\e[32;1m\]\H\[\e[0m\] \[\e[31;1m\]\w\[\e[0m\]]\\$"

# 2. 全局系统配置（对所有用户生效）
# 需要root权限
sudo vim /etc/profile
# 添加：PS1='[\u@\h \w]\$'
export PS1="[\[\e[34;1m\]\u@\[\e[0m\]\[\e[32;1m\]\H\[\e[0m\] \[\e[31;1m\]\w\[\e[0m\]]\\$"

source ~/.bash_profile     # 对当前用户
source /etc/profile        # 对所有用户（需要重新登录或source）
```

---

## 三、用户环境变量损坏修复

### 1. 常见错误现象

```bash
# 切换用户时出现警告
su - user1

# 输出：
# 上一次登录：四 3月 17 09:51:51 CST 2022pts/0 上
# su: 警告：无法更改到 /home/user1 目录: 没有那个文件或目录
# -bash-4.2$
# -bash-4.2$ echo $PS1
# \s-\v\$
```

### 2. 问题原因

| 序号 | 原因说明 |
|:----:|:---------|
| 1 | 用户家目录 `/home/user1` 不存在 |
| 2 | 家目录中缺少用户配置文件（从 `/etc/skel` 复制） |
| 3 | 系统无法加载用户的个人环境变量配置 |

### 3. 修复步骤

```bash
# 1. 创建用户家目录（如果不存在）
mkdir -p /home/user1

# 2. 从模板目录复制配置文件
cp -r /etc/skel/. /home/user1/

# 3. 设置正确的所有权
chown -R user1:user1 /home/user1

# 4. 设置正确的权限
chmod 700 /home/user1

# 5. 重新切换用户测试
su - user1
```

### 4. 快速修复命令

```bash
# 一键修复（需要root权限）
mkdir -p /home/user1 && \
cp -r /etc/skel/. /home/user1 && \
chown -R user1:user1 /home/user1 && \
chmod 700 /home/user1
```

---

## 四、用户密码管理

### 1. 三种修改密码的方式

**方式一：交互式修改（推荐）**

```bash
# root用户修改其他用户密码
passwd 用户名

# 用户修改自己的密码
passwd
```

**方式二：非交互式修改（脚本中使用）**

```bash
# 使用 echo + passwd --stdin
echo '新密码' | passwd --stdin 用户名

# 示例：
echo 'MyPassword123' | passwd --stdin user1
```

**方式三：批量修改或文件导入**

```bash
# 方法1：使用 echo + chpasswd
echo '用户名:新密码' | chpasswd

# 示例：
echo 'user1:MyPassword123' | chpasswd

# 方法2：从文件批量修改
# 创建密码文件
echo 'user1:pass1' > pass.txt
echo 'user2:pass2' >> pass.txt

# 批量设置
cat pass.txt | chpasswd

# 方法3：直接使用 passwd 从文件读取
# 创建包含密码的文件
echo 'MyPassword123' > password.txt
cat password.txt | passwd --stdin user1
```

### 2. 密码策略相关命令

```bash
# 查看密码过期信息
chage -l 用户名

# 设置密码过期策略
chage -M 90 用户名      # 90天后密码过期
chage -W 7 用户名       # 提前7天警告
chage -d 0 用户名       # 强制下次登录修改密码

# 锁定/解锁用户账户
passwd -l 用户名        # 锁定
passwd -u 用户名        # 解锁
```

### 3. 安全建议

| 序号 | 建议内容 |
|:----:|:---------|
| 1 | 使用复杂密码 |
| 2 | 定期更换密码 |
| 3 | 不要使用明文存储密码 |
| 4 | 为不同服务使用不同密码 |
| 5 | 启用密码策略（通过 `/etc/login.defs` 配置） |

---

## 五、实用技巧

### 1. 快速查看所有用户的家目录

```bash
# 查看系统中所有用户及其家目录
cat /etc/passwd | cut -d: -f1,6

# 仅查看普通用户
awk -F: '$3 >= 1000 && $3 != 65534 {print $1 " : " $6}' /etc/passwd
```

### 2. 检查用户配置是否完整

```bash
# 检查用户是否有完整的配置文件
ls -la /home/用户名/ | grep -E '\.bashrc|\.bash_profile|\.profile'
```

### 3. 批量修复用户配置

```bash
# 修复多个用户的环境配置
for user in user1 user2 user3; do
    if [ -d "/home/$user" ]; then
        cp /etc/skel/.bash* /home/$user/
        chown $user:$user /home/$user/.bash*
    fi
done
```

### 4. 环境变量相关文件加载顺序

| 序号 | 配置文件 | 说明 |
|:----:|:---------|:-----|
| 1 | `/etc/profile` | 系统全局配置 |
| 2 | `/etc/profile.d/*.sh` | 全局脚本目录 |
| 3 | `~/.bash_profile` | 用户个人配置（优先） |
| 4 | `~/.bashrc` | 用户交互式shell配置 |
| 5 | `~/.profile` | 部分系统使用 |

---

## 六、总结

| 操作类型 | 主要命令 | 适用场景 |
|:---------|:---------|:---------|
| **用户切换** | `su - 用户` | 完全切换用户环境 |
| **环境变量** | `env`, `set`, `echo $PS1` | 查看和配置环境 |
| **PS1配置** | `PS1='格式'` | 自定义命令提示符 |
| **密码修改** | `passwd`, `chpasswd` | 单用户/批量修改 |
| **修复配置** | `cp /etc/skel/. ~/` | 修复损坏的用户环境 |
| **权限修复** | `chown`, `chmod` | 修复文件所有权和权限 |
