# Linux 进程管理与资源监控

---

## 一、服务器资源概述

### 1. 服务器四大核心资源

| 资源类型 | 管理要点 | 相关命令 |
|:---------|:---------|:---------|
| **磁盘资源** | 容量空间、读写性能 | `df`, `du`, `iostat`, `iotop` |
| **内存资源** | 总大小、可用空间 | `free`, `top`, `ps` |
| **CPU资源** | 核心数、负载 | `lscpu`, `top`, `uptime`, `stress` |
| **网络资源** | 吞吐量、连接数 | `iftop`, `netstat`, `ss`, `nload` |

### 2. 进程基础概念

**进程**：程序的一次动态执行，操作系统资源分配的基本单位

**进程特点**：

| 特点 | 说明 |
|:-----|:-----|
| 独立性 | 每个进程有独立的地址空间 |
| 资源隔离 | 进程间资源默认不可共享 |
| 生命周期 | 创建、运行、阻塞、终止 |

---

## 二、进程家族关系

### 1. 进程树结构

```text
1号进程 (systemd)
    └── sshd (SSH服务)
        └── bash (Shell解释器)
            └── ps/ls/grep (用户命令)
```

### 2. 特殊进程类型

| 进程类型 | 特征 | 处理方式 |
|:---------|:-----|:---------|
| **孤儿进程** | 父进程终止，子进程被1号进程收养 | 自动回收 |
| **僵尸进程** | 进程已终止但未释放PCB | `kill -9` 或父进程回收 |

### 3. 进程状态识别

```bash
# 查看进程状态
ps aux | grep defunct      # 查找僵尸进程
ps -ef | awk '$3 == 1'    # 查找孤儿进程（PPID=1）

# 进程状态码说明
# R: 运行中, S: 睡眠, Z: 僵尸, D: 不可中断睡眠
# T: 停止, X: 死亡, <: 高优先级, N: 低优先级
```

---

## 三、进程管理命令

### 1. ps 命令（进程查看）

```bash
# UNIX风格
ps aux                       # 显示所有进程详细信息
ps aux --sort=%mem           # 按内存使用排序
ps aux --sort=-%cpu          # 按CPU使用降序
ps auxf                      # 显示进程树形结构

# Linux风格
ps -ef                       # 显示所有进程完整信息
ps -fp PID                   # 查看指定PID进程
ps -fC nginx                 # 查看指定进程名
ps -U username               # 查看指定用户进程
ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head -10  # 定制输出
```

### 2. top 命令（实时监控）

```bash
top                          # 实时查看系统资源
top -c                       # 显示完整命令
top -p PID1,PID2             # 监控指定进程
top -u username              # 监控指定用户进程
```

**top 交互命令**：

| 按键 | 功能 |
|:-----|:-----|
| `1` | 显示CPU核心详情 |
| `M` | 按内存使用排序 |
| `P` | 按CPU使用排序 |
| `k` | 结束指定进程 |
| `h` | 显示帮助 |
| `q` | 退出 |

### 3. htop 命令（增强版监控）

```bash
# 安装
yum install htop -y
htop                         # 更美观的监控界面
```

**htop 交互操作**：

| 按键 | 功能 |
|:-----|:-----|
| `F2` | 设置 |
| `F3` | 搜索进程 |
| `F4` | 过滤进程 |
| `F5` | 树形显示 |
| `F9` | 发送信号 |
| `F10` | 退出 |

---

## 四、进程控制命令

### 1. kill 命令（进程控制）

```bash
# 常用信号
kill -1 PID     # HUP 重载配置（nginx等）
kill -2 PID     # INT 中断（同 Ctrl+C）
kill -9 PID     # KILL 强制终止（无法忽略）
kill -15 PID    # TERM 优雅终止（默认）
kill -18 PID    # CONT 继续运行
kill -19 PID    # STOP 暂停进程

# 按进程名操作
pkill nginx                    # 结束所有nginx进程
killall httpd                  # 结束所有httpd进程
kill -9 $(pgrep nginx)         # 强制结束nginx相关进程
```

### 2. 后台进程管理

```bash
# 后台运行
command &                     # 后台运行
nohup command &               # 后台运行且不挂断

# 作业控制
jobs                         # 查看后台作业
fg %1                        # 将作业1调到前台
bg %1                        # 将暂停的作业1后台运行
ctrl+z                       # 暂停前台作业放入后台

# 实际使用示例
nohup python server.py > server.log 2>&1 &
```

### 3. 进程优先级

```bash
nice -n 10 command           # 以较低优先级运行
renice 5 PID                 # 调整运行中进程优先级

# 优先级范围 -20（最高）到 19（最低）
```

---

## 五、系统资源监控

### 1. CPU 监控

```bash
# 查看CPU信息
lscpu                       # CPU架构信息
cat /proc/cpuinfo           # 详细CPU信息
nproc                       # CPU核心数

# 查看CPU负载
uptime                      # 系统负载（1,5,15分钟）
sar -u 1 10                 # 每1秒采样CPU，共10次
mpstat -P ALL 1             # 查看所有CPU核心使用率

# 压力测试
stress --cpu 4 --timeout 600  # 启动4个CPU压力进程
```

### 2. 内存监控

```bash
# 查看内存使用
free -h                     # 人性化显示
free -m                     # 以MB显示
free -s 5                   # 每5秒刷新一次
```

**内存指标说明**：

| 指标 | 说明 |
|:-----|:-----|
| total | 总内存 |
| used | 已使用（含buffers/cache） |
| free | 完全空闲内存 |
| shared | 共享内存 |
| buff/cache | 缓冲区/缓存 |
| available | 应用程序可用内存（含可回收缓存） |

```bash
# 内存压力测试
stress --vm 2 --vm-bytes 256M --timeout 300s  # 创建2个256M内存进程
```

### 3. 磁盘监控

```bash
# 磁盘空间
df -h                       # 查看磁盘使用情况
df -i                       # 查看inode使用情况
du -sh /path               # 查看目录大小

# 磁盘IO监控
iostat -x 1 10             # 查看磁盘IO详情
iotop                      # 实时磁盘IO监控
sar -d 1 10                # 磁盘活动统计

# 文件系统缓存
sync && echo 3 > /proc/sys/vm/drop_caches  # 清理缓存
```

### 4. 网络监控

```bash
# 网络连接查看
netstat -tunlp             # 查看所有监听端口
ss -tunlp                  # 更快的替代命令（高并发场景）
lsof -i:80                 # 查看80端口使用情况

# 网络流量监控
iftop                      # 实时流量监控（需安装）
nload                      # 网卡流量监控
sar -n DEV 1 10           # 网络设备统计

# 查看网络统计
cat /proc/net/dev         # 网络设备统计信息
```

---

## 六、高级进程管理

### 1. lsof 命令（文件与进程关联）

```bash
# 常用操作
lsof /path/to/file        # 查看文件被哪些进程使用
lsof -p PID               # 查看进程打开的文件
lsof -u username          # 查看用户打开的文件
lsof -i:80                # 查看使用80端口的进程
lsof -i tcp               # 查看所有TCP连接
lsof -c nginx             # 查看nginx进程打开的文件

# 恢复误删的文件（进程仍持有文件句柄时）
# 1. 找到文件句柄
lsof | grep deleted
# 2. 从/proc/PID/fd/FD恢复
cp /proc/PID/fd/FD /path/to/restore
```

### 2. 进程与文件句柄

```bash
# 查看进程文件句柄
ls -l /proc/PID/fd        # 查看进程打开的文件描述符
ls -l /proc/PID/fdinfo    # 查看文件描述符信息

# 系统限制
ulimit -n                 # 查看最大文件打开数
cat /proc/sys/fs/file-max # 系统总限制
```

### 3. 系统性能监控工具包（sysstat）

```bash
# 安装
yum install sysstat -y

# 常用命令
sar                      # 系统活动报告
iostat                   # CPU和磁盘统计
mpstat                   # CPU统计
pidstat                  # 进程统计
```

---

## 七、数据流与重定向

### 1. 标准数据流

| 流类型 | 文件描述符 | 默认设备 | 说明 |
|:-------|:-----------|:---------|:-----|
| stdin | 0 | 键盘 | 标准输入 |
| stdout | 1 | 显示器 | 标准输出 |
| stderr | 2 | 显示器 | 标准错误 |

### 2. 重定向操作

```bash
# 输出重定向
command > file           # 覆盖输出到文件
command >> file          # 追加输出到文件
command 2> error.log    # 错误输出到文件
command &> all.log       # 所有输出到文件
command 2>&1             # 错误合并到标准输出

# 输入重定向
command < input.txt      # 从文件读取输入
command << EOF           # 多行输入（heredoc）
line1
line2
EOF

# 丢弃输出
command > /dev/null      # 丢弃标准输出
command 2> /dev/null     # 丢弃错误输出
command &> /dev/null     # 丢弃所有输出
```

### 3. 管道操作

```bash
# 基本管道
command1 | command2      # command1输出作为command2输入

# 实用组合
ps aux | grep nginx      # 查找nginx进程
netstat -tunlp | grep :80  # 查找80端口进程
df -h | grep /dev/sda    # 查找特定分区
```

---

## 八、TCP/UDP网络理解

### 1. 协议对比

| 特性 | TCP | UDP |
|:-----|:----|:----|
| 连接方式 | 面向连接 | 无连接 |
| 可靠性 | 可靠传输 | 不可靠传输 |
| 速度 | 较慢 | 较快 |
| 应用场景 | HTTP、FTP、SSH | DNS、NTP、实时音视频 |
| 头部大小 | 20字节 | 8字节 |

### 2. 网络状态查看

```bash
# 查看监听端口
netstat -tunlp           # 查看所有监听端口
ss -tunlp                # 替代netstat（性能更好）

# 查看连接状态
netstat -an | grep ESTABLISHED  # 查看已建立连接
ss -s                    # 查看socket统计

# 按状态统计
netstat -an | awk '/^tcp/ {++S[$NF]} END {for(a in S) print a, S[a]}'
```

---

## 九、运维最佳实践

### 1. 进程管理原则

| 原则 | 说明 |
|:-----|:-----|
| 使用 `systemctl` 管理服务进程 | 标准化服务管理 |
| 避免直接使用 `kill -9` | 防止数据丢失 |
| 监控僵尸进程并及时清理 | 释放系统资源 |
| 合理设置进程优先级 | 优化资源分配 |

### 2. 资源监控策略

- 定期检查系统负载（`uptime`）
- 监控内存使用趋势（`free`、`sar`）
- 关注磁盘空间和IO性能
- 设置资源使用告警阈值

### 3. 故障排查流程

```bash
# 1. 查看系统负载
uptime && top -n 1

# 2. 检查内存使用
free -h && ps aux --sort=-%mem | head -10

# 3. 检查磁盘空间
df -h && du -sh /* 2>/dev/null | sort -hr | head -10

# 4. 检查网络连接
netstat -tunlp && ss -s

# 5. 检查进程状态
ps aux | grep defunct && pstree -p
```

### 4. 常用监控脚本示例

```bash
#!/bin/bash
# 系统资源监控脚本

echo "=== 系统资源监控 $(date) ==="
echo ""
echo "1. 系统负载:"
uptime
echo ""
echo "2. 内存使用:"
free -h
echo ""
echo "3. 磁盘空间:"
df -h
echo ""
echo "4. CPU使用率最高的10个进程:"
ps aux --sort=-%cpu | head -11
echo ""
echo "5. 内存使用率最高的10个进程:"
ps aux --sort=-%mem | head -11
echo ""
echo "6. 网络连接统计:"
ss -s
```
