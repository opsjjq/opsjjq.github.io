# Kubernetes 配置文件汇总（ConfigMap 与 Secret）

## 1. 配置管理概述

### 为什么需要配置管理

Kubernetes 应用通常需要配置文件、环境变量等。直接将配置打包到镜像中会导致：

1. 配置与代码耦合，难以更新
2. 敏感信息（密码、密钥）泄露风险
3. 不同环境需要不同镜像

---

### 配置管理方案

| 方案 | 用途 |
| :--- | :--- |
| **ConfigMap** | 存储非敏感配置 |
| **Secret** | 存储敏感信息（密码、密钥） |
| **环境变量** | 直接传递配置 |
| **命令行参数** | 动态配置 |

---

## 2. ConfigMap

### 什么是 ConfigMap

ConfigMap 用于存储非敏感的配置数据，如配置文件、命令行参数、环境变量等。

---

### 创建 ConfigMap

#### 方式一：从字面值创建

```bash
kubectl create configmap nginx-config \
  --from-literal=nginx_port=80 \
  --from-literal=server_name=www.example.com
```

---

#### 方式二：从文件创建

```bash
# 创建配置文件
cat > nginx.conf <<EOF
server {
    listen 80;
    server_name www.example.com;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}
EOF

# 从文件创建 ConfigMap
kubectl create configmap nginx-conf --from-file=nginx.conf
```

---

#### 方式三：从目录创建

```bash
# 创建配置目录
mkdir -p config
cat > config/app.conf <<EOF
app_name=myapp
app_version=1.0.0
EOF

cat > config/db.conf <<EOF
db_host=localhost
db_port=3306
EOF

# 从目录创建 ConfigMap
kubectl create configmap app-config --from-file=config/
```

---

#### 方式四：YAML 文件创建

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: yuchaoit
data:
  nginx_port: "80"
  server_name: "www.yuchaoit.com"
  nginx.conf: |
    server {
        listen 80;
        server_name www.yuchaoit.com;

        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
    }
```

```bash
# 创建 ConfigMap
kubectl create -f configmap-nginx.yaml

# 查看 ConfigMap
kubectl get configmap nginx-config -n yuchaoit

# 查看 ConfigMap 详情
kubectl describe configmap nginx-config -n yuchaoit

# 查看 ConfigMap 数据
kubectl get configmap nginx-config -n yuchaoit -o yaml
```

---

### 使用 ConfigMap

#### 方式一：环境变量

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-cm-env
spec:
  containers:
    - name: nginx
      image: nginx:alpine
      env:
        - name: NGINX_PORT
          valueFrom:
            configMapKeyRef:
              name: nginx-config
              key: nginx_port
        - name: SERVER_NAME
          valueFrom:
            configMapKeyRef:
              name: nginx-config
              key: server_name
```

---

#### 方式二：命令行参数

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-cm-args
spec:
  containers:
    - name: nginx
      image: nginx:alpine
      command: ["/bin/sh", "-c"]
      args:
        - echo "Nginx Port: $(NGINX_PORT), Server: $(SERVER_NAME)"
      env:
        - name: NGINX_PORT
          valueFrom:
            configMapKeyRef:
              name: nginx-config
              key: nginx_port
        - name: SERVER_NAME
          valueFrom:
            configMapKeyRef:
              name: nginx-config
              key: server_name
```

---

#### 方式三：挂载为文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-cm-volume
spec:
  volumes:
    - name: nginx-config-volume
      configMap:
        name: nginx-config

  containers:
    - name: nginx
      image: nginx:alpine
      volumeMounts:
        - name: nginx-config-volume
          mountPath: /etc/nginx/conf.d
```

```bash
# 创建 Pod
kubectl create -f pod-cm-volume.yaml

# 验证配置文件
kubectl exec nginx-cm-volume -- cat /etc/nginx/conf.d/nginx_port
kubectl exec nginx-cm-volume -- cat /etc/nginx/conf.d/server_name
```

---

#### 方式四：挂载为单个文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-cm-file
spec:
  volumes:
    - name: nginx-conf-volume
      configMap:
        name: nginx-conf
        items:
          - key: nginx.conf
            path: nginx.conf

  containers:
    - name: nginx
      image: nginx:alpine
      volumeMounts:
        - name: nginx-conf-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
```

---

### ConfigMap 更新

```bash
# 更新 ConfigMap
kubectl edit configmap nginx-config

# 查看更新后的数据
kubectl get configmap nginx-config -o yaml

# 注意：挂载的 ConfigMap 会自动更新，但环境变量不会自动更新
```

---

## 3. Secret

### 什么是 Secret

Secret 用于存储敏感信息，如密码、密钥、证书等。Secret 数据默认是 base64 编码的。

---

### Secret 类型

| 类型 | 说明 |
| :--- | :--- |
| **Opaque** | 通用 Secret（默认） |
| **kubernetes.io/service-account-token** | Service Account Token |
| **kubernetes.io/dockercfg** | Docker Registry 凭证 |
| **kubernetes.io/dockerconfigjson** | Docker Registry 凭证（JSON） |
| **kubernetes.io/basic-auth** | 基本认证 |
| **kubernetes.io/ssh-auth** | SSH 认证 |
| **kubernetes.io/tls** | TLS 证书 |

---

### 创建 Secret

#### 方式一：从字面值创建

```bash
kubectl create secret generic mysql-secret \
  --from-literal=username=root \
  --from-literal=password=123456
```

---

#### 方式二：从文件创建

```bash
# 创建证书文件
cat > tls.crt <<EOF
-----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
EOF

cat > tls.key <<EOF
-----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----
EOF

# 从文件创建 Secret
kubectl create secret tls tls-secret --cert=tls.crt --key=tls.key
```

---

#### 方式三：YAML 文件创建

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
  namespace: yuchaoit
type: Opaque
data:
  username: cm9vdA==  # base64 编码的 "root"
  password: MTIzNDU2  # base64 编码的 "123456"
```

```bash
# base64 编码
echo -n "root" | base64
echo -n "123456" | base64

# 创建 Secret
kubectl create -f secret-mysql.yaml

# 查看 Secret（数据是 base64 编码的）
kubectl get secret mysql-secret -n yuchaoit -o yaml

# 解码查看
kubectl get secret mysql-secret -n yuchaoit -o jsonpath='{.data.password}' | base64 -d
```

---

### 使用 Secret

#### 方式一：环境变量

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mysql-secret-env
spec:
  containers:
    - name: mysql
      image: mysql:5.7
      env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: password
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: username
```

---

#### 方式二：挂载为文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mysql-secret-volume
spec:
  volumes:
    - name: mysql-secret-volume
      secret:
        secretName: mysql-secret

  containers:
    - name: mysql
      image: mysql:5.7
      volumeMounts:
        - name: mysql-secret-volume
          mountPath: /etc/mysql/secrets
          readOnly: true
```

```bash
# 创建 Pod
kubectl create -f pod-secret-volume.yaml

# 验证 Secret 文件
kubectl exec mysql-secret-volume -- ls /etc/mysql/secrets
kubectl exec mysql-secret-volume -- cat /etc/mysql/secrets/password
```

---

#### 方式三：挂载为单个文件

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mysql-secret-file
spec:
  volumes:
    - name: mysql-secret-volume
      secret:
        secretName: mysql-secret
        items:
          - key: password
            path: mysql-password

  containers:
    - name: mysql
      image: mysql:5.7
      volumeMounts:
        - name: mysql-secret-volume
          mountPath: /etc/mysql/password.txt
          subPath: mysql-password
```

---

### Secret 加密

Kubernetes 支持静态加密 Secret 数据（需要配置 EncryptionConfiguration）。

---

## 4. ConfigMap 与 Secret 对比

| 特性 | ConfigMap | Secret |
| :--- | :--- | :--- |
| **用途** | 非敏感配置 | 敏感信息 |
| **数据格式** | 明文 | base64 编码 |
| **存储限制** | 1MiB | 1MiB |
| **安全性** | 不加密 | 支持加密 |
| **访问控制** | RBAC | RBAC |
| **挂载方式** | 环境变量、文件 | 环境变量、文件 |

---

## 5. 最佳实践

### ConfigMap 最佳实践

1. **分离配置与代码**：不要将配置打包到镜像中
2. **使用命名空间**：不同环境使用不同的命名空间
3. **版本控制**：将 ConfigMap YAML 文件纳入版本控制
4. **合理命名**：使用清晰的命名规范
5. **限制大小**：单个 ConfigMap 不超过 1MiB

---

### Secret 最佳实践

1. **不要在 YAML 中明文存储**：使用 `--from-literal` 或 `--from-file` 创建
2. **使用 RBAC**：限制对 Secret 的访问
3. **启用加密**：在生产环境启用 Secret 加密
4. **定期轮换**：定期更新密码和密钥
5. **最小权限原则**：只授予必要的权限

---

### 使用建议

| 场景 | 推荐方案 |
| :--- | :--- |
| **应用配置** | ConfigMap |
| **数据库密码** | Secret |
| **API 密钥** | Secret |
| **TLS 证书** | Secret（类型：kubernetes.io/tls） |
| **Docker Registry 凭证** | Secret（类型：kubernetes.io/dockerconfigjson） |

---

## 6. 常用命令汇总

```bash
# ConfigMap
kubectl create configmap <name> --from-literal=<key>=<value>
kubectl create configmap <name> --from-file=<file>
kubectl create configmap <name> --from-file=<dir>
kubectl get configmap
kubectl describe configmap <name>
kubectl get configmap <name> -o yaml
kubectl edit configmap <name>
kubectl delete configmap <name>

# Secret
kubectl create secret generic <name> --from-literal=<key>=<value>
kubectl create secret generic <name> --from-file=<file>
kubectl create secret tls <name> --cert=<cert> --key=<key>
kubectl get secret
kubectl describe secret <name>
kubectl get secret <name> -o yaml
kubectl edit secret <name>
kubectl delete secret <name>

# 解码 Secret
kubectl get secret <name> -o jsonpath='{.data.<key>}' | base64 -d
```

---

## 7. 故障排查

### ConfigMap 无法挂载

```bash
# 1. 检查 ConfigMap 是否存在
kubectl get configmap

# 2. 检查 Pod 状态
kubectl get pods

# 3. 查看 Pod 事件
kubectl describe pod <name>

# 4. 检查挂载点
kubectl exec <pod> -- ls /etc/config
```

---

### Secret 环境变量未生效

```bash
# 1. 检查 Secret 是否存在
kubectl get secret

# 2. 检查 Pod 环境变量
kubectl exec <pod> -- env | grep <key>

# 3. 查看 Pod 配置
kubectl get pod <name> -o yaml | grep -A10 env:
```

---

## 8. 实战案例

### Nginx 配置管理

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
data:
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log;
    pid /run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        server {
            listen 80;
            server_name localhost;

            location / {
                root /usr/share/nginx/html;
                index index.html;
            }
        }
    }

---
apiVersion: v1
kind: Pod
metadata:
  name: nginx-config-pod
spec:
  volumes:
    - name: nginx-config-volume
      configMap:
        name: nginx-config
        items:
          - key: nginx.conf
            path: nginx.conf

  containers:
    - name: nginx
      image: nginx:alpine
      volumeMounts:
        - name: nginx-config-volume
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
```

---

### MySQL 密码管理

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
type: Opaque
data:
  root-password: MTIzNDU2

---
apiVersion: v1
kind: Pod
metadata:
  name: mysql-secret-pod
spec:
  volumes:
    - name: mysql-secret-volume
      secret:
        secretName: mysql-secret

  containers:
    - name: mysql
      image: mysql:5.7
      env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: root-password
      volumeMounts:
        - name: mysql-secret-volume
          mountPath: /etc/mysql/secrets
          readOnly: true
```

---

## 9. 总结

### 配置管理关键要点

1. **ConfigMap** 用于非敏感配置
2. **Secret** 用于敏感信息
3. **环境变量** 适合少量配置
4. **挂载文件** 适合配置文件
5. **版本控制** 管理配置变更
6. **安全加固** 保护敏感信息

---

### 选择指南

| 需求 | 推荐方案 |
| :--- | :--- |
| **应用配置** | ConfigMap |
| **数据库密码** | Secret |
| **TLS 证书** | Secret（TLS 类型） |
| **Docker 凭证** | Secret（Docker 类型） |
| **配置文件** | ConfigMap 挂载为文件 |
| **环境变量** | ConfigMap 或 Secret |
