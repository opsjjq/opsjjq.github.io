# Kubernetes 控制器汇总

## 1. 控制器概述

Kubernetes 控制器是确保集群状态与期望状态一致的核心组件。它们通过监控集群状态并执行必要的操作来维持系统的稳定性。

### 常见控制器类型

| 控制器 | 用途 |
| :--- | :--- |
| **ReplicaSet** | 确保 Pod 副本数量 |
| **Deployment** | 管理 ReplicaSet，支持滚动更新 |
| **DaemonSet** | 在每个节点运行 Pod |
| **StatefulSet** | 有状态应用部署 |
| **Job** | 一次性任务 |
| **CronJob** | 定时任务 |

---

## 2. ReplicaSet 控制器

### 基本概念

ReplicaSet 确保指定数量的 Pod 副本始终运行。如果 Pod 异常退出，ReplicaSet 会自动创建新的 Pod 替换。

---

### 创建 ReplicaSet

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-rs
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - name: http
              containerPort: 80
```

```bash
# 创建 ReplicaSet
kubectl create -f rs-nginx.yaml

# 查看 ReplicaSet 和 Pod
kubectl get rs
kubectl get pods -l app=nginx

# 查看 ReplicaSet 详情
kubectl describe rs nginx-rs
```

---

### 扩缩容

```bash
# 方式一：修改 YAML 文件
kubectl edit rs nginx-rs
# 修改 replicas: 3 → 5

# 方式二：直接扩缩容
kubectl scale rs nginx-rs --replicas=5

# 验证
kubectl get pods -l app=nginx
```

---

### 删除 ReplicaSet

```bash
# 删除 ReplicaSet（会同时删除管理的 Pod）
kubectl delete rs nginx-rs

# 仅删除 ReplicaSet，保留 Pod
kubectl delete rs nginx-rs --cascade=false
```

---

## 3. Deployment 控制器

### 基本概念

Deployment 是最常用的控制器，它管理 ReplicaSet 并提供滚动更新、回滚等高级功能。

---

### 创建 Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - image: nginx:alpine
          name: nginx-containers
          ports:
            - name: http
              containerPort: 80
```

```bash
# 创建 Deployment
kubectl create -f deploy-nginx.yaml

# 查看 Deployment、ReplicaSet 和 Pod
kubectl get deploy
kubectl get rs
kubectl get pods -l app=nginx
```

---

### Deployment 状态字段

```bash
kubectl get deploy deploy1 -o yaml
```

关键字段：

| 字段 | 含义 |
| :--- | :--- |
| **spec.replicas** | 期望的 Pod 副本数 |
| **status.replicas** | 当前运行的 Pod 数量 |
| **status.updatedReplicas** | 已更新到新版本的 Pod 数量 |
| **status.availableReplicas** | 可用的 Pod 数量 |
| **status.readyReplicas** | 就绪的 Pod 数量 |

---

### 扩缩容

```bash
# 方式一：修改 YAML
kubectl edit deployment deploy1

# 方式二：命令行扩缩容
kubectl scale deployment deploy1 --replicas=5

# 验证
kubectl get pods -l app=nginx
```

---

### 滚动更新

```bash
# 方式一：修改 YAML 中的镜像版本
kubectl edit deployment deploy1
# 修改 image: nginx:alpine → nginx:1.20

# 方式二：直接更新镜像
kubectl set image deployment deploy1 nginx-containers=nginx:1.20

# 查看更新状态
kubectl rollout status deployment deploy1

# 查看更新历史
kubectl rollout history deployment deploy1

# 查看特定版本的详细信息
kubectl rollout history deployment deploy1 --revision=2
```

---

### 回滚

```bash
# 查看历史版本
kubectl rollout history deployment deploy1

# 回滚到上一个版本
kubectl rollout undo deployment deploy1

# 回滚到指定版本
kubectl rollout undo deployment deploy1 --to-revision=1

# 验证
kubectl get pods -l app=nginx
kubectl describe deploy deploy1
```

---

### 更新策略配置

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-update
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # 更新过程中最多比期望值多 1 个 Pod
      maxUnavailable: 1  # 更新过程中最多有 1 个 Pod 不可用
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
```

---

### 暂停和恢复更新

```bash
# 暂停 Deployment 更新
kubectl rollout pause deployment deploy1

# 执行多次修改（不会立即触发更新）
kubectl set image deployment deploy1 nginx-containers=nginx:1.19
kubectl set resources deployment deploy1 --limits=cpu=500m,memory=256Mi

# 恢复更新（一次性应用所有修改）
kubectl rollout resume deployment deploy1
```

---

## 4. DaemonSet 控制器

### 基本概念

DaemonSet 确保在每个节点上运行一个 Pod 副本，常用于日志收集、监控代理等场景。

---

### 创建 DaemonSet

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nginx-ds
  labels:
    app: nginx
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
```

```bash
# 创建 DaemonSet
kubectl create -f ds-nginx.yaml

# 查看 DaemonSet 和 Pod
kubectl get ds
kubectl get pods -l app=nginx -o wide

# 验证每个节点都有一个 Pod
kubectl get nodes
```

---

### 节点选择器

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nginx-ds-labeled
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      nodeSelector:
        disk: ssd  # 只在带有 disk=ssd 标签的节点运行
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
```

```bash
# 给节点打标签
kubectl label nodes k8s-node-11 disk=ssd

# 验证 DaemonSet 只在指定节点运行
kubectl get pods -l app=nginx -o wide
```

---

## 5. StatefulSet 控制器

### 基本概念

StatefulSet 用于管理有状态应用，如数据库、消息队列等。它提供稳定的网络标识、持久化存储和有序部署。

---

### 创建 StatefulSet

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  clusterIP: None
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nginx-sts
spec:
  serviceName: nginx-svc
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
```

```bash
# 创建 Service 和 StatefulSet
kubectl create -f sts-nginx.yaml

# 查看 StatefulSet 和 Pod
kubectl get sts
kubectl get pods -l app=nginx

# 注意 Pod 名称的有序性
# nginx-sts-0, nginx-sts-1, nginx-sts-2
```

---

### StatefulSet 特性

| 特性 | 说明 |
| :--- | :--- |
| **稳定的网络标识** | Pod 名称固定，如 nginx-sts-0、nginx-sts-1 |
| **有序部署** | 按顺序创建 Pod，前一个就绪后才创建下一个 |
| **有序删除** | 按逆序删除 Pod |
| **有序滚动更新** | 从最大序号开始更新 |
| **持久化存储** | 每个 Pod 可绑定独立的 PVC |

---

### 扩缩容

```bash
# 扩容
kubectl scale statefulset nginx-sts --replicas=5

# 缩容
kubectl scale statefulset nginx-sts --replicas=2

# 验证
kubectl get pods -l app=nginx
```

---

## 6. Job 控制器

### 基本概念

Job 用于一次性任务，确保任务成功完成。Pod 成功退出后，Job 不会重启 Pod。

---

### 创建 Job

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: pi-job
spec:
  completions: 3      # 需要完成 3 个 Pod
  parallelism: 1     # 并发运行 1 个 Pod
  template:
    metadata:
      labels:
        app: pi
    spec:
      containers:
        - name: pi
          image: perl
          command: ["perl", "-Mbignum=bpi", "-wle", "print bpi(2000)"]
      restartPolicy: Never
```

```bash
# 创建 Job
kubectl create -f job-pi.yaml

# 查看 Job 和 Pod
kubectl get job
kubectl get pods -l app=pi

# 查看 Pod 日志
kubectl logs <pod-name>
```

---

### Job 类型

| 类型 | completions | parallelism | 说明 |
| :--- | :--- | :--- | :--- |
| **非并发 Job** | 1 | 1 | 串行执行，完成 1 个 Pod |
| **固定完成次数** | N | 1 | 串行执行，完成 N 个 Pod |
| **并行 Job** | N | M | 并行执行，最多 M 个 Pod 同时运行 |
| **工作队列** | 不设置 | 不设置 | Pod 自行协调完成 |

---

## 7. CronJob 控制器

### 基本概念

CronJob 用于定时任务，基于 Cron 表达式调度 Job。

---

### 创建 CronJob

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello-cronjob
spec:
  schedule: "*/1 * * * *"  # 每分钟执行一次
  jobTemplate:
    spec:
      completions: 1
      parallelism: 1
      template:
        spec:
          containers:
            - name: hello
              image: busybox
              imagePullPolicy: IfNotPresent
              command:
                - sh
                - -c
                - "date; echo 'Hello from Kubernetes'"
          restartPolicy: OnFailure
```

```bash
# 创建 CronJob
kubectl create -f cronjob-hello.yaml

# 查看 CronJob 和 Job
kubectl get cronjob
kubectl get job

# 等待一分钟后查看
kubectl get pods
```

---

### Cron 表达式格式

```
# ┌───────────── 分钟 (0 - 59)
# │ ┌───────────── 小时 (0 - 23)
# │ │ ┌───────────── 日 (1 - 31)
# │ │ │ ┌───────────── 月 (1 - 12)
# │ │ │ │ ┌───────────── 星期 (0 - 6) (0 = 周日)
# │ │ │ │ │
# │ │ │ │ │
# * * * * *
```

---

### 常用 Cron 表达式

| 表达式 | 含义 |
| :--- | :--- |
| `*/1 * * * *` | 每分钟 |
| `0 */1 * * *` | 每小时 |
| `0 0 * * *` | 每天午夜 |
| `0 0 * * 0` | 每周日午夜 |
| `0 0 1 * *` | 每月 1 号午夜 |
| `0 9-17 * * 1-5` | 工作日 9:00-17:00 每小时 |

---

## 8. 控制器选择指南

| 场景 | 推荐控制器 |
| :--- | :--- |
| **无状态 Web 应用** | Deployment |
| **每个节点运行一个 Pod** | DaemonSet |
| **有状态数据库** | StatefulSet |
| **一次性批处理任务** | Job |
| **定时任务** | CronJob |
| **简单的 Pod 副本管理** | ReplicaSet（通常由 Deployment 管理） |

---

## 9. 常用命令汇总

```bash
# Deployment
kubectl create -f deploy.yaml
kubectl get deploy
kubectl get deploy deploy1 -o yaml
kubectl scale deployment deploy1 --replicas=5
kubectl set image deployment deploy1 nginx=nginx:1.20
kubectl rollout status deployment deploy1
kubectl rollout history deployment deploy1
kubectl rollout undo deployment deploy1
kubectl rollout pause deployment deploy1
kubectl rollout resume deployment deploy1

# ReplicaSet
kubectl get rs
kubectl scale rs nginx-rs --replicas=3

# DaemonSet
kubectl get ds
kubectl get pods -l app=nginx -o wide

# StatefulSet
kubectl get sts
kubectl scale statefulset nginx-sts --replicas=5

# Job
kubectl get job
kubectl get pods -l app=pi

# CronJob
kubectl get cronjob
kubectl get job
```

---

## 10. 最佳实践

1. **使用 Deployment 而非直接使用 ReplicaSet**：Deployment 提供滚动更新和回滚功能
2. **合理设置资源限制**：为每个 Pod 设置 CPU 和内存的 requests 和 limits
3. **配置健康检查**：使用 livenessProbe 和 readinessProbe
4. **使用标签选择器**：通过标签组织和管理资源
5. **监控控制器状态**：定期检查 Deployment、DaemonSet 等的状态
6. **合理设置更新策略**：根据业务需求调整 maxSurge 和 maxUnavailable
7. **有状态应用使用 StatefulSet**：确保稳定的网络标识和持久化存储
8. **定时任务使用 CronJob**：避免手动调度 Job
