# Kubernetes 存储汇总

## 1. 存储概述

### 为什么需要存储

Kubernetes 中的 Pod 是临时的，Pod 重建后数据会丢失。为了持久化数据，需要使用存储卷。

---

### 存储类型

| 类型 | 说明 |
| :--- | :--- |
| **临时存储** | emptyDir、hostPath |
| **网络存储** | NFS、Ceph、GlusterFS |
| **云存储** | AWS EBS、Azure Disk、阿里云云盘 |
| **持久卷** | PV、PVC |

---

## 2. 临时存储

### emptyDir

emptyDir 是一个临时空目录，Pod 创建时创建，Pod 删除时删除。

---

### 使用 emptyDir

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: emptydir-pod
spec:
  volumes:
    - name: cache-volume
      emptyDir:
        sizeLimit: 500Mi  # 限制大小

  containers:
    - name: nginx
      image: nginx:alpine
      volumeMounts:
        - name: cache-volume
          mountPath: /cache
```

```bash
# 创建 Pod
kubectl create -f emptydir-pod.yaml

# 验证
kubectl exec emptydir-pod -- df -h /cache
```

---

### emptyDir 特性

- **生命周期与 Pod 绑定**：Pod 删除后数据丢失
- **容器间共享**：同一 Pod 内的容器可以共享 emptyDir
- **性能**：使用节点本地存储，性能较好
- **适用场景**：缓存、临时文件、容器间共享数据

---

### hostPath

hostPath 将宿主机目录挂载到 Pod 中。

---

### 使用 hostPath

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: hostpath-pod
spec:
  volumes:
    - name: host-volume
      hostPath:
        path: /data/pod-data
        type: DirectoryOrCreate  # 自动创建目录

  containers:
    - name: nginx
      image: nginx:alpine
      volumeMounts:
        - name: host-volume
          mountPath: /usr/share/nginx/html
```

```bash
# 创建 Pod
kubectl create -f hostpath-pod.yaml

# 验证
kubectl exec hostpath-pod -- ls /usr/share/nginx/html
```

---

### hostPath 类型

| 类型 | 说明 |
| :--- | :--- |
| **DirectoryOrCreate** | 目录不存在则创建 |
| **Directory** | 必须已存在的目录 |
| **FileOrCreate** | 文件不存在则创建 |
| **File** | 必须已存在的文件 |
| **Socket** | Unix Socket |
| **CharDevice** | 字符设备 |
| **BlockDevice** | 块设备 |

---

### hostPath 特性

- **持久化**：Pod 删除后数据保留在宿主机
- **节点绑定**：Pod 调度到特定节点
- **安全风险**：可能访问宿主机敏感数据
- **适用场景**：日志收集、监控数据、开发测试

---

## 3. 网络存储

### NFS（Network File System）

NFS 是一种网络文件系统，允许多个节点共享同一存储。

---

### 使用 NFS

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nfs-pod
spec:
  volumes:
    - name: nfs-volume
      nfs:
        server: 10.0.0.10  # NFS 服务器地址
        path: /nfs-volume  # NFS 导出的路径

  containers:
    - name: nginx
      image: nginx:alpine
      volumeMounts:
        - name: nfs-volume
          mountPath: /usr/share/nginx/html
```

```bash
# 创建 Pod
kubectl create -f nfs-pod.yaml

# 验证
kubectl exec nfs-pod -- mount | grep nfs
```

---

### NFS 特性

- **跨节点共享**：多个 Pod 可以同时访问同一 NFS 卷
- **持久化**：数据存储在 NFS 服务器上
- **性能**：受网络带宽影响
- **适用场景**：共享配置、静态资源、日志存储

---

## 4. 持久卷（PersistentVolume）

### PV 与 PVC

- **PersistentVolume（PV）**：集群级别的存储资源，由管理员预先创建
- **PersistentVolumeClaim（PVC）**：命名空间级别的存储请求，由用户创建

---

### PV 生命周期

| 阶段 | 说明 |
| :--- | :--- |
| **Available** | PV 可用，尚未绑定 |
| **Bound** | PV 已绑定到 PVC |
| **Released** | PVC 已删除，但 PV 尚未回收 |
| **Failed** | 自动回收失败 |

---

### PV 回收策略

| 策略 | 说明 |
| :--- | :--- |
| **Retain** | 保留数据，需要手动清理 |
| **Delete** | 删除 PV 和底层存储 |
| **Recycle** | 清空数据（已废弃） |

---

## 5. 创建 PV

### NFS PV 示例

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: nfs-pv
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany  # 读写多节点
  persistentVolumeReclaimPolicy: Retain
  storageClassName: nfs-storage
  nfs:
    path: /nfs-volume/mysql/
    server: 10.0.0.10
```

```bash
# 创建 PV
kubectl create -f pv-nfs.yaml

# 查看 PV
kubectl get pv

# 查看 PV 详情
kubectl describe pv nfs-pv
```

---

### PV 访问模式

| 模式 | 说明 |
| :--- | :--- |
| **ReadWriteOnce** | 单节点读写（RWO） |
| **ReadOnlyMany** | 多节点只读（ROX） |
| **ReadWriteMany** | 多节点读写（RWX） |
| **ReadWriteOncePod** | 单 Pod 读写（RWOP） |

---

## 6. 创建 PVC

### PVC 示例

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
  namespace: default
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: nfs-storage
```

```bash
# 创建 PVC
kubectl create -f pvc-nfs.yaml

# 查看 PVC
kubectl get pvc

# 查看 PVC 详情
kubectl describe pvc nfs-pvc
```

---

### PVC 绑定 PV

PVC 会自动匹配满足条件的 PV：

- 容量 >= PVC 请求的容量
- 访问模式匹配
- StorageClass 匹配

---

## 7. 使用 PVC

### Pod 使用 PVC

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
spec:
  volumes:
    - name: mysql-storage
      persistentVolumeClaim:
        claimName: nfs-pvc

  containers:
    - name: mysql
      image: mysql:5.7
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: "123456"
      volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
```

```bash
# 创建 Pod
kubectl create -f mysql-pod.yaml

# 验证
kubectl exec mysql-pod -- df -h /var/lib/mysql
```

---

## 8. StorageClass

### 什么是 StorageClass

StorageClass 定义存储的"类型"，支持动态创建 PV。

---

### 创建 StorageClass

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
provisioner: nfs-client  # NFS 动态供应器
parameters:
  archiveOnDelete: "false"
reclaimPolicy: Retain
volumeBindingMode: Immediate
```

```bash
# 创建 StorageClass
kubectl create -f sc-nfs.yaml

# 查看 StorageClass
kubectl get sc

# 设置默认 StorageClass
kubectl patch storageclass nfs-storage -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
```

---

### 动态创建 PV

使用 StorageClass 后，PVC 会自动创建 PV：

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dynamic-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: nfs-storage  # 指定 StorageClass
```

---

## 9. StatefulSet 与 PVC

### StatefulSet 持久化存储

StatefulSet 支持为每个 Pod 创建独立的 PVC。

---

### StatefulSet PVC 模板

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  clusterIP: None
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nginx-sts
spec:
  serviceName: nginx-svc
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
        - name: nginx
          image: nginx:alpine
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-storage
              mountPath: /usr/share/nginx/html
  volumeClaimTemplates:  # PVC 模板
    - metadata:
        name: nginx-storage
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
        storageClassName: nfs-storage
```

```bash
# 创建 StatefulSet
kubectl create -f sts-pvc.yaml

# 查看 PVC（自动创建）
kubectl get pvc

# 注意 PVC 名称的有序性
# nginx-storage-nginx-sts-0
# nginx-storage-nginx-sts-1
# nginx-storage-nginx-sts-2
```

---

## 10. 存储最佳实践

### 选择存储类型

| 场景 | 推荐类型 |
| :--- | :--- |
| **临时缓存** | emptyDir |
| **日志收集** | hostPath 或 NFS |
| **共享配置** | NFS 或 ConfigMap |
| **数据库** | PV/PVC + 高性能存储 |
| **有状态应用** | StatefulSet + PVC 模板 |

---

### 存储安全

1. **限制 hostPath 使用**：避免在生产环境使用 hostPath
2. **设置资源限制**：为 emptyDir 设置 sizeLimit
3. **使用 RBAC**：限制对 PV/PVC 的访问
4. **加密敏感数据**：使用加密存储或 Secret

---

### 性能优化

1. **选择合适的存储类型**：数据库使用高性能存储（SSD）
2. **使用本地存储**：对性能要求高的应用使用 Local PV
3. **调整 IOPS**：根据应用需求调整存储 IOPS
4. **监控存储使用**：定期检查存储使用情况

---

## 11. 常用命令汇总

```bash
# 查看 PV
kubectl get pv
kubectl describe pv <name>
kubectl delete pv <name>

# 查看 PVC
kubectl get pvc
kubectl describe pvc <name>
kubectl delete pvc <name>

# 查看 StorageClass
kubectl get sc
kubectl describe sc <name>

# 查看 Pod 挂载的卷
kubectl get pod <name> -o yaml | grep -A10 volumes:

# 查看 Pod 内挂载点
kubectl exec <pod> -- df -h
kubectl exec <pod> -- mount
```

---

## 12. 故障排查

### PVC 无法绑定 PV

```bash
# 1. 检查 PVC 状态
kubectl get pvc

# 2. 检查是否有可用的 PV
kubectl get pv

# 3. 检查 PV 和 PVC 的匹配条件
kubectl describe pvc <name>
kubectl describe pv <name>

# 4. 检查访问模式是否匹配
kubectl get pv -o wide
```

---

### Pod 无法挂载卷

```bash
# 1. 检查 Pod 状态
kubectl get pods

# 2. 查看 Pod 事件
kubectl describe pod <name>

# 3. 检查卷是否可用
kubectl exec <pod> -- df -h

# 4. 检查 NFS 服务器
showmount -e <nfs-server>
```

---

## 13. 总结

### 存储关键要点

1. **Pod 是临时的**，需要持久化存储
2. **emptyDir** 用于临时数据
3. **hostPath** 用于开发测试和日志收集
4. **NFS** 用于共享存储
5. **PV/PVC** 用于持久化存储
6. **StorageClass** 支持动态创建 PV
7. **StatefulSet** 支持独立的 PVC

---

### 存储选择指南

| 需求 | 推荐方案 |
| :--- | :--- |
| **临时缓存** | emptyDir |
| **容器间共享** | emptyDir |
| **日志收集** | hostPath 或 NFS |
| **共享配置** | ConfigMap 或 NFS |
| **数据库** | PV/PVC + 高性能存储 |
| **有状态应用** | StatefulSet + PVC |
| **云环境** | 云厂商提供的存储类 |
