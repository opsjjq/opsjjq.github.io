## 一、数据备份方案概述

### 定时备份的局限性

- **周期性问题**：无法实现一分钟以内的数据同步
- **数据丢失风险**：新增或修改的数据可能在下次备份前丢失

### 实时复制的必要性

- **重要数据保护**：适合用户提交的数据备份（jpg、tar、zip、MP4、txt、html等）
- **高时效性要求**：实现秒级数据同步
- **企业级应用**：配合NFS解决单点故障，提供数据冗余

------

## 二、实时同步架构图解

### 1. 传统备份方式

```text
应用服务器 → 定时任务 → 备份服务器
（存在时间窗口，可能丢失数据）
```

### 2. Rsync + Inotify 实时同步

```text
应用服务器 → Inotify 监控 → 实时触发 → Rsync 同步 → 备份服务器
（事件驱动，实时同步）
```

### 3. NFS + 实时同步（推荐架构）

```text
Web 集群 → NFS 共享存储 → 实时同步 → 备份服务器
├── 解决 NFS 单点故障
├── 提供数据冗余
└── 实现高可用性
```



------

## 三、实时同步核心工具对比

| 工具              | 依赖程序 | 部署难度           | 性能表现                 | 适用场景   |
| :---------------- | :------- | :----------------- | :----------------------- | :--------- |
| **Inotify-tools** | Rsync    | 中等（需编写脚本） | 低（大量文件时性能下降） | 小规模环境 |
| **Sersync**       | Rsync    | 中等               | 中等                     | 中等规模   |
| **Lsyncd**        | Rsync    | 简单               | 高（推荐）               | 生产环境   |

------

## 四、Inotify-tools + Rsync 实战部署

### 环境准备

```text
拓扑：Client（nfs-31） → Rsync 推送 → Server（backup-41）
```

### 1. Rsync服务端配置（Backup服务器）

```sh
#!/bin/bash
# install_rsync.sh - Rsync服务端快速部署脚本

# 1. 安装rsync
yum install rsync -y

# 2. 创建配置文件
cat > /etc/rsyncd.conf <<EOF
uid = www
gid = www
port = 873
fake super = yes
use chroot = no
max connections = 200
timeout = 600
ignore errors
read only = false
list = false
auth users = rsync_backup
secrets file = /etc/rsync.passwd
log file = /var/log/rsyncd.log

[backup]
comment = backup directory
path = /backup
EOF

# 3. 创建用户和目录
useradd -u 1000 -M -s /sbin/nologin www 
mkdir -p /backup
chown -R www:www /backup

# 4. 设置认证密码
echo "rsync_backup:qwe123" > /etc/rsync.passwd
chmod 600 /etc/rsync.passwd

# 5. 启动服务
systemctl restart rsyncd
systemctl enable rsyncd
```

### 2. Rsync客户端测试（Dev服务器）

```sh
# 设置环境变量（避免交互输入密码）
echo 'export RSYNC_PASSWORD=qwe123' >> /etc/profile
source /etc/profile

# 测试同步
rsync -avzp /opt --delete rsync_backup@172.16.1.41::backup
```

------

## 五、Inotify-tools 详细使用

### 1. 内核检查与优化

```sh
# 检查内核支持
uname -r  # 需≥2.6.13

# Inotify内核参数优化
ls -l /proc/sys/fs/inotify/
# max_user_watches：单进程监控文件数（默认8192）
# max_user_instances：单用户进程数（默认128）
# max_queued_events：事件队列长度（默认16384）
```

### 2. 安装与基本使用

```sh
# 安装
yum install inotify-tools -y

# 查看安装的命令
rpm -ql inotify-tools | head -2
# /usr/bin/inotifywait    # 监控事件
# /usr/bin/inotifywatch   # 统计事件
```

### 3. Inotifywait 命令详解

```sh
# 基本语法
inotifywait -mrq --timefmt '%T' --format "%T %w %f 事件: %e" /监控目录

# 常用参数
-m     # 持续监控（不退出）
-r     # 递归监控子目录
-q     # 安静模式（减少输出）
-e     # 指定监控事件
--timefmt  # 时间格式
--format   # 输出格式
```

### 4. 监控事件类型

| 事件            | 含义            | 常用性 |
| :-------------- | :-------------- | :----- |
| **create**      | 文件/目录创建   | ★★★★★  |
| **delete**      | 文件/目录删除   | ★★★★★  |
| **modify**      | 文件内容修改    | ★★★★☆  |
| **close_write** | 关闭可写文件    | ★★★★☆  |
| **move**        | 文件移动/重命名 | ★★★☆☆  |
| **attrib**      | 属性变化        | ★★☆☆☆  |

### 5. 实践示例

```sh
# 监控创建和删除事件
inotifywait -mrq -e create,delete /nfs-data

# 监控移动事件
inotifywait -mrq -e move /nfs-data

# 监控文件写入完成（最常用）
inotifywait -mrq -e close_write /nfs-data

# 完整格式监控
inotifywait -mrq --timefmt '%Y-%m-%d %H:%M:%S' \
  --format '%T %w %f 事件: %e' \
  -e create,delete,modify,close_write /nfs-data
```

------

## 六、Inotify + Rsync 实时同步脚本

### 基础监控脚本

```bash
#!/bin/bash
# monitor_sync.sh - 实时监控并同步

# 监控目录
MON_DIR="/nfs-data"
# 备份目标
BACKUP_DEST="rsync_backup@172.16.1.41::backup"

# 设置密码（避免交互）
export RSYNC_PASSWORD="qwe123"

# 开始监控
inotifywait -mrq --format '%w%f %e' -e create,delete,close_write $MON_DIR | \
while read file event
do
    echo "$(date +'%Y-%m-%d %H:%M:%S') 检测到: $file $event"
    
    # 执行同步
    rsync -az --delete $MON_DIR/ $BACKUP_DEST
    
    echo "$(date +'%Y-%m-%d %H:%M:%S') 同步完成"
done
```

------

## 七、企业级工具：Lsyncd

### 1. Lsyncd 优势

- **性能优化**：解决海量文件同步的性能问题
- **延迟聚合**：避免频繁触发rsync
- **配置简单**：使用Lua配置语言
- **生产验证**：广泛应用于企业环境

### 2. 安装配置

```bash
# 安装
yum install lsyncd -y

# 配置文件 /etc/lsyncd.conf
settings {
    logfile      = "/var/log/lsyncd/lsyncd.log",
    statusFile   = "/var/log/lsyncd/lsyncd.status",
    inotifyMode  = "CloseWrite",  # 监控文件关闭写入事件
    maxProcesses = 8              # 最大并发进程
}

sync {
    default.rsync,
    source    = "/nfs-data",      # 监控源目录
    target    = "rsync_backup@172.16.1.41::backup",  # 目标
    delete    = true,             # 同步删除
    exclude   = {".*"},           # 排除隐藏文件
    delay     = 1,                # 延迟1秒聚合事件
    rsync     = {
        binary        = "/usr/bin/rsync",
        archive       = true,     # 归档模式
        compress      = true,     # 压缩传输
        verbose       = true,     # 显示详细信息
        password_file = "/etc/rsync.pwd",  # 密码文件
        _extra        = {"--bwlimit=200"}  # 带宽限制200KB/s
    }
}

# 创建密码文件
echo 'qwe123' > /etc/rsync.pwd
chmod 600 /etc/rsync.pwd

# 启动服务
systemctl start lsyncd
systemctl enable lsyncd
```



### 3. 测试验证

```bash
# 批量生成测试文件
for i in {1..100}; do
    echo "test $i" > /nfs-data/test_$i.log
    sleep 0.1
done

# 查看同步日志
tail -f /var/log/lsyncd/lsyncd.log
```

------

## 八、故障排查与优化建议

### 1. 常见问题

- **多工具冲突**：确保只运行一个同步工具
- **权限问题**：检查NFS目录和rsync用户权限
- **网络限制**：配置适当的带宽限制
- **内核参数**：根据文件数量调整inotify参数

### 2. 进程管理

```sh
# 检查运行中的同步进程
ps -ef | grep -E '(inotify|sersync|lsyncd)'

# 停止所有同步进程
pkill -9 inotifywait
pkill -9 sersync2
systemctl stop lsyncd
```

### 3. 性能优化

```sh
# 调整内核参数（生产环境建议）
echo "fs.inotify.max_user_watches = 100000" >> /etc/sysctl.conf
echo "fs.inotify.max_user_instances = 1024" >> /etc/sysctl.conf
sysctl -p
```

------

## 九、方案选择建议

### 根据场景选择：

1. **小规模测试**：Inotify-tools + Shell脚本
2. **中等规模**：Sersync（已停止维护，谨慎使用）
3. **生产环境**：**Lsyncd**（推荐）
4. **超大规模**：分布式文件系统（FastDFS、GlusterFS）

### 最佳实践组合：

```
Web集群 → NFS共享存储 → Lsyncd实时同步 → 备份服务器
                    ↓
            定时全量备份（每周）
                    ↓
            异地容灾备份
```
