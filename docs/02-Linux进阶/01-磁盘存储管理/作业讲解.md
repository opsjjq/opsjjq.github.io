## 一、磁盘管理流程图解

**磁盘管理完整流程**：

![image-20260207143138320](./assets/image-20260207143138320.png)



## 二、机械硬盘的五个主要组成部分

| 组件         | 作用               | 图示说明               |
| :----------- | :----------------- | :--------------------- |
| **机械臂**   | 移动磁头到指定磁道 | 控制磁头定位           |
| **磁头**     | 读写数据           | 悬浮在盘片上方进行读写 |
| **盘片**     | 存储数据介质       | 表面涂有磁性材料       |
| **主轴马达** | 带动盘片高速旋转   | 转速决定读写速度       |
| **硬盘接口** | 连接主板与硬盘     | SATA/SCSI/NVMe等       |

**盘片结构详解**：

- **磁头**：每个盘片上下各1个，共2个磁头
- **磁道**：从外圈到内圈编号0、1、2...
- **柱面**：所有盘片相同位置的磁道集合
- **扇区**：最小存储单位（512字节）
- **块**：多个连续扇区（通常8个=4KB）

## 三、磁盘接口类型（五种）

| 接口类型     | 特点                    | 适用场景           |
| :----------- | :---------------------- | :----------------- |
| **SATA**     | 主流家用接口，6Gbps速率 | 台式机、笔记本硬盘 |
| **M.2 NVMe** | PCIe通道，速度极快      | 高性能SSD          |
| **mSATA**    | 迷你版SATA              | 超薄设备           |
| **SAS**      | 服务器专用，稳定性高    | 企业级存储         |
| **PCIe**     | 直接连接PCIe总线        | 高性能存储卡       |

## 四、磁盘分区表类型对比

| 特性           | MBR                    | GPT            |
| :------------- | :--------------------- | :------------- |
| **最大容量**   | 2TB                    | 理论无限       |
| **分区数量**   | 4个主分区（或3主+1扩） | 128个主分区    |
| **分区表大小** | 固定                   | 动态可调       |
| **兼容性**     | 所有系统支持           | 较新系统和UEFI |
| **管理命令**   | fdisk                  | gdisk          |
| **引导方式**   | BIOS                   | UEFI           |

## 五、系统分区类型

| 分区类型     | 特点                       | 用途                      |
| :----------- | :------------------------- | :------------------------ |
| **主分区**   | 直接存储数据，系统启动必需 | 安装操作系统、/boot分区   |
| **扩展分区** | 不能直接使用，需再划分     | 容器，用于创建逻辑分区    |
| **逻辑分区** | 在扩展分区内创建           | 数据存储（/home、/var等） |

**MBR分区编号规则**：

- sda1-sda4：主分区或扩展分区
- sda5+：逻辑分区

## 六、Linux分区命名规则

### 1. 按硬盘类型命名

- **IDE接口**：`/dev/hda`, `/dev/hdb`
- **SCSI/SATA/SAS**：`/dev/sda`, `/dev/sdb`
- **NVMe**：`/dev/nvme0n1`, `/dev/nvme0n2`
- **虚拟磁盘**：`/dev/vda`, `/dev/vdb`

### 2. 按分区编号

- 主分区：1-4（如`sda1`, `sda2`）
- 逻辑分区：5+（如`sda5`, `sda6`）

## 七、分区含义解释

**MBR分区表下**：

- `/dev/sda1`：第一块硬盘的第一个主分区
- `/dev/sdb2`：第二块硬盘的第二个主分区
- `/dev/sdc6`：第三块硬盘的第二个逻辑分区

**编号规则**：

- 1,2,3,4：主分区或扩展分区
- 5,6,7...：逻辑分区

## 八、分区方案实践

### 方案1：四个主分区

```sh
# 1. 查看磁盘
lsblk

# 2. 使用 fdisk 分区
fdisk /dev/sdc
# 依次创建 4 个主分区，每个 2G

# 3. 查看结果
lsblk /dev/sdc
```

结果：sdc1、sdc2、sdc3、sdc4各2G

### 方案2：三主一扩

```
fdisk /dev/sdc
# 创建3个主分区各1G
# 创建扩展分区（剩余容量）
# 在扩展分区内创建逻辑分区（全部容量）
```



结果：sdc1、sdc2、sdc3各1G，sdc4扩展分区，sdc5逻辑分区（剩余容量）

### 方案3：两主两逻

```
fdisk /dev/sdc
# 创建2个主分区各2G
# 创建扩展分区（剩余容量）
# 创建2个逻辑分区
```

结果：sdc1、sdc2各2G，sdc3扩展分区，sdc5、sdc6逻辑分区

## 九、fdisk命令详解

| 命令 | 含义         | 说明              |
| :--- | :----------- | :---------------- |
| `m`  | 显示帮助菜单 | 列出所有可用命令  |
| `n`  | 新建分区     | 创建新分区        |
| `d`  | 删除分区     | 删除指定分区      |
| `p`  | 打印分区表   | 显示当前分区信息  |
| `t`  | 修改分区类型 | 更改分区ID        |
| `w`  | 保存并退出   | 写入分区表        |
| `q`  | 不保存退出   | 放弃修改          |
| `a`  | 切换启动标志 | 设置/取消启动分区 |
| `l`  | 列出分区类型 | 显示支持的分区ID  |
| `v`  | 验证分区表   | 检查分区表一致性  |
| `u`  | 切换单位     | 扇区/柱面显示切换 |

## 十、4TB硬盘分区方案

**步骤**：

```
# 1. 使用gdisk创建GPT分区表
gdisk /dev/sdc

# 2. 创建分区
# 在gdisk中按n创建新分区
# 选择默认起始扇区
# 输入+4T或直接回车使用全部空间

# 3. 保存并退出
# 按w写入

# 4. 格式化为ext4
mkfs.ext4 /dev/sdc1

# 5. 查看结果
lsblk /dev/sdc
```



## 十一、重读分区表命令

**方法1：partx**

```
# 查看分区信息
partx /dev/sdc

# 添加所有新分区
partx -a -v /dev/sdc

# 显示详细信息
partx --show /dev/sdc
```



**方法2：partprobe**

```
# 通知系统分区表变化
partprobe /dev/sdc

# 或通知所有设备
partprobe
```



**区别**：

- `partx`：更精细控制，可指定操作
- `partprobe`：更通用，自动处理

## 十二、分区表类型转换

**使用parted命令**：

```
# 进入parted交互模式
parted /dev/sdc

# 查看当前类型
print

# MBR转GPT
mktable gpt
# 或
mklabel gpt

# GPT转MBR
mktable msdos
# 或
mklabel msdos

# 确认转换
yes

# 退出
quit
```



**注意**：转换会清除所有分区数据！

## 十三、查看分区表信息

**方法对比**：

```
# 1. lsblk（推荐）
lsblk /dev/sdb
lsblk -f /dev/sdb  # 显示文件系统

# 2. fdisk
fdisk -l /dev/sdb
# 或交互式查看
fdisk /dev/sdb -> p

# 3. parted
parted /dev/sdb print

# 4. partx
partx /dev/sdb
partx -l /dev/sdb
```

## 十四、主流文件系统对比

| 系统        | 文件系统 | 特点                                 |
| :---------- | :------- | :----------------------------------- |
| **Windows** | NTFS     | 支持加密、压缩、权限控制，支持大文件 |
|             | exFAT    | 跨平台（Win/Mac），适合闪存设备      |
| **Linux**   | Ext4     | 稳定可靠，支持日志，CentOS 6默认     |
|             | XFS      | 高性能，支持大容量，CentOS 7+默认    |
| **macOS**   | APFS     | Apple专用，优化闪存性能              |
|             | HFS+     | 旧版Mac系统使用                      |

**兼容性矩阵**：

| 系统    | NTFS | exFAT | Ext4   | XFS    | APFS   |
| :------ | :--- | :---- | :----- | :----- | :----- |
| Windows | ✓    | ✓     | 需软件 | 需软件 | ✗      |
| Linux   | ✓    | ✓     | ✓      | ✓      | 需软件 |
| macOS   | 只读 | ✓     | 需软件 | 需软件 | ✓      |

## 十五、硬盘防护要点

**机械硬盘**：

1. **怕震动**：运行时避免移动
2. **怕高温**：保持良好散热
3. **怕灰尘**：保持清洁环境
4. **怕突然断电**：可能导致磁头损坏

**固态硬盘**：

1. **怕突然断电**：可能损坏正在写入的数据
2. **怕写入过量**：有写入寿命限制
3. **怕高温**：影响性能和寿命
4. **需要TRIM支持**：保持性能

## 十六、设备表示含义

**通用规则**：

- `/dev/sda`：第一块SATA/SCSI硬盘
- `/dev/sdb`：第二块SATA/SCSI硬盘
- `/dev/sdc`：第三块SATA/SCSI硬盘

**MBR分区表**：

- `/dev/sda1`：第一个主分区
- `/dev/sda2`：第二个主分区
- `/dev/sda5`：第一个逻辑分区

**GPT分区表**：

- `/dev/sda1`：第一个分区
- `/dev/sda2`：第二个分区
- ...最多128个

## 十七、综合分区实践

### 任务分解：

```
# 1. MBR分区：3主2逻
fdisk /dev/sdc
# 创建3个1G主分区
# 创建扩展分区（剩余）
# 创建2个逻辑分区（2G和剩余）

# 2. 删除MBR，创建GPT
parted /dev/sdc mktable gpt
gdisk /dev/sdc
# 创建3个分区

# 3. 删除GPT，创建XFS
parted /dev/sdc mktable msdos
fdisk /dev/sdc
# 创建2个分区
mkfs.xfs /dev/sdc1
mkfs.xfs /dev/sdc2

# 4. 整盘格式化
mkfs.xfs -f /dev/sdc

# 5. 挂载到/data
mount /dev/sdc /data

# 6. 自动挂载配置
blkid /dev/sdc  # 获取UUID
echo "UUID=$(blkid -s UUID -o value /dev/sdc) /data xfs defaults 0 0" >> /etc/fstab

# 验证
mount -a
df -h
```

## 十八、mount挂载原理图解

**挂载概念**：

```
物理磁盘 (/dev/sdb1)
     ↓
文件系统 (ext4/xfs)
     ↓
挂载点 (/data目录)
     ↓
用户访问 (/data/files)
```



**挂载效果**：

```
挂载前：
/opt/今天天气不错.log  → 存储在/dev/sda

挂载后：
mount /dev/sdb1 /data
/data/明天天气不知道咋样 → 存储在/dev/sdb1

本质：将物理存储映射到目录树
```

## 十九、gdisk命令详解

| 命令 | 含义         | 说明               |
| :--- | :----------- | :----------------- |
| `b`  | 备份GPT数据  | 备份分区表到文件   |
| `c`  | 更改分区名称 | 为分区设置标签     |
| `d`  | 删除分区     | 删除指定分区       |
| `i`  | 显示详细信息 | 显示分区详细信息   |
| `l`  | 列出分区类型 | 显示支持的类型代码 |
| `n`  | 新建分区     | 创建新分区         |
| `o`  | 创建空GPT    | 清空并创建新GPT    |
| `p`  | 打印分区表   | 显示当前分区信息   |
| `q`  | 退出不保存   | 放弃所有修改       |
| `r`  | 恢复选项     | 专家功能，数据恢复 |
| `s`  | 排序分区     | 按起始位置排序     |
| `t`  | 更改类型代码 | 修改分区类型       |
| `v`  | 验证磁盘     | 检查GPT完整性      |
| `w`  | 保存并退出   | 写入分区表         |
| `x`  | 专家功能     | 高级选项           |
| `?`  | 显示帮助     | 显示命令列表       |

## 二十、整盘格式化技巧

**直接格式化整盘**：

```
# 不分区，直接格式化整块磁盘
mkfs.xfs -f /dev/sdc

# 查看结果
blkid /dev/sdc

# 直接挂载使用
mount /dev/sdc /data
```

**优势**：

- 简化管理
- 避免分区表开销
- 适合单一用途磁盘

## 二十一、查看UUID方法

**blkid命令详解**：

```
# 查看所有设备UUID
blkid

# 查看指定设备
blkid /dev/sdc1

# 仅显示UUID
blkid -s UUID /dev/sdc1
blkid -s UUID -o value /dev/sdc1

# 查看文件系统类型
blkid -s TYPE /dev/sdc1

# 查看所有信息
blkid -p /dev/sdc1

# 示例输出：
# /dev/sdc1: UUID="7a813e49-937b-4900-96b8-434915f39b19" TYPE="xfs"
```



## 二十二、umount busy问题解决

**情况分析**：

```
# 报错示例
umount /data
# umount: /data: target is busy.
```

**解决方案**：

### 方法1：离开挂载目录

```
cd /  # 离开/data目录
umount /data
```

### 方法2：查找占用进程

```
# 使用lsof查找
lsof /data
lsof | grep /data

# 或使用fuser
fuser -m /data
fuser -vm /data

# 杀死占用进程
fuser -km /data  # 强制终止
```

### 方法3：延迟卸载

```
umount -l /data  # lazy卸载
```

### 方法4：检查子挂载

```
# 查看是否有嵌套挂载
mount | grep /data

# 先卸载子挂载
umount /data/subdir
umount /data
```

**排查流程**：

1. 检查是否在当前目录
2. 查找占用进程
3. 检查嵌套挂载
4. 考虑延迟卸载

## 二十三、磁盘使用率查看

**df命令详解**：

```
# 基本查看
df

# 友好单位显示
df -h

# 显示文件系统类型
df -Th

# 仅显示指定文件系统
df -h -t xfs
df -h -t ext4

# 排除特定类型
df -h -x tmpfs

# 显示inode使用情况
df -i
df -hi

# 按使用率排序
df -h | sort -k5 -rh

# 常用组合
df -hT --total  # 显示总计
```

## 二十四、/etc/fstab配置详解

**配置格式**：

```
<设备标识> <挂载点> <文件系统> <挂载选项> <dump备份> <fsck检查>
```

**示例配置**：

```
# 方式1：设备名（不推荐）
/dev/sdc /data xfs defaults 0 0

# 方式2：UUID（推荐）
UUID=7a813e49-937b-4900-96b8-434915f39b19 /data xfs defaults 0 0

# 方式3：磁盘标签
LABEL=DataDisk /data xfs defaults 0 0
```

**参数说明**：

1. **设备标识**：UUID、设备名、标签
2. **挂载点**：必须存在的目录
3. **文件系统**：ext4、xfs、nfs等
4. **挂载选项**：defaults、noatime、nodiratime等
5. **dump备份**：0=不备份，1=备份
6. **fsck检查**：0=不检查，1=优先检查，2=次优检查

**验证配置**：

```
# 测试fstab配置
mount -a

# 查看挂载
df -hT

# 检查fstab语法
mount -fav
```

## 二十五、生成大文件方法

**dd命令使用**：

```
# 生成5G文件
dd if=/dev/zero of=/opt/5G.txt bs=1M count=5120

# 简化写法（5G=5*1024M）
dd if=/dev/zero of=/opt/5G.txt bs=100M count=50

# 显示进度
dd if=/dev/zero of=/opt/5G.txt bs=1M count=5120 status=progress

# 指定块大小优化
dd if=/dev/zero of=/opt/5G.txt bs=4K count=1310720

# 使用稀疏文件（快速创建）
fallocate -l 5G /opt/5G.txt
truncate -s 5G /opt/5G.txt
```

**参数说明**：

- `if`：输入文件（/dev/zero生成空字符）
- `of`：输出文件
- `bs`：块大小
- `count`：块数量
- `status=progress`：显示进度

## 二十六、Linux特殊设备文件

| 设备文件         | 作用             | 示例                                      |
| :--------------- | :--------------- | :---------------------------------------- |
| **/dev/null**    | 数据黑洞         | `command > /dev/null 2>&1`                |
| **/dev/zero**    | 零字符源         | `dd if=/dev/zero of=file bs=1M count=100` |
| **/dev/random**  | 真随机数         | 用于密钥生成                              |
| **/dev/urandom** | 伪随机数         | 速度更快，足够安全                        |
| **/dev/full**    | 总返回磁盘满错误 | 测试程序错误处理                          |

**安全应用**：

```
# 1. 安全擦除文件
dd if=/dev/urandom of=file_to_wipe bs=1M
shred -v file_to_wipe

# 2. 生成随机密码
tr -dc A-Za-z0-9 </dev/urandom | head -c 32

# 3. 测试磁盘性能
dd if=/dev/zero of=/tmp/test.img bs=1G count=1 oflag=dsync

# 4. 静默运行程序
./script.sh > /dev/null 2>&1 &
```



## 二十七、重要提示

### 工作实践建议：

1. **优先使用UUID**：避免设备名变化导致挂载失败
2. **测试fstab配置**：使用`mount -a`测试后再重启
3. **备份重要数据**：分区操作前务必备份
4. **使用LVM**：生产环境推荐使用LVM管理磁盘
5. **监控磁盘空间**：设置告警，避免磁盘写满

### 故障处理流程：

1. 磁盘空间不足 → 清理文件或扩容
2. 挂载失败 → 检查fstab语法、UUID、文件系统
3. 性能问题 → 优化挂载选项、考虑SSD
4. 数据损坏 → 使用fsck检查修复

### 面试重点：

1. 理解inode和block概念
2. 掌握fdisk/gdisk分区操作
3. 熟悉文件系统特点
4. 理解挂载原理
5. 掌握故障排查方法
