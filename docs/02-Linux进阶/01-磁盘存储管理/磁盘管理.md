# 磁盘管理

## 网站架构与存储

数据存储是网站架构中的重点之一。在设计存储方案时，需从硬件与软件两个角度综合考虑。

### 硬件角度

- **存储读写性能**：选择固态硬盘（SSD）还是机械硬盘（HDD）。
- **数据备份与安全性**：使用RAID磁盘阵列技术提高数据冗余与可靠性。
- **数据扩容与容量管理**：合理规划磁盘容量，避免磁盘写满，并制定应对策略。

### 软件角度

- **系统对存储的优化参数**：如文件系统配置、I/O调度策略等。
- **数据库类软件的优化参数**：如MySQL的InnoDB配置、缓存策略等。

------

## 磁盘管理业务背景

随着数据量不断增长，现有磁盘空间已接近极限。需要新增一块磁盘，将数据迁移至新硬盘，并采用逻辑卷管理（LVM）以支持未来动态扩容。

------

## 磁盘维护业务流程

1. **数据迁移**：在保证数据库数据完整性的前提下，将用户数据迁移至新硬盘。
2. **逻辑卷管理**：新硬盘采用LVM管理，便于未来动态扩容，应对数据持续增长。

------

## Windows下的磁盘使用流程

### 硬盘是什么

硬盘是计算机中用于持久化存储数据的设备，主流分为机械硬盘（HDD）和固态硬盘（SSD）。与内存不同，硬盘中的数据在关机后仍会保留。硬盘也称为磁盘，因其存储数据与电磁相关，机械硬盘内部由多个盘片组成。

**定义**：
硬盘（Hard Disk Drive, HDD）是利用磁记录技术存储和读取数据的主要存储设备。

**内部结构**：

- **盘片**：存储数据的圆形磁性介质。
- **磁头**：读写数据的部件，悬浮于盘片上方。
- **电机与控制电路**：驱动盘片旋转并协调读写操作。

**接口类型**：

- IDE（ATA）：早期接口，已逐渐淘汰。
- SATA：当前主流接口，传输速度快。
- SCSI：用于服务器和高性能工作站。

**性能指标**：

- 存储容量（GB/TB）
- 读写速度（MB/s）
- 转速（RPM，仅机械硬盘）

**分类**：

- 机械硬盘（HDD）：容量大、价格低，适合大容量存储。
- 固态硬盘（SSD）：速度快、无机械部件，适合系统与高速应用。

------

## 磁盘使用流程（Linux）

磁盘从接入到可用需经过以下步骤：

1. 磁盘接入并被系统识别。
2. 对磁盘进行分区。
3. 格式化分区并创建文件系统。
4. 挂载分区到目录，方可存储数据。

------

## 磁盘结构

机械硬盘主要由以下五部分组成：

- 机械臂
- 主轴轴承马达
- 磁盘（盘片）
- 磁头
- 硬盘接口

------

## 磁盘内部原理

- **扇区（Sector）**：最小物理存储单位，通常为512字节。
- **块（Block）**：多个连续扇区组成，是文件系统读写的最小单位（Linux中通常为4KB）。

操作系统以块为单位进行I/O操作，提高管理效率与读写性能。

------

## 磁盘原理名词

- **磁头数**：每个盘片对应上下两个磁头。
- **磁道**：盘片上的同心圆轨道。
- **柱面**：所有盘片上相同位置的磁道组成的柱状区域。
- **扇区数**：每个磁道划分的扇形区域，通常为512字节。
- **圆盘数**：硬盘内盘片的数量。

**块是操作系统为提高效率而虚拟的概念**，并非物理结构。

------

## 磁盘分区类型：MBR vs GPT

| 特性         | MBR                        | GPT                 |
| :----------- | :------------------------- | :------------------ |
| 最大支持容量 | 约2TB                      | 远大于2TB           |
| 分区数量     | 最多4个主分区（或3主+1扩） | 支持最多128个主分区 |
| 分区表大小   | 固定                       | 动态可调            |
| 兼容性       | 所有系统支持               | 较新系统和UEFI支持  |

------

## Linux磁盘命名规则

| 设备类型      | 命名规则  | 示例           |
| :------------ | :-------- | :------------- |
| SATA/SCSI/USB | `sdX`     | `/dev/sda`     |
| IDE           | `hdX`     | `/dev/hda`     |
| NVMe          | `nvmeXnY` | `/dev/nvme0n1` |
| RAID阵列      | `mdX`     | `/dev/md0`     |
| 虚拟磁盘      | `vdX`     | `/dev/vda`     |
| 光驱          | `srX`     | `/dev/sr0`     |

**分区命名**：

- 主分区与扩展分区：`sdX1`~`sdX4`
- 逻辑分区：从`sdX5`开始

建议使用UUID或磁盘标签进行挂载，避免设备名变动导致的问题。

------

## 磁盘分区工具

### fdisk

适用于MBR分区表，常用命令：

```sh
fdisk -l          # 查看分区表
fdisk /dev/sdb    # 对新硬盘分区
```



### gdisk

适用于GPT分区表，操作类似fdisk。

### parted

支持MBR与GPT，可用于转换分区表类型：

```sh
parted /dev/sdb
mklabel gpt       # 转换为GPT
mklabel msdos     # 转换为MBR
```



------

## Linux挂载分区

挂载是将分区连接到目录（挂载点）的过程：

```sh
mount /dev/sdc1 /mnt/data
```



**挂载注意事项**：

1. 一个目录同一时间只能被一个设备挂载。
2. 一个设备可挂载到多个目录。
3. 若目录被多个设备挂载，仅显示最后一个设备的数据。
4. 建议使用空目录作为挂载点，避免原有数据被覆盖。

------

## 主流文件系统介绍

| 系统    | 常见文件系统             |
| :------ | :----------------------- |
| Windows | FAT32、exFAT、NTFS、ReFS |
| macOS   | HFS/HFS+、APFS           |
| Linux   | Ext2/3/4、XFS、Btrfs     |

**区别**：

- 兼容性：不同系统对文件系统的支持不同。
- 容量限制：不同文件系统支持的最大分区与文件大小不同。

**Linux常用**：

- **Ext4**：稳定，支持日志功能。
- **XFS**：CentOS 7+默认文件系统，支持大容量、高性能。

------

## Linux特殊设备文件

| 设备文件       | 用途                                   |
| :------------- | :------------------------------------- |
| `/dev/null`    | 数据黑洞，丢弃所有写入内容             |
| `/dev/zero`    | 提供无限的空字符流，常用于生成测试文件 |
| `/dev/random`  | 提供真随机数                           |
| `/dev/urandom` | 提供伪随机数，速度更快                 |

------

## 磁盘使用实践

### 光盘弹出

```sh
eject                 # 弹出光驱
eject -r /dev/sr0     # 指定设备弹出
```

### 自动挂载（/etc/fstab）

编辑`/etc/fstab`，添加如下格式的行：

```
UUID=<uuid>  /mount/point  xfs  defaults  0 0
```

使用`blkid`查看UUID。

### mount选项详解

| 选项        | 说明                        |
| :---------- | :-------------------------- |
| `ro` / `rw` | 只读 / 读写                 |
| `noexec`    | 禁止执行二进制文件          |
| `nosuid`    | 禁止SUID权限生效            |
| `noatime`   | 不更新访问时间，提升I/O性能 |
| `remount`   | 重新挂载                    |

------

## inode与block原理

### inode（索引节点）

存储文件的元数据（属性），如权限、所有者、时间戳、大小等。每个文件有唯一的inode编号。

### block（数据块）

存储文件的实际内容。

**文件读取流程**：
文件名 → inode编号 → 定位block → 读取数据。

### 查看inode与block信息

```sh
df -i          # 查看inode使用情况
df -h          # 查看block使用情况
xfs_info       # 查看XFS文件系统信息（仅XFS）
dumpe2fs       # 查看Ext文件系统信息（仅Ext）
```



------

## 软链接与硬链接

| 特性       | 软链接                  | 硬链接               |
| :--------- | :---------------------- | :------------------- |
| inode      | 与源文件不同            | 与源文件相同         |
| 跨分区     | 支持                    | 不支持               |
| 对目录     | 支持                    | 不支持               |
| 删除源文件 | 链接失效                | 不影响其他硬链接     |
| 创建命令   | `ln -s 源文件 链接文件` | `ln 源文件 链接文件` |

------

## RAID磁盘阵列技术

### 常见RAID级别

- **RAID 0**：条带化，提升性能，无冗余。
- **RAID 1**：镜像，提供冗余，性能一般。
- **RAID 5**：条带化+分布式校验，兼顾性能与冗余。
- **RAID 10**：RAID 1+0，先镜像后条带，高性能高可靠。

### 软RAID实践（mdadm）

```sh
# 创建RAID 10
mdadm -Cv /dev/md0 -a yes -n 4 -l 10 /dev/sdb /dev/sdc /dev/sdd /dev/sde

# 格式化并挂载
mkfs.xfs /dev/md0
mount /dev/md0 /mnt/raid

# 查看状态
mdadm -D /dev/md0
```

### 生产环境建议

- 物理服务器推荐使用硬件RAID卡。
- 云服务器通常由云厂商提供底层存储保障，无需手动配置RAID。

------

## 常见问题与排查

### 磁盘空间未释放

- 检查是否有进程占用已删除的文件：`lsof | grep deleted`。
- 执行`sync`强制写入缓存。
- 对于SSD或虚拟化环境，可尝试`fstrim`。

### 挂载目录忙无法卸载

- 离开挂载目录或结束相关进程。
- 使用`lsof`或`fuser`查看占用进程并结束。