## 一、集群概述

**集群** 是一组相互连接的计算机（节点），通过网络协作，作为一个统一的系统来提供服务或任务。核心目标：

- 提升系统可用性
- 提升系统可扩展性
- 提升系统整体性能

**只有基于服务器集群的环境，才能实现负载均衡。**

------

## 二、集群类型与负载均衡

### 1. 负载均衡集群（Load Balancing Cluster）

- 将用户请求均匀分配到多个节点，避免单点过载
- 提升系统性能和响应速度
- 负载均衡器依据算法（如轮询、加权轮询等）分配请求

### 2. 高可用集群（High Availability Cluster）

- 确保服务持续可用，单点故障不影响整体
- 常用于数据库、关键业务系统

### 3. 其他集群类型

- Web 集群、数据库集群、缓存集群、负载均衡集群等

------

## 三、正向代理与反向代理

### 1. 正向代理（Forward Proxy）

- **代理客户端**，隐藏客户端真实 IP

- 用途：

  - 突破网络限制（如访问国外资源）
  - 保护客户端身份

- 配置示例（nginx）：

  ```nginx
  location / {
      proxy_pass http://目标服务器IP:端口;
  }
  ```

  

### 2. 反向代理（Reverse Proxy）

- **代理服务端**，隐藏后端服务器真实 IP

- 是负载均衡的核心实现方式

- 配置示例（nginx）：

  ```nginx
  upstream backend {
      server 后端服务器1:端口;
      server 后端服务器2:端口;
  }
  
  server {
      location / {
          proxy_pass http://backend;
      }
  }
  ```

  

------

## 四、负载均衡实现方式

### 1. 硬件负载均衡

- 如 F5、Netscaler 等商业设备

### 2. 软件负载均衡（开源常用）

- Nginx（七层/四层）
- LVS（四层）
- HAProxy
- Keepalived（高可用）

------

## 五、Nginx 负载均衡实践

### 1. 四层负载均衡（TCP/UDP）

- 基于 OSI 第四层（传输层）进行转发

- 配置示例（MySQL 转发）：

  ```nginx
  stream {
      upstream mysql_backend {
          server 172.16.1.51:3306;
          server 172.16.1.52:3306;
      }
      server {
          listen 3306;
          proxy_pass mysql_backend;
      }
  }
  ```

  

### 2. 七层负载均衡（HTTP/HTTPS）

- 基于 OSI 第七层（应用层）进行转发

- 可基于域名、URL 等转发

- 配置示例：

  ```nginx
  upstream web_backend {
      server 172.16.1.7:8080;
      server 172.16.1.8:8080;
  }
  server {
      listen 80;
      location / {
          proxy_pass http://web_backend;
          include proxy_params.conf; # 包含代理参数文件
      }
  }
  ```

  

### 3. 代理参数文件示例（proxy_params.conf）

```nginx
proxy_set_header Host $http_host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_connect_timeout 30;
proxy_send_timeout 60;
proxy_read_timeout 60;
proxy_buffering on;
proxy_buffer_size 32k;
proxy_buffers 4 128k;
```



------

## 六、实战案例：Nginx 反向代理 WordPress

### 环境准备

- 客户端（Client）
- 负载均衡器（lb-5）
- 后端服务器（web-7、web-8）

### 配置步骤

#### 1. 负载均衡器（lb-5）配置

```nginx
server {
    listen 80;
    server_name wordpress.linux0224.cn;
    location / {
        proxy_pass http://172.16.1.7:8080;
        include /etc/nginx/proxy_params.conf;
    }
}
```



#### 2. 后端服务器（web-7）配置

```nginx
server {
    listen 8080;
    server_name wordpress.linux0224.cn;
    root /code/wordpress;
    index index.php index.html;

    location ~ \.php$ {
        root /code/wordpress;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
```



#### 3. 客户端访问流程

```text
客户端 → lb-5（反向代理） → web-7（WordPress）
```



------

## 七、关键概念总结

| 概念         | 说明                       |
| :----------- | :------------------------- |
| 集群         | 一组机器协作提供服务       |
| 负载均衡     | 将请求均匀分配到多个服务器 |
| 正向代理     | 代理客户端，隐藏客户端 IP  |
| 反向代理     | 代理服务端，隐藏服务端 IP  |
| 四层负载均衡 | 基于 IP + 端口转发         |
| 七层负载均衡 | 基于 HTTP 头部、URL 等转发 |
| 高可用       | 系统持续可用，无单点故障   |

------

## 八、学习建议

1. 先理解代理与转发的区别
2. 掌握 Nginx 的 `proxy_pass` 和 `upstream` 配置
3. 动手搭建简单的负载均衡环境（如 WordPress）
4. 通过日志分析请求流向，理解转发过程
5. 逐步扩展到四层、七层负载均衡的实际应用

------

## 九、常见问题

### Q：正向代理和反向代理有什么区别？

A：正向代理代理客户端，反向代理代理服务端。

### Q：负载均衡有哪些常用算法？

A：轮询、加权轮询、IP Hash、最少连接等。

### Q：Nginx 如何实现四层负载均衡？

A：使用 `stream` 模块，配置 TCP/UDP 转发。

### Q：为什么需要 `X-Forwarded-For` 头部？

A：用于传递客户端真实 IP，便于后端日志记录和业务处理。