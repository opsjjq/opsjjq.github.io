# Nginx 负载均衡策略与参数

## 一、负载均衡策略

### 1. 轮询（Round Robin） - 默认策略

- 按请求顺序逐一分配至后端服务器
- 自动健康检查：宕机服务器会被自动剔除

```nginx
upstream web-pool {
    server 172.16.1.7:9999;
    server 172.16.1.8:9999;
}
```



### 2. 加权轮询（Weighted Round Robin）

- 根据服务器性能分配权重，权重越高获得越多请求
- 解决新旧服务器性能不均问题

```nginx
upstream web-pool {
    server 172.16.1.7 weight=4;  # 性能较好
    server 172.16.1.8 weight=1;  # 性能较弱
}
```



**测试结果示例：**

- 4:1权重比例下，请求分配约为 80% : 20%
- 长期来看保持比例稳定，但非固定顺序

### 3. IP哈希（IP Hash）

- 基于客户端IP计算哈希值，固定分配至同一后端
- 适用于需要会话保持的场景
- **注意**：不可与权重同时使用

```nginx
upstream web-pool {
    ip_hash;
    server 172.16.1.7;
    server 172.16.1.8;
}
```



**局限性：**

- 可能造成单节点压力过大
- 节点故障时需结合健康检查机制

### 4. 其他策略（使用较少）

| 策略                          | 说明                         | 适用场景     |
| :---------------------------- | :--------------------------- | :----------- |
| URL哈希                       | 基于URL哈希值固定分配        | 缓存优化     |
| 最少连接（Least Connections） | 分配给当前连接数最少的服务器 | 长连接场景   |
| 最短响应时间（Least Time）    | 基于响应时间和连接数分配     | 响应速度优先 |

## 二、负载均衡参数配置

### 1. 基础参数

```nginx
upstream web-pool {
    # 正常服务器
    server 172.16.1.7;
    
    # 备份服务器（其他服务器不可用时启用）
    server 172.16.1.8 backup;
    
    # 下线服务器（停止使用）
    server 172.16.1.9 down;
}
```



### 2. 健康检查参数

```nginx
upstream web-pool {
    server 172.16.1.7 max_fails=3 fail_timeout=30s;
    server 172.16.1.8 max_fails=3 fail_timeout=30s;
}
```



**参数说明：**

- `max_fails`：允许失败次数（默认1次）
- `fail_timeout`：失败后暂停服务时间
- 新版本Nginx有更智能的健康检查机制

### 3. 连接限制参数

```nginx
upstream web-pool {
    server 172.16.1.7 max_conns=1000;  # 限制最大连接数
    server 172.16.1.8 max_conns=1000;
}
```



## 三、四层 vs 七层负载均衡对比

| 特性     | 四层负载均衡                | 七层负载均衡           |
| :------- | :-------------------------- | :--------------------- |
| OSI层级  | 传输层（TCP/UDP）           | 应用层（HTTP/HTTPS）   |
| 转发依据 | IP + 端口                   | URL、Header、Cookie等  |
| 性能     | 更高（无应用层解析）        | 相对较低               |
| 功能     | 简单转发                    | 内容识别、重写、缓存等 |
| 典型应用 | MySQL、Redis、自定义TCP服务 | Web网站、API服务       |

## 四、七层负载均衡高级应用

### 1. 基于User-Agent的设备识别

```nginx
# 定义不同设备的后端池
upstream android {
    server 172.16.1.7:33333;
}
upstream iphone {
    server 172.16.1.8:33333;
}
upstream pc {
    server 172.16.1.7:22222;
    server 172.16.1.8:22222;
}

server {
    listen 80;
    server_name huya.yuchaoit.cn;
    
    location / {
        # 默认PC端
        proxy_pass http://pc;
        include proxy_params.conf;
        
        # iPhone用户
        if ($http_user_agent ~* "iphone") {
            proxy_pass http://iphone;
        }
        
        # Android用户
        if ($http_user_agent ~* "android") {
            proxy_pass http://android;
        }
        
        # IE浏览器拦截
        if ($http_user_agent ~* "msie") {
            return 403 "IE浏览器已淘汰，请升级！";
        }
    }
}
```



### 2. 后端服务器配置示例

```nginx
# PC端配置
server {
    listen 22222;
    server_name huya.yuchaoit.cn;
    root /tmp/huya/pc;
    index index.html;
}

# Android端配置
server {
    listen 33333;
    server_name huya.yuchaoit.cn;
    root /tmp/huya/android;
    index index.html;
}

# iPhone端配置
server {
    listen 33333;
    server_name huya.yuchaoit.cn;
    root /tmp/huya/iphone;
    index index.html;
}
```



## 五、系统连接数监控

### 1. 查看TCP连接状态

```bash
# 查看所有ESTABLISHED连接
ss -an | grep -i estab
netstat -an | grep -i estab

# 查看特定服务连接
ss -an | grep -i estab | grep '10.0.0.7:80'
netstat -an | grep '10.0.0.7:80'

# 统计HTTP连接数
ss -ant state established sport = :80 | wc -l
```



### 2. Nginx连接管理

- 默认keepalive超时时间为60s
- 超时后自动断开，释放连接资源
- 可通过`keepalive_timeout`参数调整

## 六、WordPress负载均衡注意事项

### 关键配置要点：

1. **统一域名访问**：所有节点使用相同的域名访问
2. **数据一致性**：后端服务部署必须完全一致
3. **会话保持**：如需会话保持，考虑使用`ip_hash`或第三方会话服务
4. **文件共享**：上传文件需通过共享存储（NFS、对象存储等）

### 部署建议：

```nginx
# 负载均衡器配置
upstream wordpress {
    server 172.16.1.7:8080;
    server 172.16.1.8:8080;
}

server {
    listen 80;
    server_name wordpress.linux0224.cn;
    
    location / {
        proxy_pass http://wordpress;
        include proxy_params.conf;
    }
}
```



## 七、虚拟主机类型总结

| 类型     | 示例配置                        | 访问方式                  |
| :------- | :------------------------------ | :------------------------ |
| 基于端口 | `listen 14455;`                 | `http://ip:14455`         |
| 基于IP   | `listen 10.0.0.111:80;`         | `http://10.0.0.111`       |
| 基于域名 | `server_name www.linux0224.cn;` | `http://www.linux0224.cn` |
| 多域名   | 多个`server_name`配置           | 对应域名访问              |

## 八、生产环境建议

1. **常用策略**：轮询、加权轮询为主
2. **健康检查**：确保配置有效的健康检查机制
3. **监控报警**：监控后端节点状态，设置报警
4. **灰度发布**：结合`weight`参数实现平滑发布
5. **连接优化**：根据业务特点调整连接超时参数

## 九、命令工具汇总

```bash
# Nginx操作
nginx -t              # 测试配置
nginx -s reload       # 重载配置
systemctl restart nginx # 重启服务

# 连接查看
ss -ant               # 查看所有TCP连接
netstat -an           # 传统方式查看连接

# 测试工具
curl http://目标地址     # 基础测试
curl -H "User-Agent: iPhone" http://目标地址  # 模拟设备访问
```