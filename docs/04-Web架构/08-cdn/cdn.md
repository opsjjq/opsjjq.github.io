# CDN 内容分发网络实践指南

---

## 一、CDN 基础概念

### 1. 什么是 CDN？

CDN（Content Delivery Network）通过在各地部署边缘节点服务器，使用户就近获取所需内容，提高访问速度和稳定性的网络架构。

### 2. CDN 核心功能

| 功能 | 说明 |
| :--- | :--- |
| **缓存静态资源** | 图片、CSS、JS、视频等 |
| **减轻源站压力** | 分散访问流量 |
| **提升用户体验** | 就近访问、速度更快 |
| **提高可用性** | 多节点冗余、故障转移 |

### 3. CDN 重要性

- 降低服务器负载
- 提升访问速度
- 提升网站稳定性
- 支持高并发访问

### 4. CDN 工作原理

```text
用户请求 → DNS 解析（返回 CNAME）→ 就近 CDN 节点
                                    ↓
                          命中缓存 → 直接返回
                                    ↓
                          未命中缓存 → 回源拉取 → 返回并缓存
```

**详细流程**：
1. 用户访问已接入 CDN 的域名（如 `alicdn.apecome.com`）
2. DNS 解析返回 CNAME 记录，指向 CDN 服务商提供的域名
3. 请求被调度到最近的 CDN 节点
4. 节点如有缓存则直接返回，否则回源拉取并缓存

---

## 二、Web 通信协议基础

### 1. TCP/IP 协议

互联网通信的基础协议簇，包含 TCP（传输控制协议）和 IP（网际协议）。

### 2. OSI 七层模型

| 层级 | 名称 | 说明 |
| :--- | :--- | :--- |
| 7 | 应用层 | HTTP、FTP、SMTP |
| 6 | 表示层 | 数据格式转换、加密 |
| 5 | 会话层 | 会话管理 |
| 4 | 传输层 | TCP、UDP（端口） |
| 3 | 网络层 | IP 寻址、路由 |
| 2 | 数据链路层 | MAC 地址、帧 |
| 1 | 物理层 | 物理介质、信号 |

### 3. HTTP 协议特性

| 特性 | 说明 |
| :--- | :--- |
| **无状态** | 每次请求独立，服务器不记录之前状态 |
| **Cookie** | 维持会话状态 |
| **请求方法** | GET、POST、PUT、DELETE 等 |

### 4. 请求与响应结构

| 报文类型 | 组成部分 |
| :--- | :--- |
| **请求报文** | 请求行、请求头、请求体 |
| **响应报文** | 状态行、响应头、响应体 |

### 5. 端口号与 Socket

| 概念 | 说明 |
| :--- | :--- |
| **端口号** | 区分同一主机上的不同服务 |
| **Socket** | IP 地址 + 端口号，标识网络通信端点 |

### 6. 资源类型对比

| 类型 | 说明 | 示例 |
| :--- | :--- | :--- |
| **静态资源** | 直接由 Web 服务器返回 | 图片、CSS、JS、HTML |
| **动态资源** | 需后端程序处理生成 | PHP、Python、Java 输出 |

---

## 三、CDN 配置与优化

### 1. 判断是否使用 CDN

```sh
# 方法1：Ping 命令查看 CNAME
ping gw.alicdn.com

# 方法2：dig 命令查看解析结果
dig www.taobao.com

# 方法3：查看响应头标识
curl -I https://www.example.com
```

### 2. CDN 缓存策略

| 策略 | 说明 |
| :--- | :--- |
| **缓存过期时间** | 设置合理的 TTL，避免用户访问旧数据 |
| **主动刷新** | 资源更新时主动清除缓存 |
| **缓存分层** | 浏览器缓存 + CDN 边缘缓存 |

### 3. CDN 防盗链配置

**目的**：防止其他网站盗用本站静态资源（如图片）。

**实现方式**：检查请求头中的 `Referer` 字段，只允许指定域名访问。

```nginx
# Nginx 防盗链配置示例
location ~* \.(jpg|png|gif)$ {
    valid_referers none blocked example.com *.example.com;
    if ($invalid_referer) {
        return 403;
    }
}
```

---

## 四、阿里云 CDN 实践步骤

### 1. 准备工作

| 准备项 | 说明 |
| :--- | :--- |
| 源站服务器 | Nginx 或其他 Web 服务器 |
| 源站域名 | 可访问的域名（如 `alicdn.apecome.com`） |
| CDN 服务 | 阿里云 CDN 控制台账号 |

### 2. 创建加速域名

1. 登录阿里云 CDN 控制台
2. 添加加速域名
3. 配置源站信息（IP 或域名）
4. 选择加速区域

### 3. 配置 CNAME

1. 获取阿里云 CDN 提供的 CNAME 域名
2. 修改 DNS 解析
3. 将加速域名的 A 记录改为 CNAME 记录

### 4. 验证 CDN 生效

```sh
# 检查 DNS 解析结果
dig www.yourdomain.com

# 访问加速域名，查看响应头
curl -I https://www.yourdomain.com

# 确认响应头包含 CDN 标识
# X-Cache: HIT from ...
# Server: AlibabaCloud
```
