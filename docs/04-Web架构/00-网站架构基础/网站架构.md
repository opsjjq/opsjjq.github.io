## 一、网站架构演进概述

### 1. 网站架构定义

大型网站架构是为支撑**大规模用户访问**、**海量数据处理**及**复杂业务功能**而设计的软件架构体系。

### 2. 架构演进历程

| 阶段 | 特点 | 优势 | 劣势 | 适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| 单体架构 | 所有业务集中在一个项目 | 开发简单、部署方便、调试容易 | 单点故障、性能瓶颈、扩展困难 | 小型网站、初期项目 |
| 集群架构 | 单机复制多份，构成集群 | 性能提升、高可用、易于扩展 | 成本增加、复杂度提高 | 中大型网站 |
| 微服务架构 | 大系统拆分为独立小系统 | 解耦业务、独立部署扩展 | 系统复杂、运维难度提高 | 大型互联网应用 |

**关键组件**：节点、负载均衡、高可用

## 二、运维架构环境规划

### 1. 架构组件说明

| 服务器角色       | 作用               | 运行软件         | 类比         |
| :--------------- | :----------------- | :--------------- | :----------- |
| **用户端**       | 访问网站的用户请求 | 浏览器           | 顾客         |
| **防火墙**       | 安全防护、流量控制 | iptables         | 保安         |
| **负载均衡**     | 请求调度分发       | nginx/keepalived | 迎宾服务员   |
| **Web服务器**    | 处理用户请求       | nginx/php/tomcat | 点餐前台     |
| **数据库服务器** | 存储动态数据       | mysql/redis      | 厨房仓库     |
| **存储服务器**   | 存储静态资源       | nfs              | 粮仓仓库     |
| **备份服务器**   | 数据备份           | rsync+inotify    | 粮仓仓库二号 |
| **缓存服务器**   | 高速数据读写       | redis            | 自助取餐     |
| **管理服务器**   | 批量化管理         | ansible/zabbix   | 调度总台     |

### 2. 服务器规划表

| 服务器作用      | 主机名    | 外网地址  | 内网地址    | 运行软件                  |
| :-------------- | :-------- | :-------- | :---------- | :------------------------ |
| 管理机          | master-61 | 10.0.0.61 | 172.16.1.61 | Ansible/zabbix/jumpserver |
| 负载均衡服务器1 | slb-5     | 10.0.0.5  | 172.16.1.5  | nginx/keepalived          |
| 负载均衡服务器2 | slb-6     | 10.0.0.6  | 172.16.1.6  | nginx/keepalived          |
| Web服务器1      | web-7     | 10.0.0.7  | 172.16.1.7  | nginx/php                 |
| Web服务器2      | web-8     | 10.0.0.8  | 172.16.1.8  | nginx/tomcat              |
| Web服务器3      | web-9     | 10.0.0.9  | 172.16.1.9  | nginx/php                 |
| 存储服务器      | nfs-31    | 10.0.0.31 | 172.16.1.31 | nfs/rsyncd/lsyncd         |
| 备份服务器      | rsync-41  | 10.0.0.41 | 172.16.1.41 | nfs/rsyncd/lsyncd         |
| 数据库服务器    | db-51     | 10.0.0.51 | 172.16.1.51 | mysql/redis               |

**网络说明**：

- **外网地址**：模拟公网IP，可通过Windows直接访问
- **内网地址**：模拟局域网环境，仅内部服务器间通信



### 1. 模板机创建步骤

#### 步骤1：创建虚拟机

```text
系统: CentOS 7
内存: 2GB (最低1GB)
CPU: 1核心
硬盘: 40GB
网卡1: NAT模式 (外网) - 网段10.0.0.0/24
网卡2: LAN区段 (内网) - 网段172.16.1.0/24
```

#### 步骤2：系统安装优化

```text
# 进入内核选择界面时，按上下方向键，取消自动选择
# 输入 tab 键，复制粘贴如下代码，将网卡名改为 eth0 格式
net.ifnames=0 biosdevname=0

# 安装时设置
时区: 亚洲/上海
语言: 英文
主机名: type
IP地址: 10.0.0.100
网关: 10.0.0.254
```

#### 步骤3：网络配置

```
cat >/etc/sysconfig/network-scripts/ifcfg-eth0<<'EOF'
TYPE=Ethernet
BOOTPROTO=static
NAME=eth0
DEVICE=eth0
ONBOOT=yes
IPADDR=10.0.0.100
NETMASK=255.255.255.0
GATEWAY=10.0.0.254
EOF
cat >/etc/sysconfig/network-scripts/ifcfg-eth1<<'EOF'
TYPE=Ethernet
BOOTPROTO=static
NAME=eth1
DEVICE=eth1
ONBOOT=yes
IPADDR=172.16.1.100
NETMASK=255.255.255.0
EOF
```

#### 步骤4：系统初始化优化

```sh
# 1. 关闭防火墙和SELinux
systemctl stop firewalld NetworkManager
systemctl disable firewalld NetworkManager
sed -i '/^SELINUX=/c SELINUX=disabled' /etc/selinux/config
setenforce 0

# 2. 优化SSH连接
sed -i 's/#UseDNS yes/UseDNS no/g' /etc/ssh/sshd_config
sed -i 's/GSSAPIAuthentication yes/GSSAPIAuthentication no/g' /etc/ssh/sshd_config
systemctl restart sshd

# 3. 优化PS1变量
echo 'export PS1="[\[\e[34;1m\]\u@\[\e[0m\]\[\e[32;1m\]\H\[\e[0m\] \[\e[31;1m\]\w\[\e[0m\]]\\$"' >>~/.bashrc
source ~/.bashrc

# 4. 配置YUM源
cd /etc/yum.repos.d
mkdir bakrepo && mv *.repo bakrepo/
wget -O CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo
wget -O epel.repo http://mirrors.aliyun.com/repo/epel-7.repo
yum clean all && yum makecache

# 5. 安装基础软件
yum install -y tree wget bash-completion lrzsz net-tools sysstat iotop iftop htop

# 6. 配置hosts解析
cat > /etc/hosts <<EOF
10.0.0.61  172.16.1.61  master61
10.0.0.5   172.16.1.5   slb5
10.0.0.6   172.16.1.6   slb6
10.0.0.7   172.16.1.7   web7
10.0.0.8   172.16.1.8   web8
10.0.0.9   172.16.1.9   web9
10.0.0.31  172.16.1.31  nfs31
10.0.0.41  172.16.1.41  rsync41
10.0.0.51  172.16.1.51  db51
EOF
# DNS解析
cat >/etc/resolv.conf<<EOF
nameserver 223.5.5.5
EOF

# 7. 时间同步
echo "* * * * * /usr/sbin/ntpdate time1.aliyun.com > /dev/null 2>&1" >> /etc/crontab

# 8. 关闭Swap
swapoff -a
sed -i '/swap/d' /etc/fstab
```

#### 步骤5：创建IP修改脚本

```
cat >/set.sh<<'EOF'
#!/bin/bash
# network_init.sh

read -p "请输入IP主机位：" my_ip
read -p "请输入主机名：" host_name

echo '正在修改网卡配置文件eth0'
sed -i "/IPADDR/s#100#${my_ip}#g" /etc/sysconfig/network-scripts/ifcfg-eth0

echo '正在修改网卡配置文件eth1'
sed -i "/IPADDR/s#100#${my_ip}#g" /etc/sysconfig/network-scripts/ifcfg-eth1

echo '正在修改主机名'
hostnamectl set-hostname ${host_name}

echo '重启network服务中'
systemctl restart network

echo '配置完成！'
EOF
chmod +x /set.sh
```

#### 步骤6：拍摄快照

1. 关机模板机
2. 创建快照：`template_init`
3. 克隆虚拟机

### 2. 各服务器配置

#### 克隆后配置示例

```
# 对于slb-5服务器
./network_init.sh
# 输入IP主机位: 5
# 输入主机名: slb-5

# 检查配置
hostname    # 应显示slb-5
ip addr show eth0  # 应显示10.0.0.5
ip addr show eth1  # 应显示172.16.1.5
```
