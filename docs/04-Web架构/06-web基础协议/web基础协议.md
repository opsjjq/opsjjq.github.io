# Web 通信与 HTTP 协议学习笔记

## 一、Web 通信流程概述

### 1. 整体通信流程

```text
客户端 → DNS 解析 → 建立 TCP 连接 → 发送 HTTP 请求 → 服务器处理 → 返回 HTTP 响应 → 客户端渲染 → 断开连接
```

### 2. 服务器工作原理

- 接收客户端的 TCP 连接
- 解析 HTTP 请求报文
- 处理请求（静态资源直接返回，动态内容调用解释引擎）
- 生成 HTTP 响应报文
- 发送响应并关闭连接

### 3. 客户端工作原理

- DNS 解析获取服务器 IP
- 建立 TCP 连接
- 构建并发送 HTTP 请求
- 接收并解析 HTTP 响应
- 渲染页面内容
- 管理连接状态

------

## 二、TCP/IP 与OSI网络模型

### 1. TCP/IP 协议栈

TCP/IP 四层模型（实际使用模型）：

```text
应用层 → 传输层 → 网络层 → 网络接口层
```

### 2. OSI 七层模型

| 层级 | 名称       | 主要功能           | 典型协议       |
| :--- | :--------- | :----------------- | :------------- |
| 7    | 应用层     | 用户接口、应用程序 | HTTP, FTP, SSH |
| 6    | 表示层     | 数据格式转换、加密 | JPEG, SSL      |
| 5    | 会话层     | 建立、管理会话     | RPC, NetBIOS   |
| 4    | 传输层     | 端到端连接、可靠性 | TCP, UDP       |
| 3    | 网络层     | 寻址、路由选择     | IP, ICMP       |
| 2    | 数据链路层 | 帧传输、MAC地址    | Ethernet, PPP  |
| 1    | 物理层     | 比特流传输         | RJ45, 光纤     |

------

## 三、TCP 连接管理

### 1. 三次握手（建立连接）

```
客户端 → SYN →     服务器     # 客户端发送连接请求
客户端 ← SYN+ACK ← 服务器     # 服务器确认并回应
客户端 → ACK →     服务器     # 客户端确认，连接建立
```

**意义验证**：

- 第一次：验证客户端发送能力
- 第二次：验证服务器收发能力
- 第三次：验证客户端接收能力

### 2. 四次挥手（断开连接）

```
客户端 → FIN → 服务器     # 客户端发起关闭
客户端 ← ACK ← 服务器     # 服务器确认收到
客户端 ← FIN ← 服务器     # 服务器发起关闭
客户端 → ACK → 服务器     # 客户端确认，连接关闭
```

### 3. 三次挥手优化

**条件**：服务器无数据发送时，合并第2、3次挥手

```
客户端 → FIN →     服务器
客户端 ← FIN+ACK ← 服务器  # 合并响应
客户端 → ACK →     服务器
```

**优化所用机制**：

- 延迟确认（Delayed ACK）：等待40ms看是否有数据要发送
- 捎带应答（Piggybacking）：将 ACK 与数据合并发送

------

## 四、Socket 套接字

### 1. 基本概念

- Socket = IP地址 + 端口号
- 网络通信的本质是 Socket 之间的数据交换

### 2. Socket 类型

| 类型           | 格式     | 特点           | 应用场景                 |
| :------------- | :------- | :------------- | :----------------------- |
| 网络Socket     | IP:Port  | 跨机器通信     | HTTP服务、数据库远程连接 |
| 本地Socket文件 | 文件路径 | 本机进程间通信 | 数据库本地连接、进程通信 |

### 3. 常见端口号

| 服务  | 端口 | 协议    | 说明         |
| :---- | :--- | :------ | :----------- |
| HTTP  | 80   | TCP     | 网页服务     |
| HTTPS | 443  | TCP     | 加密网页服务 |
| SSH   | 22   | TCP     | 安全远程连接 |
| FTP   | 21   | TCP     | 文件传输     |
| MySQL | 3306 | TCP     | 数据库服务   |
| DNS   | 53   | UDP/TCP | 域名解析     |

------

## 五、HTTP 协议详解

### 1. 无状态特性

- HTTP 协议默认不记录连接状态
- 每次请求被视为独立事务
- 解决方案：Cookie、Session、Token

### 2. HTTP 请求方法

| 方法    | 功能         | 幂等性 | 安全性 |
| :------ | :----------- | :----- | :----- |
| GET     | 获取资源     | 是     | 安全   |
| POST    | 提交数据     | 否     | 不安全 |
| PUT     | 更新完整资源 | 是     | 不安全 |
| DELETE  | 删除资源     | 是     | 不安全 |
| PATCH   | 部分更新     | 否     | 不安全 |
| HEAD    | 获取响应头   | 是     | 安全   |
| OPTIONS | 查询支持方法 | 是     | 安全   |

### 3. HTTP 报文结构

**请求报文**：

```
请求行（方法 + 路径 + 版本）
请求头（Host、User-Agent等）
空行
请求体（POST数据）
```

**响应报文**：

```
状态行（版本 + 状态码 + 描述）
响应头（Server、Content-Type等）
空行
响应体（HTML、JSON等）
```

### 4. HTTP 状态码

| 类别 | 范围    | 含义       | 常见状态码                          |
| :--- | :------ | :--------- | :---------------------------------- |
| 1xx  | 100-199 | 信息性     | 100 Continue                        |
| 2xx  | 200-299 | 成功       | 200 OK, 201 Created                 |
| 3xx  | 300-399 | 重定向     | 301 Moved, 304 Not Modified         |
| 4xx  | 400-499 | 客户端错误 | 400 Bad Request, 404 Not Found      |
| 5xx  | 500-599 | 服务器错误 | 500 Internal Error, 502 Bad Gateway |

------

## 六、静态与动态资源

### 1. 静态资源

- **特征**：文件扩展名明确（.html, .css, .js, .jpg等）
- **处理**：Web 服务器直接读取返回
- **缓存**：CDN 缓存友好
- **示例**：`/static/image.jpg`, `/css/style.css`

### 2. 动态资源

- **特征**：需要程序处理生成
- **处理**：转发给后端程序（PHP、Python、Java）
- **缓存**：通常不缓存或短时缓存
- **示例**：`/api/user`, `/search?q=keyword`

------

## 七、完整通信流程（面试背诵版）

### 1. DNS 解析阶段

```
用户访问 www.example.com
↓
浏览器缓存检查
↓
Hosts 文件检查
↓
本地 DNS 服务器（递归查询）
↓
根域名服务器 → 顶级域名服务器 → 权威域名服务器（迭代查询）
↓
返回 IP 地址
```

### 2. TCP 连接阶段（三次握手）

```
客户端 → SYN → 服务器
客户端 ← SYN+ACK ← 服务器
客户端 → ACK → 服务器
连接建立成功
```

### 3. HTTP 请求阶段

```
GET /index.html HTTP/1.1
Host: www.example.com
User-Agent: Chrome/...
Accept: text/html
Cookie: session=abc123
（空行）
```

### 4. 服务器处理阶段

- Nginx 接收请求
- 静态资源：直接读取文件
- 动态资源：转发给后端程序（PHP-FPM、Python、Java）
- 生成响应内容

### 5. HTTP 响应阶段

```
HTTP/1.1 200 OK
Server: nginx/1.18
Content-Type: text/html
Content-Length: 1234
（空行）
<!DOCTYPE html>...
```

### 6. 连接关闭阶段（四次挥手）

```
客户端 → FIN → 服务器
客户端 ← ACK ← 服务器
客户端 ← FIN ← 服务器
客户端 → ACK → 服务器
连接完全关闭
```

------

## 八、实践与排错要点

### 1. 抓包分析工具

- **Wireshark**：全面网络协议分析
- **tcpdump**：命令行抓包工具
- **浏览器开发者工具**：HTTP 请求/响应分析

### 2. 常见问题排查

1. **连接失败**：检查防火墙、端口监听、服务状态
2. **响应缓慢**：分析网络延迟、服务器负载、DNS解析
3. **状态码异常**：
   - 4xx：检查客户端请求（URL、参数、权限）
   - 5xx：检查服务器配置、后端服务、资源限制

### 3. 性能优化方向

- 使用 CDN 缓存静态资源
- 启用 HTTP/2 或 HTTP/3
- 配置合理的缓存策略
- 优化图片和资源大小
- 使用异步加载技术
