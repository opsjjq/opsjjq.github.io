import{_ as n,c as a,e,o as l}from"./app-DtXLoKBz.js";const i={};function p(c,s){return l(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="docker-镜像构建指南" tabindex="-1"><a class="header-anchor" href="#docker-镜像构建指南"><span>Docker 镜像构建指南</span></a></h1><h2 id="一、手动构建镜像" tabindex="-1"><a class="header-anchor" href="#一、手动构建镜像"><span>一、手动构建镜像</span></a></h2><h3 id="基本流程" tabindex="-1"><a class="header-anchor" href="#基本流程"><span>基本流程</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 1. 启动基础容器</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">--name</span> os1 centos:7.9.2009 <span class="token function">bash</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 容器内安装软件</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo</span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span>
<span class="line">yum <span class="token function">install</span> nginx <span class="token parameter variable">-y</span></span>
<span class="line">yum clean all</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 提交镜像</span></span>
<span class="line"><span class="token function">docker</span> commit os1 my-nginx:v1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="二、dockerfile-构建镜像" tabindex="-1"><a class="header-anchor" href="#二、dockerfile-构建镜像"><span>二、Dockerfile 构建镜像</span></a></h2><h3 id="dockerfile-基本语法" tabindex="-1"><a class="header-anchor" href="#dockerfile-基本语法"><span>Dockerfile 基本语法</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># FROM：指定基础镜像</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># RUN：执行命令</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> rm -rf /etc/yum.repos.d/*</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装软件</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum -y install python36 python36-pip python36-devel &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装 Python 包</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pip3 install django==2.1.15</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="构建命令" tabindex="-1"><a class="header-anchor" href="#构建命令"><span>构建命令</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 基本构建</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> my-image:v1 <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 指定 Dockerfile 路径</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-f</span> /path/to/Dockerfile <span class="token parameter variable">-t</span> my-image:v1 <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看构建历史</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">history</span> my-image:v1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="三、多容器部署实践" tabindex="-1"><a class="header-anchor" href="#三、多容器部署实践"><span>三、多容器部署实践</span></a></h2><h3 id="案例-django-nginx-redis" tabindex="-1"><a class="header-anchor" href="#案例-django-nginx-redis"><span>案例：Django + Nginx + Redis</span></a></h3><h4 id="_1-django-应用容器" tabindex="-1"><a class="header-anchor" href="#_1-django-应用容器"><span>1. Django 应用容器</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> rm -rf /etc/yum.repos.d/*</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum -y install python36 python36-pip python36-devel &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pip3 install django==2.1.15</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 构建 Django 镜像</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> mydjango:v1 <span class="token parameter variable">-f</span> Dockerfile <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行 Django 容器</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mydjango <span class="token parameter variable">-p</span> <span class="token number">8000</span>:8000 mydjango:v1 <span class="token punctuation">\\</span></span>
<span class="line">    python3 manage.py runserver <span class="token number">0.0</span>.0.0:8000</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="_2-nginx-反向代理容器" tabindex="-1"><a class="header-anchor" href="#_2-nginx-反向代理容器"><span>2. Nginx 反向代理容器</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> rm -rf /etc/yum.repos.d/*</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum -y install nginx &amp;&amp; yum clean all</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> rm -rf /usr/share/nginx/html/*</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> index.html /usr/share/nginx/html/</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 构建 Nginx 镜像</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> mynginx:v1 <span class="token parameter variable">-f</span> Dockerfile <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行 Nginx 容器</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> mynginx <span class="token parameter variable">-p</span> <span class="token number">80</span>:80 mynginx:v1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h4 id="_3-redis-缓存容器" tabindex="-1"><a class="header-anchor" href="#_3-redis-缓存容器"><span>3. Redis 缓存容器</span></a></h4><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> rm -rf /etc/yum.repos.d/*</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    curl -o /etc/yum.repos.d/epel.repo https://mirrors.aliyun.com/repo/epel-7.repo &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum -y install redis &amp;&amp; yum clean all</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">&#39;s/^bind 127.0.0.1$/bind 0.0.0.0/&#39;</span> /etc/redis.conf</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> sed -i <span class="token string">&#39;s/^protected-mode yes/protected-mode no/&#39;</span> /etc/redis.conf</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 构建 Redis 镜像</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">-t</span> myredis:v1 <span class="token parameter variable">-f</span> Dockerfile <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行 Redis 容器</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> myredis <span class="token parameter variable">-p</span> <span class="token number">6379</span>:6379 myredis:v1 redis-server /etc/redis.conf</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="四、dockerfile-最佳实践" tabindex="-1"><a class="header-anchor" href="#四、dockerfile-最佳实践"><span>四、Dockerfile 最佳实践</span></a></h2><h3 id="_1-减少镜像层数" tabindex="-1"><a class="header-anchor" href="#_1-减少镜像层数"><span>1. 减少镜像层数</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># 不推荐：多层 RUN</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum install -y python3</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pip3 install django</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum clean all</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 推荐：合并 RUN</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum install -y python3 &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    pip3 install django &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_2-利用构建缓存" tabindex="-1"><a class="header-anchor" href="#_2-利用构建缓存"><span>2. 利用构建缓存</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># 将变化少的指令放在前面</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum install -y python3  # 很少变化</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> requirements.txt /app/</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pip3 install -r requirements.txt</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . /app/  # 经常变化</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-使用-dockerignore" tabindex="-1"><a class="header-anchor" href="#_3-使用-dockerignore"><span>3. 使用 .dockerignore</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># .dockerignore 文件内容</span>
<span class="line">.git</span>
<span class="line">.gitignore</span>
<span class="line">node_modules</span>
<span class="line">*.log</span>
<span class="line">__pycache__</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_4-多阶段构建" tabindex="-1"><a class="header-anchor" href="#_4-多阶段构建"><span>4. 多阶段构建</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># 构建阶段</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> node:18 <span class="token keyword">AS</span> builder</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> package*.json ./</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> npm install</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . .</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> npm run build</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行阶段</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> nginx:alpine</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/dist /usr/share/nginx/html</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="五、常用-dockerfile-指令" tabindex="-1"><a class="header-anchor" href="#五、常用-dockerfile-指令"><span>五、常用 Dockerfile 指令</span></a></h2><h3 id="from" tabindex="-1"><a class="header-anchor" href="#from"><span>FROM</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> python:3.9-slim</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> scratch  # 空镜像，用于最小化构建</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="run" tabindex="-1"><a class="header-anchor" href="#run"><span>RUN</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># Shell 形式</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum install -y nginx</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Exec 形式</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> [<span class="token string">&quot;/bin/bash&quot;</span>, <span class="token string">&quot;-c&quot;</span>, <span class="token string">&quot;yum install -y nginx&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="copy-与-add" tabindex="-1"><a class="header-anchor" href="#copy-与-add"><span>COPY 与 ADD</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># COPY：复制文件/目录</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> index.html /usr/share/nginx/html/</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . /app/</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ADD：支持 URL 和自动解压</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> http://example.com/file.tar.gz /tmp/</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ADD</span> archive.tar.gz /opt/  # 自动解压</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="cmd-与-entrypoint" tabindex="-1"><a class="header-anchor" href="#cmd-与-entrypoint"><span>CMD 与 ENTRYPOINT</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># CMD：容器启动时的默认命令</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;nginx&quot;</span>, <span class="token string">&quot;-g&quot;</span>, <span class="token string">&quot;daemon off;&quot;</span>]</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> echo <span class="token string">&quot;Hello World&quot;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># ENTRYPOINT：容器启动时执行的入口</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;python&quot;</span>, <span class="token string">&quot;app.py&quot;</span>]</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 组合使用</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;python&quot;</span>]</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;app.py&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="env" tabindex="-1"><a class="header-anchor" href="#env"><span>ENV</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">ENV</span> APP_ENV=production</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENV</span> PATH=<span class="token string">&quot;/usr/local/bin:\${PATH}&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="expose" tabindex="-1"><a class="header-anchor" href="#expose"><span>EXPOSE</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 80</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 443</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 3000/tcp</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 53/udp</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="volume" tabindex="-1"><a class="header-anchor" href="#volume"><span>VOLUME</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">VOLUME</span> [<span class="token string">&quot;/var/log&quot;</span>]</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">VOLUME</span> [<span class="token string">&quot;/data&quot;</span>, <span class="token string">&quot;/config&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="user" tabindex="-1"><a class="header-anchor" href="#user"><span>USER</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">USER</span> nginx</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">USER</span> 1000:1000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="workdir" tabindex="-1"><a class="header-anchor" href="#workdir"><span>WORKDIR</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> pwd  # 输出 /app</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="arg" tabindex="-1"><a class="header-anchor" href="#arg"><span>ARG</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">ARG</span> VERSION=1.0</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> python:<span class="token variable">\${VERSION}</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="onbuild" tabindex="-1"><a class="header-anchor" href="#onbuild"><span>ONBUILD</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">ONBUILD</span> <span class="token keyword">COPY</span> . /app/src</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ONBUILD</span> <span class="token keyword">RUN</span> pip install -r requirements.txt</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="healthcheck" tabindex="-1"><a class="header-anchor" href="#healthcheck"><span>HEALTHCHECK</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">3s</span></span> <span class="token operator">\\</span></span>
<span class="line">  <span class="token keyword">CMD</span> curl -f http://localhost/ || exit 1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="label" tabindex="-1"><a class="header-anchor" href="#label"><span>LABEL</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> maintainer=<span class="token string">&quot;admin@example.com&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> version=<span class="token string">&quot;1.0&quot;</span></span></span>
<span class="line"><span class="token instruction"><span class="token keyword">LABEL</span> description=<span class="token string">&quot;My application&quot;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="六、镜像优化技巧" tabindex="-1"><a class="header-anchor" href="#六、镜像优化技巧"><span>六、镜像优化技巧</span></a></h2><h3 id="_1-选择合适的基础镜像" tabindex="-1"><a class="header-anchor" href="#_1-选择合适的基础镜像"><span>1. 选择合适的基础镜像</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># 完整版（较大）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7.9.2009</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 精简版（推荐）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> centos:7</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 最小版（Alpine）</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.18</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 语言特定</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> python:3.9-slim</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_2-清理缓存" tabindex="-1"><a class="header-anchor" href="#_2-清理缓存"><span>2. 清理缓存</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token instruction"><span class="token keyword">RUN</span> yum install -y nginx &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    yum clean all &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    rm -rf /var/cache/yum/*</span></span>
<span class="line"></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    apt-get install -y nginx &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    apt-get clean &amp;&amp; <span class="token operator">\\</span></span>
<span class="line">    rm -rf /var/lib/apt/lists/*</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-多阶段构建" tabindex="-1"><a class="header-anchor" href="#_3-多阶段构建"><span>3. 多阶段构建</span></a></h3><div class="language-docker line-numbers-mode" data-highlighter="prismjs" data-ext="docker"><pre><code class="language-docker"><span class="line"><span class="token comment"># 构建阶段</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> golang:1.21 <span class="token keyword">AS</span> builder</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /src</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> . .</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">RUN</span> go build -o app</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 运行阶段</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">FROM</span> alpine:3.18</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /src/app /usr/local/bin/app</span></span>
<span class="line"><span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;/usr/local/bin/app&quot;</span>]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_4-使用-dockerignore" tabindex="-1"><a class="header-anchor" href="#_4-使用-dockerignore"><span>4. 使用 .dockerignore</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line"># 排除不需要的文件</span>
<span class="line">.git</span>
<span class="line">.gitignore</span>
<span class="line">node_modules</span>
<span class="line">*.md</span>
<span class="line">Dockerfile</span>
<span class="line">docker-compose.yml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="七、常见问题排查" tabindex="-1"><a class="header-anchor" href="#七、常见问题排查"><span>七、常见问题排查</span></a></h2><h3 id="_1-构建失败" tabindex="-1"><a class="header-anchor" href="#_1-构建失败"><span>1. 构建失败</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 查看详细日志</span></span>
<span class="line"><span class="token function">docker</span> build <span class="token parameter variable">--progress</span><span class="token operator">=</span>plain <span class="token parameter variable">-t</span> myimage:v1 <span class="token builtin class-name">.</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 no-cache 重新构建</span></span>
<span class="line"><span class="token function">docker</span> build --no-cache <span class="token parameter variable">-t</span> myimage:v1 <span class="token builtin class-name">.</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_2-镜像过大" tabindex="-1"><a class="header-anchor" href="#_2-镜像过大"><span>2. 镜像过大</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 查看镜像大小</span></span>
<span class="line"><span class="token function">docker</span> images</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看镜像层</span></span>
<span class="line"><span class="token function">docker</span> <span class="token function">history</span> myimage:v1</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 使用 dive 工具分析</span></span>
<span class="line"><span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">-it</span> <span class="token parameter variable">-v</span> /var/run/docker.sock:/var/run/docker.sock <span class="token punctuation">\\</span></span>
<span class="line">    wagoodman/dive:latest myimage:v1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-缓存问题" tabindex="-1"><a class="header-anchor" href="#_3-缓存问题"><span>3. 缓存问题</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 清理构建缓存</span></span>
<span class="line"><span class="token function">docker</span> builder prune</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 清理所有未使用资源</span></span>
<span class="line"><span class="token function">docker</span> system prune <span class="token parameter variable">-a</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,101)])])}const t=n(i,[["render",p]]),d=JSON.parse('{"path":"/05-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/02-docker%E5%AE%B9%E5%99%A8/3-docker%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F.html","title":"Docker 镜像构建指南","lang":"zh-CN","frontmatter":{},"git":{"contributors":[{"name":"opsjjq","username":"opsjjq","email":"wangyp987@gmail.com","commits":1,"url":"https://github.com/opsjjq"}],"changelog":[{"hash":"ca8e661b7c6729c958583ed3d1a001b6de398273","time":1771558748000,"email":"wangyp987@gmail.com","author":"opsjjq","message":"222"}]},"filePathRelative":"05-容器编排/02-docker容器/3-docker构建镜像.md"}');export{t as comp,d as data};
