import{_ as a,c as n,e,o as l}from"./app-DtXLoKBz.js";const p="/assets/image-20260130221810585-C9MbSTJ6.png",t="/assets/image-20260130222131221-DrlDpLoL.png",i="/assets/image-20260131152442582-DczCnsFW.png",c="/assets/image-20260131152550752-Bj4D8hnv.png",o="/assets/image-20260131163051314-Bycn3i9_.png",r={};function u(d,s){return l(),n("div",null,[...s[0]||(s[0]=[e(`<h2 id="一、alertmanager概述" tabindex="-1"><a class="header-anchor" href="#一、alertmanager概述"><span>一、Alertmanager概述</span></a></h2><h3 id="_1-1-什么是alertmanager" tabindex="-1"><a class="header-anchor" href="#_1-1-什么是alertmanager"><span>1.1 什么是Alertmanager？</span></a></h3><p>Alertmanager是一个独立的告警管理模块，主要功能包括：</p><ul><li>接收Prometheus等客户端发来的警报</li><li>通过分组、删除重复等处理</li><li>将警报路由发送给正确的接收器</li><li>支持多种告警方式（Email, Slack, Webhook等）</li></ul><h3 id="_1-2-架构图说明" tabindex="-1"><a class="header-anchor" href="#_1-2-架构图说明"><span>1.2 架构图说明</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Prometheus (监控指标) → Alertmanager (告警管理) → 接收器 (邮件/钉钉/Slack等)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><hr><h2 id="二、安装和配置alertmanager" tabindex="-1"><a class="header-anchor" href="#二、安装和配置alertmanager"><span>二、安装和配置Alertmanager</span></a></h2><h3 id="_2-1-安装方式" tabindex="-1"><a class="header-anchor" href="#_2-1-安装方式"><span>2.1 安装方式</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 下载二进制文件</span></span>
<span class="line"><span class="token function">wget</span> https://github.com/prometheus/alertmanager/releases/download/v0.27.0/alertmanager-0.27.0.linux-amd64.tar.gz</span>
<span class="line"><span class="token function">tar</span> xf alertmanager-0.27.0.linux-amd64.tar.gz</span>
<span class="line"><span class="token function">mkdir</span> /alertmanager</span>
<span class="line"><span class="token function">mv</span> alertmanager-0.27.0.linux-amd64/ /alertmanager</span>
<span class="line"><span class="token builtin class-name">cd</span> /alertmanager/</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-启动" tabindex="-1"><a class="header-anchor" href="#_2-2-启动"><span>2.2 启动</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">/alertmanager/alertmanager <span class="token parameter variable">--config.file</span><span class="token operator">=</span>/alertmanager/alertmanager.yml <span class="token operator">&amp;</span></span>
<span class="line">后台运行启动Alertmanager，先选用最初的配置内容，然后通过ConfigMap来动态改变配置文件。</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="三、kubernetes部署配置" tabindex="-1"><a class="header-anchor" href="#三、kubernetes部署配置"><span>三、Kubernetes部署配置</span></a></h2><h3 id="_3-1-configmap配置" tabindex="-1"><a class="header-anchor" href="#_3-1-configmap配置"><span>3.1 ConfigMap配置</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token comment"># config.yml</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    global: </span>
<span class="line">      # 当alertmanager持续多长时间未接收到告警后标记告警状态为 resolved</span>
<span class="line">      resolve_timeout: 5m</span>
<span class="line">      # 配置邮件发送信息</span>
<span class="line">      smtp_smarthost: &#39;smtp.163.com:25&#39;</span>
<span class="line">      smtp_from: &#39;wangyp903@163.com&#39;</span>
<span class="line">      smtp_auth_username: &#39;wangyp903@163.com&#39;</span>
<span class="line">      smtp_auth_password: &#39;SUiDJwfZuSTLgUv4&#39;</span>
<span class="line">      smtp_require_tls: false</span>
<span class="line">      </span>
<span class="line">    # 所有报警信息进入后的根路由，用来设置报警的分发策略</span>
<span class="line">    route:</span>
<span class="line">      # 接收到的报警信息里面有许多alertname=NodeLoadHigh 这样的标签的报警信息将会批量被聚合到一个分组里面</span>
<span class="line">      group_by: [&#39;alertname&#39;]</span>
<span class="line">      # 当一个新的报警分组被创建后，需要等待至少 group_wait 时间来初始化通知，如果在等待时间内当前group接收到了新的告警，这些告警将会合并为一个通知向receiver发送</span>
<span class="line">      group_wait: 30s</span>
<span class="line">      # 相同的group发送告警通知的时间间隔</span>
<span class="line">      group_interval: 30s</span>
<span class="line">      # 如果一个报警信息已经发送成功了，等待 repeat_interval 时间来重新发送</span>
<span class="line">      repeat_interval: 1m</span>
<span class="line">      # 默认的receiver：如果一个报警没有被一个route匹配，则发送给默认的接收器</span>
<span class="line">      receiver: default</span></span>
<span class="line"></span>
<span class="line">      <span class="token comment"># 上面所有的属性都由所有子路由继承，并且可以在每个子路由上进行覆盖。</span></span>
<span class="line">      <span class="token key atrule">routes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment"># 配置告警接收者的信息</span></span>
<span class="line">    <span class="token key atrule">receivers</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&#39;default&#39;</span></span>
<span class="line">      <span class="token key atrule">email_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span> <span class="token string">&#39;3341786550@qq.com&#39;</span></span>
<span class="line">        <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 接受告警恢复的通知</span></span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-后端pod等资源配置" tabindex="-1"><a class="header-anchor" href="#_3-2-后端pod等资源配置"><span>3.2 后端pod等资源配置</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> prom/alertmanager<span class="token punctuation">:</span>v0.27.0</span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">&quot;--config.file=/etc/alertmanager/config.yml&quot;</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">&quot;--log.level=debug&quot;</span></span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">9093</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> http</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/alertmanager&quot;</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> config</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9093</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">ingressClassName</span><span class="token punctuation">:</span> nginx</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> alert.qwe.cn</span>
<span class="line">    <span class="token key atrule">http</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">paths</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /</span>
<span class="line">        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix</span>
<span class="line">        <span class="token key atrule">backend</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">service</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager</span>
<span class="line">            <span class="token key atrule">port</span><span class="token punctuation">:</span></span>
<span class="line">              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">9093</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl apply <span class="token parameter variable">-f</span> config.yaml<span class="token comment"># 或者 准备好config.yml文件 然后 kubectl -n monitor create configmap prometheus-config --from-file=config.yml</span></span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> pod.yaml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="四、配置prometheus连接alertmanager" tabindex="-1"><a class="header-anchor" href="#四、配置prometheus连接alertmanager"><span>四、配置Prometheus连接Alertmanager</span></a></h2><h3 id="_4-1-修改prometheus-yml" tabindex="-1"><a class="header-anchor" href="#_4-1-修改prometheus-yml"><span>4.1 修改Prometheus.yml</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token comment"># prometheus.yml</span></span>
<span class="line"><span class="token key atrule">global</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s <span class="token comment"># Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span>
<span class="line">  <span class="token key atrule">evaluation_interval</span><span class="token punctuation">:</span> 15s <span class="token comment"># Evaluate rules every 15 seconds. The default is every 1 minute.</span></span>
<span class="line">  <span class="token comment"># scrape_timeout is set to the global default (10s).</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Alertmanager configuration</span></span>
<span class="line"><span class="token key atrule">alerting</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> alertmanager<span class="token punctuation">:</span><span class="token number">9093</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span></span>
<span class="line"><span class="token key atrule">rule_files</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> /etc/prometheus/alert_rules.yml</span>
<span class="line">  <span class="token comment"># - &quot;first_rules.yml&quot;</span></span>
<span class="line">  <span class="token comment"># - &quot;second_rules.yml&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># A scrape configuration containing exactly one endpoint to scrape:</span></span>
<span class="line"><span class="token comment"># Here it&#39;s Prometheus itself.</span></span>
<span class="line"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token comment"># The job name is added as a label \`job=&lt;job_name&gt;\` to any timeseries scraped from this config.</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">&quot;prometheus&quot;</span></span>
<span class="line">    <span class="token comment"># metrics_path defaults to &#39;/metrics&#39;</span></span>
<span class="line">    <span class="token comment"># scheme defaults to &#39;http&#39;.</span></span>
<span class="line">    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;localhost:9090&quot;</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token comment"># The label name is added as a label \`label_name=&lt;label_value&gt;\` to any timeseries scraped from this config.</span></span>
<span class="line">        <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">app</span><span class="token punctuation">:</span> <span class="token string">&quot;prometheus&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-2-配置文件更新技巧" tabindex="-1"><a class="header-anchor" href="#_4-2-配置文件更新技巧"><span>4.2 配置文件更新技巧</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 从容器中导出配置文件</span></span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor get pods</span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor <span class="token builtin class-name">exec</span> prometheus-6497d6f8bc-qp9tx -- <span class="token function">cat</span> /etc/prometheus/prometheus.yml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-3创建告警规则" tabindex="-1"><a class="header-anchor" href="#_4-3创建告警规则"><span>4.3创建告警规则</span></a></h3><h4 id="告警规则示例" tabindex="-1"><a class="header-anchor" href="#告警规则示例"><span>告警规则示例</span></a></h4><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token comment"># alert_rules.yml</span></span>
<span class="line"><span class="token key atrule">groups</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> node_metrics</span>
<span class="line">  <span class="token key atrule">rules</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> NodeLoad</span>
<span class="line">    <span class="token key atrule">expr</span><span class="token punctuation">:</span> node_load15 &lt; 1  <span class="token comment"># 监控指标表达式 过去15分钟的平均负载</span></span>
<span class="line">    <span class="token key atrule">for</span><span class="token punctuation">:</span> 2m                <span class="token comment"># 持续时间</span></span>
<span class="line">    <span class="token key atrule">annotations</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">summary</span><span class="token punctuation">:</span> <span class="token string">&quot;Low node load detected on {{ $labels.instance }}&quot;</span></span>
<span class="line">      <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">&quot;Node load is below 1 (current value: {{ $value }})&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="告警规则要素说明" tabindex="-1"><a class="header-anchor" href="#告警规则要素说明"><span>告警规则要素说明</span></a></h4><table><thead><tr><th style="text-align:left;">要素</th><th style="text-align:left;">说明</th><th style="text-align:left;">示例</th></tr></thead><tbody><tr><td style="text-align:left;"><code>alert</code></td><td style="text-align:left;">告警名称</td><td style="text-align:left;">NodeLoad</td></tr><tr><td style="text-align:left;"><code>expr</code></td><td style="text-align:left;">PromQL表达式</td><td style="text-align:left;">node_load15 &gt; 1</td></tr><tr><td style="text-align:left;"><code>for</code></td><td style="text-align:left;">持续时间</td><td style="text-align:left;">2m</td></tr><tr><td style="text-align:left;"><code>labels</code></td><td style="text-align:left;">自定义标签</td><td style="text-align:left;">severity: warning</td></tr><tr><td style="text-align:left;"><code>annotations</code></td><td style="text-align:left;">告警描述信息</td><td style="text-align:left;">summary, description</td></tr></tbody></table><h4 id="告警状态说明" tabindex="-1"><a class="header-anchor" href="#告警状态说明"><span>告警状态说明</span></a></h4><ul><li><strong>Inactive</strong>: 未触发告警条件</li><li><strong>Pending</strong>: 触发条件但未达到持续时间</li><li><strong>Firing</strong>: 触发条件且达到持续时间，正在发送告警</li></ul><h3 id="_4-4更新configmap" tabindex="-1"><a class="header-anchor" href="#_4-4更新configmap"><span>4.4更新ConfigMap</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl <span class="token parameter variable">-n</span> monitor delete configmaps prometheus-config</span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor create configmap prometheus-config --from-file<span class="token operator">=</span>/kube/prometheus/config/prometheus.yml --from-file<span class="token operator">=</span>/kube/prometheus/config/alert_rules.yml</span>
<span class="line"></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token number">10.1</span>.218.72:9090/-/reload</span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor <span class="token builtin class-name">exec</span>  prometheus-6497d6f8bc-qp9tx -- <span class="token function">ls</span> /etc/prometheus/</span>
<span class="line"><span class="token comment"># alert_rules.yml</span></span>
<span class="line"><span class="token comment"># prometheus.yml</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_4-4重载普罗米修斯" tabindex="-1"><a class="header-anchor" href="#_4-4重载普罗米修斯"><span>4.4重载普罗米修斯</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl <span class="token parameter variable">-n</span> monitor get svc prometheus</span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token number">10.1</span>.218.72:9090/-/reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+p+`" alt="image-20260130221810585"></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">设置了node_load15 <span class="token operator">&lt;</span> <span class="token number">1</span>则报警</span>
<span class="line"><span class="token comment"># 过去15分钟内系统平均负载小于1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+t+`" alt="image-20260130222131221"></p><hr><h2 id="五、钉钉告警集成" tabindex="-1"><a class="header-anchor" href="#五、钉钉告警集成"><span>五、钉钉告警集成</span></a></h2><h3 id="_5-1-钉钉机器人创建" tabindex="-1"><a class="header-anchor" href="#_5-1-钉钉机器人创建"><span>5.1 钉钉机器人创建</span></a></h3><ol><li>在钉钉群中添加自定义机器人</li><li>获取Webhook地址：<code>https://oapi.dingtalk.com/robot/send?access_token=your_token</code></li><li>alertmanager系统配置的webhook发送的JSON格式，是和钉钉API的字段不符的，没法直接用</li></ol><h3 id="_5-2-部署prometheus-webhook-dingtalk" tabindex="-1"><a class="header-anchor" href="#_5-2-部署prometheus-webhook-dingtalk"><span>5.2 部署prometheus-webhook-dingtalk</span></a></h3><p>prometheus-webhook-dingtalk</p><p>一个第三方的告警通知插件，用于将 Prometheus 的告警信息发送到钉钉群组。</p><h4 id="_5-2-1-configmap配置" tabindex="-1"><a class="header-anchor" href="#_5-2-1-configmap配置"><span>5.2.1 ConfigMap配置</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">mkdir</span> /alertmanager/ding <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> /alertmanager/ding</span>
<span class="line"><span class="token function">vim</span> configmap.yml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk<span class="token punctuation">-</span>config</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"><span class="token key atrule">data</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">config.yml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span>
<span class="line">    targets:</span>
<span class="line">      webhook_ops:</span>
<span class="line">        url: https://oapi.dingtalk.com/robot/send?access_token=427d011ae8fa314518c7796538a89480d7155884566a923451068774f651ae93</span>
<span class="line">        secret: &quot;SEC2b36fe35b72d9287ab93c52ce46e05a344be04dc0b8fbcee36003a88035a8e97&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl apply <span class="token parameter variable">-f</span> configmap.yml</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h4 id="_5-2-2-后端pod等资源配置" tabindex="-1"><a class="header-anchor" href="#_5-2-2-后端pod等资源配置"><span>5.2.2 后端pod等资源配置</span></a></h4><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">app</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk</span>
<span class="line">  <span class="token key atrule">template</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">labels</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token key atrule">app</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk</span>
<span class="line">    <span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">containers</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk</span>
<span class="line">        <span class="token key atrule">image</span><span class="token punctuation">:</span> timonwong/prometheus<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>dingtalk<span class="token punctuation">:</span>master</span>
<span class="line">        <span class="token key atrule">args</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token string">&quot;--config.file=/etc/prometheus-webhook-dingtalk/config.yml&quot;</span></span>
<span class="line">        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent</span>
<span class="line">        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">&quot;/etc/prometheus-webhook-dingtalk/config.yml&quot;</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> config</span>
<span class="line">          <span class="token key atrule">subPath</span><span class="token punctuation">:</span> config.yml</span>
<span class="line">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8060</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> http</span>
<span class="line">        <span class="token key atrule">resources</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">requests</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 50m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi</span>
<span class="line">          <span class="token key atrule">limits</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 50m</span>
<span class="line">            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi</span>
<span class="line">      <span class="token key atrule">volumes</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config</span>
<span class="line">        <span class="token key atrule">configMap</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk<span class="token punctuation">-</span>config</span>
<span class="line">          <span class="token key atrule">items</span><span class="token punctuation">:</span></span>
<span class="line">          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> config.yml</span>
<span class="line">            <span class="token key atrule">path</span><span class="token punctuation">:</span> config.yml</span>
<span class="line"><span class="token punctuation">---</span></span>
<span class="line"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1</span>
<span class="line"><span class="token key atrule">kind</span><span class="token punctuation">:</span> Service</span>
<span class="line"><span class="token key atrule">metadata</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk</span>
<span class="line">  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitor</span>
<span class="line"><span class="token key atrule">spec</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">selector</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">app</span><span class="token punctuation">:</span> webhook<span class="token punctuation">-</span>dingtalk</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hook</span>
<span class="line">      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8060</span></span>
<span class="line">      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> http</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">vim</span> webhook.yaml</span>
<span class="line">kubectl apply <span class="token parameter variable">-f</span> webhook.yaml</span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor get po</span>
<span class="line"><span class="token punctuation">[</span>root@k8s-master-10 /alertmanager/ding<span class="token punctuation">]</span><span class="token comment">#kubectl -n monitor logs webhook-dingtalk-7dbfb87c85-4qxw8 </span></span>
<span class="line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.318Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>main.go:60 <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Starting prometheus-webhook-dingtalk&quot;</span> <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">&quot;(version=2.0.0, branch=master, revision=4e77a3cc3e7a23fcb18b33826bce8d2904583465)&quot;</span></span>
<span class="line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.318Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>main.go:61 <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Build context&quot;</span> <span class="token punctuation">(</span>gogo1.16.7,userroot@337ecc9a2774,date20210819-13:17:15<span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span>MISSING<span class="token punctuation">)</span></span>
<span class="line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.318Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>coordinator.go:83 <span class="token assign-left variable">component</span><span class="token operator">=</span>configuration <span class="token assign-left variable">file</span><span class="token operator">=</span>/etc/prometheus-webhook-dingtalk/config.yml <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Loading configuration file&quot;</span></span>
<span class="line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.318Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>coordinator.go:91 <span class="token assign-left variable">component</span><span class="token operator">=</span>configuration <span class="token assign-left variable">file</span><span class="token operator">=</span>/etc/prometheus-webhook-dingtalk/config.yml <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Completed loading of configuration file&quot;</span></span>
<span class="line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.318Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>main.go:98 <span class="token assign-left variable">component</span><span class="token operator">=</span>configuration <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Loading templates&quot;</span> <span class="token assign-left variable">templates</span><span class="token operator">=</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.319Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>main.go:114 <span class="token assign-left variable">component</span><span class="token operator">=</span>configuration <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Webhook urls for prometheus alertmanager&quot;</span> <span class="token assign-left variable">urls</span><span class="token operator">=</span>http://localhost:8060/dingtalk/webhook_ops/send</span>
<span class="line"><span class="token assign-left variable">level</span><span class="token operator">=</span>info <span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-30T14:42:20.319Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>web.go:210 <span class="token assign-left variable">component</span><span class="token operator">=</span>web <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Start listening for connections&quot;</span> <span class="token assign-left variable">address</span><span class="token operator">=</span>:8060</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>根据日志可以看出，prometheus-webhook-dingtalk已经成功启动，并且已经加载了配置文件<code>/etc/prometheus-webhook-dingtalk/config.yml</code>，同时也加载了模板。</p><p>另外，也可以看到它监听的端口是<code>8060</code>，可以通过地址<code>http://localhost:8060/dingtalk/webhook_ops/send</code>来接收来自Alertmanager的告警信息。</p><h3 id="_5-3-配置alertmanager-webhook接收器" tabindex="-1"><a class="header-anchor" href="#_5-3-配置alertmanager-webhook接收器"><span>5.3 配置Alertmanager Webhook接收器</span></a></h3><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">receivers</span><span class="token punctuation">:</span></span>
<span class="line"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&#39;default&#39;</span></span>
<span class="line">  <span class="token key atrule">webhook_configs</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token punctuation">-</span> <span class="token key atrule">send_resolved</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></span>
<span class="line">    <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//webhook<span class="token punctuation">-</span>dingtalk<span class="token punctuation">:</span>8060/dingtalk/webhook_ops/send</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl <span class="token parameter variable">-n</span> monitor <span class="token builtin class-name">exec</span> alertmanager-8d4585fbd-vjbh5 -- <span class="token function">cat</span> /etc/alertmanager/config.yml <span class="token operator">&gt;</span> config.yml</span>
<span class="line"><span class="token comment"># 添加 webhook_configs到对应位置</span></span>
<span class="line"><span class="token function">vim</span> config.yml</span>
<span class="line"></span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor delete cm alertmanager</span>
<span class="line">kubectl <span class="token parameter variable">-n</span> monitor create configmap alertmanager --from-file<span class="token operator">=</span>config.yml</span>
<span class="line"></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token number">10.1</span>.218.72:9090/-/reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="日志" tabindex="-1"><a class="header-anchor" href="#日志"><span>日志</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl <span class="token parameter variable">-n</span> monitor logs alertmanager-7679b9b9d-pfmpv</span>
<span class="line"></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:19:21.494Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>dispatch.go:516 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">aggrGroup</span><span class="token operator">=</span><span class="token string">&quot;{}:{alertname=<span class="token entity" title="\\&quot;">\\&quot;</span>NodeLoad<span class="token entity" title="\\&quot;">\\&quot;</span>}&quot;</span> <span class="token assign-left variable">msg</span><span class="token operator">=</span>flushing <span class="token assign-left variable">alerts</span><span class="token operator">=</span><span class="token string">&quot;[NodeLoad[a3a4121][active] NodeLoad[7b22ce9][active] NodeLoad[634288c][active]]&quot;</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:19:51.496Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>dispatch.go:516 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">aggrGroup</span><span class="token operator">=</span><span class="token string">&quot;{}:{alertname=<span class="token entity" title="\\&quot;">\\&quot;</span>NodeLoad<span class="token entity" title="\\&quot;">\\&quot;</span>}&quot;</span> <span class="token assign-left variable">msg</span><span class="token operator">=</span>flushing <span class="token assign-left variable">alerts</span><span class="token operator">=</span><span class="token string">&quot;[NodeLoad[a3a4121][active] NodeLoad[7b22ce9][active] NodeLoad[634288c][active]]&quot;</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:20:21.479Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>dispatch.go:164 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Received alert&quot;</span> <span class="token assign-left variable">alert</span><span class="token operator">=</span>NodeLoad<span class="token punctuation">[</span>a3a4121<span class="token punctuation">]</span><span class="token punctuation">[</span>active<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:20:21.479Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>dispatch.go:164 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Received alert&quot;</span> <span class="token assign-left variable">alert</span><span class="token operator">=</span>NodeLoad<span class="token punctuation">[</span>7b22ce9<span class="token punctuation">]</span><span class="token punctuation">[</span>active<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:20:21.479Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>dispatch.go:164 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Received alert&quot;</span> <span class="token assign-left variable">alert</span><span class="token operator">=</span>NodeLoad<span class="token punctuation">[</span>634288c<span class="token punctuation">]</span><span class="token punctuation">[</span>active<span class="token punctuation">]</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:20:21.496Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>dispatch.go:516 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">aggrGroup</span><span class="token operator">=</span><span class="token string">&quot;{}:{alertname=<span class="token entity" title="\\&quot;">\\&quot;</span>NodeLoad<span class="token entity" title="\\&quot;">\\&quot;</span>}&quot;</span> <span class="token assign-left variable">msg</span><span class="token operator">=</span>flushing <span class="token assign-left variable">alerts</span><span class="token operator">=</span><span class="token string">&quot;[NodeLoad[a3a4121][active] NodeLoad[7b22ce9][active] NodeLoad[634288c][active]]&quot;</span></span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:20:21.664Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>notify.go:860 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">receiver</span><span class="token operator">=</span>default <span class="token assign-left variable">integration</span><span class="token operator">=</span>webhook<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token assign-left variable">aggrGroup</span><span class="token operator">=</span><span class="token string">&quot;{}:{alertname=<span class="token entity" title="\\&quot;">\\&quot;</span>NodeLoad<span class="token entity" title="\\&quot;">\\&quot;</span>}&quot;</span> <span class="token assign-left variable">alerts</span><span class="token operator">=</span><span class="token string">&quot;[NodeLoad[a3a4121][active] NodeLoad[7b22ce9][active] NodeLoad[634288c][active]]&quot;</span> <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Notify success&quot;</span> <span class="token assign-left variable">attempts</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">duration</span><span class="token operator">=</span><span class="token number">168</span>.075551ms</span>
<span class="line"><span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2026</span>-01-31T07:20:22.015Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>notify.go:860 <span class="token assign-left variable">level</span><span class="token operator">=</span>debug <span class="token assign-left variable">component</span><span class="token operator">=</span>dispatcher <span class="token assign-left variable">receiver</span><span class="token operator">=</span>default <span class="token assign-left variable">integration</span><span class="token operator">=</span>email<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token assign-left variable">aggrGroup</span><span class="token operator">=</span><span class="token string">&quot;{}:{alertname=<span class="token entity" title="\\&quot;">\\&quot;</span>NodeLoad<span class="token entity" title="\\&quot;">\\&quot;</span>}&quot;</span> <span class="token assign-left variable">alerts</span><span class="token operator">=</span><span class="token string">&quot;[NodeLoad[a3a4121][active] NodeLoad[7b22ce9][active] NodeLoad[634288c][active]]&quot;</span> <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;Notify success&quot;</span> <span class="token assign-left variable">attempts</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">duration</span><span class="token operator">=</span><span class="token number">518</span>.473158ms</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+i+`" alt="image-20260131152442582"></p><h3 id="测试钉钉" tabindex="-1"><a class="header-anchor" href="#测试钉钉"><span>测试钉钉</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># kubectl -n monitor exec -it curl-test -- sh</span></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST http://webhook-dingtalk.monitor.svc.cluster.local:8060/dingtalk/webhook_ops/send <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-H</span> <span class="token string">&#39;Content-Type: application/json&#39;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">-d</span> <span class="token string">&#39;{</span>
<span class="line">    &quot;status&quot;: &quot;firing&quot;,</span>
<span class="line">    &quot;alerts&quot;: [</span>
<span class="line">      {</span>
<span class="line">        &quot;status&quot;: &quot;firing&quot;,</span>
<span class="line">        &quot;labels&quot;: {</span>
<span class="line">          &quot;alertname&quot;: &quot;NodeLoad&quot;,</span>
<span class="line">          &quot;instance&quot;: &quot;k8s-node-11&quot;,</span>
<span class="line">          &quot;severity&quot;: &quot;warning&quot;</span>
<span class="line">        },</span>
<span class="line">        &quot;annotations&quot;: {</span>
<span class="line">          &quot;summary&quot;: &quot;test&quot;,</span>
<span class="line">          &quot;description&quot;: &quot;test&quot;</span>
<span class="line">        },</span>
<span class="line">        &quot;startsAt&quot;: &quot;2026-01-30T17:00:00Z&quot;</span>
<span class="line">      }</span>
<span class="line">    ]</span>
<span class="line">  }&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+c+`" alt="image-20260131152550752"></p><hr><h2 id="调整报警条件" tabindex="-1"><a class="header-anchor" href="#调整报警条件"><span>调整报警条件</span></a></h2><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">kubectl <span class="token parameter variable">-n</span> monitor edit cm prometheus-config</span>
<span class="line"></span>
<span class="line">groups:</span>
<span class="line">    - name: node_metrics</span>
<span class="line">      rules:</span>
<span class="line">      - alert: NodeLoad</span>
<span class="line">        expr: node_load15 <span class="token operator">&gt;</span> <span class="token number">1</span>  <span class="token comment"># 监控指标表达式</span></span>
<span class="line">        for: 2m                <span class="token comment"># 持续时间</span></span>
<span class="line">        annotations:</span>
<span class="line">          summary: <span class="token string">&quot;high node load detected on {{ <span class="token variable">$labels</span>.instance }}&quot;</span></span>
<span class="line">          description: <span class="token string">&quot;Node load is above 1 (current value: {{ <span class="token variable">$value</span> }})&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token function">curl</span> <span class="token parameter variable">-X</span> POST <span class="token number">10.1</span>.218.72:9090/-/reload</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="`+o+'" alt="image-20260131163051314"></p>',68)])])}const m=a(r,[["render",u]]),v=JSON.parse('{"path":"/07-%E7%9B%91%E6%8E%A7%E4%BD%93%E7%B3%BB/02-prometheus%E7%9B%91%E6%8E%A7/AlertManager.html","title":"","lang":"zh-CN","frontmatter":{},"git":{"contributors":[{"name":"opsjjq","username":"opsjjq","email":"wangyp987@gmail.com","commits":1,"url":"https://github.com/opsjjq"}],"changelog":[{"hash":"ca8e661b7c6729c958583ed3d1a001b6de398273","time":1771558748000,"email":"wangyp987@gmail.com","author":"opsjjq","message":"222"}]},"filePathRelative":"07-监控体系/02-prometheus监控/AlertManager.md"}');export{m as comp,v as data};
