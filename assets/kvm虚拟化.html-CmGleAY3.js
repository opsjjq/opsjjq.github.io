import{_ as n,c as a,e,o as t}from"./app-DtXLoKBz.js";const l={};function i(p,s){return t(),a("div",null,[...s[0]||(s[0]=[e(`<h1 id="kvm虚拟化技术全解" tabindex="-1"><a class="header-anchor" href="#kvm虚拟化技术全解"><span>KVM虚拟化技术全解</span></a></h1><hr><h2 id="一、虚拟化历史与背景" tabindex="-1"><a class="header-anchor" href="#一、虚拟化历史与背景"><span>一、虚拟化历史与背景</span></a></h2><h3 id="_1-1-虚拟化的演进过程" tabindex="-1"><a class="header-anchor" href="#_1-1-虚拟化的演进过程"><span>1.1 虚拟化的演进过程</span></a></h3><table><thead><tr><th style="text-align:left;">阶段</th><th style="text-align:left;">特征</th><th style="text-align:left;">问题</th></tr></thead><tbody><tr><td style="text-align:left;">单机时代</td><td style="text-align:left;">单一物理服务器运行CentOS系统，部署多个LNMP集群</td><td style="text-align:left;">端口、进程、文件系统路径冲突，管理复杂</td></tr><tr><td style="text-align:left;">虚拟机解决方案</td><td style="text-align:left;">通过虚拟化技术创建隔离的运行环境</td><td style="text-align:left;">业务增长导致虚拟机数量激增，服务器负载压力增大</td></tr></tbody></table><h3 id="_1-2-企业级虚拟化对比" tabindex="-1"><a class="header-anchor" href="#_1-2-企业级虚拟化对比"><span>1.2 企业级虚拟化对比</span></a></h3><table><thead><tr><th style="text-align:left;">方案</th><th style="text-align:left;">组件</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>VMware vSphere</strong></td><td style="text-align:left;">ESXi + vCenter</td><td style="text-align:left;">企业级商业虚拟化解决方案</td></tr><tr><td style="text-align:left;"><strong>开源替代</strong></td><td style="text-align:left;">KVM + OpenStack</td><td style="text-align:left;">Linux内核原生虚拟化模块</td></tr></tbody></table><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">虚拟化关系图谱：</span>
<span class="line">VMware vSphere → ESXi + vCenter</span>
<span class="line">开源替代 → KVM + OpenStack</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="二、kvm虚拟化基础" tabindex="-1"><a class="header-anchor" href="#二、kvm虚拟化基础"><span>二、KVM虚拟化基础</span></a></h2><h3 id="_2-1-虚拟化类型" tabindex="-1"><a class="header-anchor" href="#_2-1-虚拟化类型"><span>2.1 虚拟化类型</span></a></h3><table><thead><tr><th style="text-align:left;">类型</th><th style="text-align:left;">特征</th><th style="text-align:left;">性能</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>完全虚拟化</strong></td><td style="text-align:left;">客户机无需修改系统</td><td style="text-align:left;">兼容性好但性能较低</td></tr><tr><td style="text-align:left;"><strong>半虚拟化</strong></td><td style="text-align:left;">客户机需修改系统内核</td><td style="text-align:left;">性能较高</td></tr><tr><td style="text-align:left;"><strong>硬件辅助虚拟化</strong></td><td style="text-align:left;">利用Intel VT-x/AMD-V技术</td><td style="text-align:left;">性能最佳</td></tr></tbody></table><h3 id="_2-2-虚拟化优势" tabindex="-1"><a class="header-anchor" href="#_2-2-虚拟化优势"><span>2.2 虚拟化优势</span></a></h3><table><thead><tr><th style="text-align:left;">优势</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">资源隔离</td><td style="text-align:left;">CPU、内存、存储、网络资源完全隔离</td></tr><tr><td style="text-align:left;">环境隔离</td><td style="text-align:left;">不同应用运行在独立环境，互不干扰</td></tr><tr><td style="text-align:left;">快速部署</td><td style="text-align:left;">模板化部署，快速创建和复制虚拟机</td></tr><tr><td style="text-align:left;">灵活迁移</td><td style="text-align:left;">支持虚拟机在不同物理主机间迁移</td></tr><tr><td style="text-align:left;">高可用性</td><td style="text-align:left;">故障时自动迁移到其他主机，保障业务连续性</td></tr></tbody></table><hr><h2 id="三、kvm部署实践" tabindex="-1"><a class="header-anchor" href="#三、kvm部署实践"><span>三、KVM部署实践</span></a></h2><h3 id="_3-1-环境准备" tabindex="-1"><a class="header-anchor" href="#_3-1-环境准备"><span>3.1 环境准备</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 检查CPU是否支持虚拟化</span></span>
<span class="line"><span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">&#39;(vmx|svm)&#39;</span> /proc/cpuinfo</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 安装KVM及相关管理工具</span></span>
<span class="line">yum <span class="token function">install</span> libvirt virt-install qemu-kvm <span class="token parameter variable">-y</span></span>
<span class="line"><span class="token comment"># 或安装所有相关包</span></span>
<span class="line">yum <span class="token function">install</span> libvirt* virt-* qemu-kvm* <span class="token parameter variable">-y</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动并启用libvirtd服务</span></span>
<span class="line">systemctl start libvirtd.service</span>
<span class="line">systemctl <span class="token builtin class-name">enable</span> libvirtd.service</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-vnc远程连接配置" tabindex="-1"><a class="header-anchor" href="#_3-2-vnc远程连接配置"><span>3.2 VNC远程连接配置</span></a></h3><table><thead><tr><th style="text-align:left;">特点</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">VNC提供</td><td style="text-align:left;">图形化远程访问能力</td></tr><tr><td style="text-align:left;">SSH无法连接时</td><td style="text-align:left;">VNC仍可访问虚拟机控制台</td></tr><tr><td style="text-align:left;">推荐工具</td><td style="text-align:left;">TightVNC Client</td></tr></tbody></table><h3 id="_3-3-创建第一个虚拟机" tabindex="-1"><a class="header-anchor" href="#_3-3-创建第一个虚拟机"><span>3.3 创建第一个虚拟机</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">virt-install --virt-type kvm --os-type<span class="token operator">=</span>linux --os-variant rhel7 <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--name</span> kvm_centos7 <span class="token parameter variable">--memory</span> <span class="token number">2048</span>,maxmemory<span class="token operator">=</span><span class="token number">4096</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--vcpus</span> <span class="token number">2</span>,maxvcpus<span class="token operator">=</span><span class="token number">8</span> <span class="token parameter variable">--disk</span> /data/kvm_centos7.raw,format<span class="token operator">=</span>raw,size<span class="token operator">=</span><span class="token number">10</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--cdrom</span> /data/CentOS-7-x86_64-DVD-1804.iso <span class="token parameter variable">--network</span> <span class="token assign-left variable">network</span><span class="token operator">=</span>default <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--graphics</span> vnc,listen<span class="token operator">=</span><span class="token number">0.0</span>.0.0 <span class="token parameter variable">--noautoconsole</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>创建虚拟机命令详解：</strong></p><table><thead><tr><th style="text-align:left;">参数</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><code>--virt-type kvm</code></td><td style="text-align:left;">虚拟化类型</td></tr><tr><td style="text-align:left;"><code>--os-type=linux</code></td><td style="text-align:left;">操作系统类型</td></tr><tr><td style="text-align:left;"><code>--os-variant rhel7</code></td><td style="text-align:left;">系统变体</td></tr><tr><td style="text-align:left;"><code>--name kvm_centos7</code></td><td style="text-align:left;">虚拟机名称</td></tr><tr><td style="text-align:left;"><code>--memory 2048,maxmemory=4096</code></td><td style="text-align:left;">内存配置</td></tr><tr><td style="text-align:left;"><code>--vcpus 2,maxvcpus=8</code></td><td style="text-align:left;">CPU配置</td></tr><tr><td style="text-align:left;"><code>--disk /data/kvm_centos7.raw,format=raw,size=10</code></td><td style="text-align:left;">磁盘配置</td></tr><tr><td style="text-align:left;"><code>--cdrom /data/CentOS-7-x86_64-DVD-1804.iso</code></td><td style="text-align:left;">安装镜像</td></tr><tr><td style="text-align:left;"><code>--network network=default</code></td><td style="text-align:left;">网络配置</td></tr><tr><td style="text-align:left;"><code>--graphics vnc,listen=0.0.0.0</code></td><td style="text-align:left;">VNC配置</td></tr></tbody></table><p><strong>稀疏文件解释：</strong></p><p>稀疏文件创建时只分配实际写入数据的空间，而非立即分配全部空间，节省磁盘空间，随数据写入动态扩展。</p><h3 id="_3-4-虚拟机管理基础命令" tabindex="-1"><a class="header-anchor" href="#_3-4-虚拟机管理基础命令"><span>3.4 虚拟机管理基础命令</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 查看运行中的虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> list</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看所有虚拟机（包括关闭的）</span></span>
<span class="line"><span class="token function">virsh</span> list <span class="token parameter variable">--all</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 启动虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> start kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 正常关闭虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> <span class="token function">shutdown</span> kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 强制关闭虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> destroy kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 重启虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> <span class="token function">reboot</span> kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看VNC端口</span></span>
<span class="line"><span class="token function">virsh</span> vncdisplay kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看虚拟机IP地址</span></span>
<span class="line"><span class="token function">virsh</span> domifaddr kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看网络列表</span></span>
<span class="line"><span class="token function">virsh</span> net-list</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看DHCP租约</span></span>
<span class="line"><span class="token function">virsh</span> net-dhcp-leases default</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置虚拟机开机自启</span></span>
<span class="line"><span class="token function">virsh</span> autostart kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 虚拟机重命名</span></span>
<span class="line"><span class="token function">virsh</span> domrename centos7 web-7</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="四、vnc安装与使用" tabindex="-1"><a class="header-anchor" href="#四、vnc安装与使用"><span>四、VNC安装与使用</span></a></h2><h3 id="安装步骤" tabindex="-1"><a class="header-anchor" href="#安装步骤"><span>安装步骤</span></a></h3><table><thead><tr><th style="text-align:left;">步骤</th><th style="text-align:left;">操作</th></tr></thead><tbody><tr><td style="text-align:left;">1</td><td style="text-align:left;">下载TightVNC客户端</td></tr><tr><td style="text-align:left;">2</td><td style="text-align:left;">打开TightVNC Viewer</td></tr><tr><td style="text-align:left;">3</td><td style="text-align:left;">Host输入：<code>10.0.0.13:5900</code></td></tr><tr><td style="text-align:left;">4</td><td style="text-align:left;">按提示完成安装配置</td></tr></tbody></table><p><strong>下载链接：</strong></p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">https://www.tightvnc.com/download/2.8.85/tightvnc-2.8.85-gpl-setup-64bit.msi</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>注意事项：</strong></p><p>VNC界面安装系统后，可能无法正常重启，需返回宿主机使用<code>virsh start kvm_centos7</code>启动。</p><hr><h2 id="五、kvm高级管理" tabindex="-1"><a class="header-anchor" href="#五、kvm高级管理"><span>五、KVM高级管理</span></a></h2><h3 id="_5-1-虚拟机配置管理" tabindex="-1"><a class="header-anchor" href="#_5-1-虚拟机配置管理"><span>5.1 虚拟机配置管理</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 导出虚拟机配置</span></span>
<span class="line"><span class="token function">virsh</span> dumpxml kvm_centos7 <span class="token operator">&gt;</span> /data/config.xml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 从配置文件恢复虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> define /data/config.xml</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置开机自启</span></span>
<span class="line"><span class="token function">virsh</span> autostart kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 取消开机自启</span></span>
<span class="line"><span class="token function">virsh</span> autostart <span class="token parameter variable">--disable</span> kvm_centos7</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-磁盘管理" tabindex="-1"><a class="header-anchor" href="#_5-2-磁盘管理"><span>5.2 磁盘管理</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 创建新磁盘</span></span>
<span class="line">qemu-img create <span class="token parameter variable">-f</span> qcow2 /data/newdisk.qcow2 20G</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 调整磁盘大小</span></span>
<span class="line">qemu-img resize /data/disk.qcow2 +5G</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 磁盘格式转换</span></span>
<span class="line">qemu-img convert <span class="token parameter variable">-f</span> raw <span class="token parameter variable">-O</span> qcow2 input.raw output.qcow2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-快照管理" tabindex="-1"><a class="header-anchor" href="#_5-3-快照管理"><span>5.3 快照管理</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 创建快照</span></span>
<span class="line"><span class="token function">virsh</span> snapshot-create-as kvm_centos7 <span class="token operator">&lt;</span>快照名<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看快照列表</span></span>
<span class="line"><span class="token function">virsh</span> snapshot-list kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 恢复快照</span></span>
<span class="line"><span class="token function">virsh</span> snapshot-revert kvm_centos7 <span class="token operator">&lt;</span>快照名<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 删除快照</span></span>
<span class="line"><span class="token function">virsh</span> snapshot-delete kvm_centos7 <span class="token operator">&lt;</span>快照名<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-虚拟机克隆" tabindex="-1"><a class="header-anchor" href="#_5-4-虚拟机克隆"><span>5.4 虚拟机克隆</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 克隆虚拟机（需要先关机）</span></span>
<span class="line">virt-clone <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--original</span> <span class="token operator">&lt;</span>源虚拟机<span class="token operator">&gt;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--name</span> <span class="token operator">&lt;</span>新虚拟机名<span class="token operator">&gt;</span> <span class="token punctuation">\\</span></span>
<span class="line">  <span class="token parameter variable">--file</span> /data/<span class="token operator">&lt;</span>新磁盘文件<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-5-磁盘管理实战" tabindex="-1"><a class="header-anchor" href="#_5-5-磁盘管理实战"><span>5.5 磁盘管理实战</span></a></h3><h4 id="_1-克隆虚拟机" tabindex="-1"><a class="header-anchor" href="#_1-克隆虚拟机"><span>1. 克隆虚拟机</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 源虚拟机必须处于关闭或暂停状态</span></span>
<span class="line">virt-clone --auto-clone <span class="token parameter variable">-o</span> kvm_centos7 <span class="token parameter variable">-n</span> kvm2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-转换磁盘格式-raw-↔-qcow2" tabindex="-1"><a class="header-anchor" href="#_2-转换磁盘格式-raw-↔-qcow2"><span>2. 转换磁盘格式（raw ↔ qcow2）</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># raw转qcow2</span></span>
<span class="line">qemu-img convert <span class="token parameter variable">-f</span> raw <span class="token parameter variable">-O</span> qcow2 /data/kvm2.raw /data/kvm2.qcow2</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看磁盘配置</span></span>
<span class="line"><span class="token function">virsh</span> dumpxml kvm2 <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-A5</span> <span class="token string">&quot;source file&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修改虚拟机配置使用qcow2磁盘</span></span>
<span class="line"><span class="token function">virsh</span> edit kvm2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>配置文件修改：</strong></p><div class="language-xml line-numbers-mode" data-highlighter="prismjs" data-ext="xml"><pre><code class="language-xml"><span class="line"><span class="token comment">&lt;!-- 原配置（raw格式） --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disk</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>file<span class="token punctuation">&#39;</span></span> <span class="token attr-name">device</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>disk<span class="token punctuation">&#39;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>qemu<span class="token punctuation">&#39;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>raw<span class="token punctuation">&#39;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>/data/kvm2.raw<span class="token punctuation">&#39;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token comment">&lt;!-- ... --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disk</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token comment">&lt;!-- 修改后（qcow2格式） --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>disk</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>file<span class="token punctuation">&#39;</span></span> <span class="token attr-name">device</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>disk<span class="token punctuation">&#39;</span></span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>qemu<span class="token punctuation">&#39;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>qcow2<span class="token punctuation">&#39;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>source</span> <span class="token attr-name">file</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&#39;</span>/data/kvm2.qcow2<span class="token punctuation">&#39;</span></span><span class="token punctuation">/&gt;</span></span></span>
<span class="line">  <span class="token comment">&lt;!-- ... --&gt;</span></span>
<span class="line"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>disk</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_3-扩容虚拟机磁盘" tabindex="-1"><a class="header-anchor" href="#_3-扩容虚拟机磁盘"><span>3. 扩容虚拟机磁盘</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 创建新磁盘</span></span>
<span class="line">qemu-img create <span class="token parameter variable">-f</span> qcow2 add01.qcow2 1G</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 热添加磁盘（无需关机）</span></span>
<span class="line"><span class="token function">virsh</span> attach-disk kvm2 /data/add01.qcow2 vdb <span class="token parameter variable">--live</span> <span class="token parameter variable">--cache</span><span class="token operator">=</span>none <span class="token parameter variable">--subdriver</span><span class="token operator">=</span>qcow2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-6-迁移虚拟机磁盘文件" tabindex="-1"><a class="header-anchor" href="#_5-6-迁移虚拟机磁盘文件"><span>5.6 迁移虚拟机磁盘文件</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 1. 关闭虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> <span class="token function">shutdown</span> centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 2. 编辑虚拟机配置</span></span>
<span class="line"><span class="token function">virsh</span> edit centos7</span>
<span class="line"><span class="token comment"># 修改磁盘路径：/data/kvm_centos7.raw → /new_data/www.yuchaoit.cn.raw</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 3. 移动磁盘文件</span></span>
<span class="line"><span class="token function">mv</span> /data/kvm_centos7.raw /new_data/</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 4. 启动虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> start centos7</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="六、网络配置" tabindex="-1"><a class="header-anchor" href="#六、网络配置"><span>六、网络配置</span></a></h2><h3 id="_6-1-桥接网络配置" tabindex="-1"><a class="header-anchor" href="#_6-1-桥接网络配置"><span>6.1 桥接网络配置</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 创建桥接网络配置文件</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-br0 <span class="token operator">&lt;&lt;</span> <span class="token string">EOF</span>
<span class="line">DEVICE=br0</span>
<span class="line">TYPE=Bridge</span>
<span class="line">ONBOOT=yes</span>
<span class="line">BOOTPROTO=static</span>
<span class="line">IPADDR=10.0.0.150</span>
<span class="line">NETMASK=255.255.255.0</span>
<span class="line">GATEWAY=10.0.0.254</span>
<span class="line">DNS1=8.8.8.8</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修改物理网卡配置</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-ens33 <span class="token operator">&lt;&lt;</span> <span class="token string">EOF</span>
<span class="line">DEVICE=ens33</span>
<span class="line">ONBOOT=yes</span>
<span class="line">BRIDGE=br0</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 重启网络服务</span></span>
<span class="line">systemctl restart network</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-虚拟机使用桥接网络" tabindex="-1"><a class="header-anchor" href="#_6-2-虚拟机使用桥接网络"><span>6.2 虚拟机使用桥接网络</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 创建时指定桥接网络</span></span>
<span class="line"><span class="token parameter variable">--network</span> <span class="token assign-left variable">bridge</span><span class="token operator">=</span>br0</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 修改现有虚拟机网络配置</span></span>
<span class="line"><span class="token function">virsh</span> edit kvm_centos7</span>
<span class="line"><span class="token comment"># 将 &lt;source network=&#39;default&#39;/&gt; 改为 &lt;source bridge=&#39;br0&#39;/&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-快速创建桥接网络" tabindex="-1"><a class="header-anchor" href="#_6-3-快速创建桥接网络"><span>6.3 快速创建桥接网络</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 一键创建桥接</span></span>
<span class="line"><span class="token function">virsh</span> iface-bridge eth0 bro0</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 虚拟机内部配置静态IP</span></span>
<span class="line"><span class="token comment"># 编辑 /etc/sysconfig/network-scripts/ifcfg-eth0</span></span>
<span class="line"><span class="token assign-left variable">BOOTPROTO</span><span class="token operator">=</span><span class="token string">&quot;static&quot;</span></span>
<span class="line"><span class="token assign-left variable">IPADDR</span><span class="token operator">=</span><span class="token string">&quot;10.0.0.140&quot;</span></span>
<span class="line"><span class="token assign-left variable">NETMASK</span><span class="token operator">=</span><span class="token number">255.255</span>.255.0</span>
<span class="line"><span class="token assign-left variable">GATEWAY</span><span class="token operator">=</span><span class="token string">&quot;10.0.0.254&quot;</span></span>
<span class="line"><span class="token assign-left variable">DNS1</span><span class="token operator">=</span><span class="token string">&quot;223.5.5.5&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="七、热添加技术" tabindex="-1"><a class="header-anchor" href="#七、热添加技术"><span>七、热添加技术</span></a></h2><h3 id="_7-1-热添加磁盘" tabindex="-1"><a class="header-anchor" href="#_7-1-热添加磁盘"><span>7.1 热添加磁盘</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 创建新磁盘</span></span>
<span class="line">qemu-img create <span class="token parameter variable">-f</span> qcow2 /data/newdisk.qcow2 10G</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 热添加磁盘到运行中的虚拟机</span></span>
<span class="line"><span class="token function">virsh</span> attach-disk kvm_centos7 /data/newdisk.qcow2 vdb <span class="token parameter variable">--live</span> <span class="token parameter variable">--subdriver</span> qcow2</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-2-热添加网卡" tabindex="-1"><a class="header-anchor" href="#_7-2-热添加网卡"><span>7.2 热添加网卡</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 临时添加网卡</span></span>
<span class="line"><span class="token function">virsh</span> attach-interface kvm_centos7 <span class="token parameter variable">--type</span> bridge <span class="token parameter variable">--model</span> virtio <span class="token parameter variable">--source</span> bro0</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 永久生效配置</span></span>
<span class="line"><span class="token function">virsh</span> attach-interface kvm_centos7 <span class="token parameter variable">--type</span> bridge <span class="token parameter variable">--model</span> virtio <span class="token parameter variable">--source</span> bro0 <span class="token parameter variable">--config</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>虚拟机内部配置：</strong></p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 查看新网卡</span></span>
<span class="line"><span class="token function">ip</span> <span class="token function">link</span> show</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 创建网卡配置文件</span></span>
<span class="line"><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-eth1 <span class="token operator">&lt;&lt;</span> <span class="token string">EOF</span>
<span class="line">TYPE=&quot;Ethernet&quot;</span>
<span class="line">NAME=&quot;eth1&quot;</span>
<span class="line">DEVICE=&quot;eth1&quot;</span>
<span class="line">ONBOOT=&quot;yes&quot;</span>
<span class="line">BOOTPROTO=&quot;static&quot;</span>
<span class="line">IPADDR=&quot;10.0.0.141&quot;</span>
<span class="line">NETMASK=&quot;255.255.255.0&quot;</span>
<span class="line">GATEWAY=&quot;10.0.0.254&quot;</span>
<span class="line">DNS1=&quot;223.5.5.5&quot;</span>
<span class="line">EOF</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 激活网卡</span></span>
<span class="line"><span class="token function">ifup</span> eth1</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-3-热添加cpu" tabindex="-1"><a class="header-anchor" href="#_7-3-热添加cpu"><span>7.3 热添加CPU</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 前提：创建时指定最大CPU数</span></span>
<span class="line"><span class="token parameter variable">--vcpus</span> <span class="token number">2</span>,maxvcpus<span class="token operator">=</span><span class="token number">8</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 热添加CPU</span></span>
<span class="line"><span class="token function">virsh</span> setvcpus kvm_centos7 <span class="token parameter variable">--count</span> <span class="token number">4</span> <span class="token parameter variable">--live</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 永久生效</span></span>
<span class="line"><span class="token function">virsh</span> setvcpus kvm_centos7 <span class="token parameter variable">--count</span> <span class="token number">4</span> <span class="token parameter variable">--config</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 限制：不能超过maxvcpus，不能减少只能增加</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-4-热添加内存" tabindex="-1"><a class="header-anchor" href="#_7-4-热添加内存"><span>7.4 热添加内存</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 前提：创建时指定最大内存</span></span>
<span class="line"><span class="token parameter variable">--memory</span> <span class="token number">2048</span>,maxmemory<span class="token operator">=</span><span class="token number">8192</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 热添加内存</span></span>
<span class="line"><span class="token function">virsh</span> setmem kvm_centos7 4G <span class="token parameter variable">--live</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 永久生效</span></span>
<span class="line"><span class="token function">virsh</span> setmem kvm_centos7 4G <span class="token parameter variable">--config</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 查看内存状态</span></span>
<span class="line"><span class="token function">virsh</span> dommemstat kvm_centos7</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_7-5-cpu拓扑调整" tabindex="-1"><a class="header-anchor" href="#_7-5-cpu拓扑调整"><span>7.5 CPU拓扑调整</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># 查看CPU绑定状态</span></span>
<span class="line"><span class="token function">virsh</span> vcpupin kvm_centos7</span>
<span class="line"></span>
<span class="line"><span class="token comment"># 设置CPU绑定</span></span>
<span class="line"><span class="token function">virsh</span> vcpupin kvm_centos7 <span class="token number">0</span> <span class="token number">2</span>  <span class="token comment"># vCPU0绑定到物理CPU2</span></span>
<span class="line"><span class="token function">virsh</span> vcpupin kvm_centos7 <span class="token number">1</span> <span class="token number">3</span>  <span class="token comment"># vCPU1绑定到物理CPU3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="八、最佳实践与注意事项" tabindex="-1"><a class="header-anchor" href="#八、最佳实践与注意事项"><span>八、最佳实践与注意事项</span></a></h2><h3 id="_8-1-性能优化建议" tabindex="-1"><a class="header-anchor" href="#_8-1-性能优化建议"><span>8.1 性能优化建议</span></a></h3><table><thead><tr><th style="text-align:left;">优化项</th><th style="text-align:left;">建议</th></tr></thead><tbody><tr><td style="text-align:left;">磁盘格式选择</td><td style="text-align:left;">raw格式性能最佳，qcow2格式支持快照和压缩</td></tr><tr><td style="text-align:left;">CPU绑定</td><td style="text-align:left;">将关键虚拟机vCPU绑定到特定物理CPU，减少上下文切换</td></tr><tr><td style="text-align:left;">内存管理</td><td style="text-align:left;">合理设置内存气球，动态调整内存分配</td></tr></tbody></table><h3 id="_8-2-故障处理" tabindex="-1"><a class="header-anchor" href="#_8-2-故障处理"><span>8.2 故障处理</span></a></h3><table><thead><tr><th style="text-align:left;">问题</th><th style="text-align:left;">解决方案</th></tr></thead><tbody><tr><td style="text-align:left;">VNC无法连接</td><td style="text-align:left;">检查防火墙规则，验证libvirtd服务状态，查看VNC监听地址配置</td></tr><tr><td style="text-align:left;">虚拟机无法启动</td><td style="text-align:left;">检查磁盘文件权限，验证虚拟机配置XML格式，查看系统日志</td></tr><tr><td style="text-align:left;">网络问题</td><td style="text-align:left;">确保桥接网络配置正确，验证宿主机和虚拟机路由设置</td></tr></tbody></table><h3 id="_8-3-安全建议" tabindex="-1"><a class="header-anchor" href="#_8-3-安全建议"><span>8.3 安全建议</span></a></h3><table><thead><tr><th style="text-align:left;">建议</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">网络隔离</td><td style="text-align:left;">生产环境使用独立虚拟网络</td></tr><tr><td style="text-align:left;">权限控制</td><td style="text-align:left;">限制非管理员用户访问virsh命令</td></tr><tr><td style="text-align:left;">定期备份</td><td style="text-align:left;">备份虚拟机配置和重要磁盘文件</td></tr><tr><td style="text-align:left;">更新维护</td><td style="text-align:left;">定期更新KVM、qemu和libvirt组件</td></tr></tbody></table><hr><p><strong>文档说明：</strong></p><ul><li>本指南涵盖KVM虚拟化从基础到高级的完整操作流程</li><li>所有命令均在CentOS/RHEL 7环境下测试验证</li><li>实际部署时请根据具体环境调整IP地址、路径等参数</li><li>建议在测试环境验证后再应用于生产环境</li></ul>`,90)])])}const r=n(l,[["render",i]]),d=JSON.parse('{"path":"/05-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92/01-kvm%E8%99%9A%E6%8B%9F%E5%8C%96/kvm%E8%99%9A%E6%8B%9F%E5%8C%96.html","title":"KVM虚拟化技术全解","lang":"zh-CN","frontmatter":{},"git":{"contributors":[{"name":"opsjjq","username":"opsjjq","email":"wangyp987@gmail.com","commits":1,"url":"https://github.com/opsjjq"}],"changelog":[{"hash":"ca8e661b7c6729c958583ed3d1a001b6de398273","time":1771558748000,"email":"wangyp987@gmail.com","author":"opsjjq","message":"222"}]},"filePathRelative":"05-容器编排/01-kvm虚拟化/kvm虚拟化.md"}');export{r as comp,d as data};
